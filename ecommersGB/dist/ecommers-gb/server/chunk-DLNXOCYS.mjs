import './polyfills.server.mjs';
import{A as le,B as Zt,C as ot,D as Ur,E as Br,H as Hr,J as he,K as Wr,L as at,M as L,N as qr,O as Gr,P as Jt,Q as as,R as Vr,Y as Kr,Z as Yr,a as f,b as Le,ba as zr,c as Rr,d as xr,da as Qr,f as kr,ga as jr,h as Pr,i as W,j as rs,ja as ls,k as Or,l as Ar,m as Dr,o as os,r as Mr,s as Z,v as Xt,w as P,x as Lr,y as Fr,z as Y}from"./chunk-HL4MMA7W.mjs";import{a as rt,c as b,e as T,f as Sh,h as Nr}from"./chunk-S6KH3LOX.mjs";var ee=T((hs,Xr)=>{"use strict";var en=b("buffer"),J=en.Buffer;function $r(t,e){for(var n in t)e[n]=t[n]}J.from&&J.alloc&&J.allocUnsafe&&J.allocUnsafeSlow?Xr.exports=en:($r(en,hs),hs.Buffer=Ee);function Ee(t,e,n){return J(t,e,n)}Ee.prototype=Object.create(J.prototype);$r(J,Ee);Ee.from=function(t,e,n){if(typeof t=="number")throw new TypeError("Argument must not be a number");return J(t,e,n)};Ee.alloc=function(t,e,n){if(typeof t!="number")throw new TypeError("Argument must be a number");var s=J(t);return e!==void 0?typeof n=="string"?s.fill(e,n):s.fill(e):s.fill(0),s};Ee.allocUnsafe=function(t){if(typeof t!="number")throw new TypeError("Argument must be a number");return J(t)};Ee.allocUnsafeSlow=function(t){if(typeof t!="number")throw new TypeError("Argument must be a number");return en.SlowBuffer(t)}});var eo=T(cs=>{"use strict";var Zr=b("stream").Stream,Jr=b("util"),Ce=function(t){this.readable=this.writable=!0,this._paused=!1,this._driver=t};Jr.inherits(Ce,Zr);Ce.prototype.pause=function(){this._paused=!0,this._driver.messages._paused=!0};Ce.prototype.resume=function(){this._paused=!1,this.emit("drain");var t=this._driver.messages;t._paused=!1,t.emit("drain")};Ce.prototype.write=function(t){return this.writable?(this._driver.parse(t),!this._paused):!1};Ce.prototype.end=function(t){if(this.writable){t!==void 0&&this.write(t),this.writable=!1;var e=this._driver.messages;e.readable&&(e.readable=e.writable=!1,e.emit("end"))}};Ce.prototype.destroy=function(){this.end()};var we=function(t){this.readable=this.writable=!0,this._paused=!1,this._driver=t};Jr.inherits(we,Zr);we.prototype.pause=function(){this._driver.io._paused=!0};we.prototype.resume=function(){this._driver.io._paused=!1,this._driver.io.emit("drain")};we.prototype.write=function(t){return this.writable?(typeof t=="string"?this._driver.text(t):this._driver.binary(t),!this._paused):!1};we.prototype.end=function(t){t!==void 0&&this.write(t)};we.prototype.destroy=function(){};cs.IO=Ce;cs.Messages=we});var tn=T((pf,to)=>{"use strict";var Fe=function(){this.clear()};Fe.prototype.ALLOWED_DUPLICATES=["set-cookie","set-cookie2","warning","www-authenticate"];Fe.prototype.clear=function(){this._sent={},this._lines=[]};Fe.prototype.set=function(t,e){if(e!==void 0){t=this._strip(t),e=this._strip(e);var n=t.toLowerCase();(!this._sent.hasOwnProperty(n)||this.ALLOWED_DUPLICATES.indexOf(n)>=0)&&(this._sent[n]=!0,this._lines.push(t+": "+e+`\r
`))}};Fe.prototype.toString=function(){return this._lines.join("")};Fe.prototype._strip=function(t){return t.toString().replace(/^ */,"").replace(/ *$/,"")};to.exports=Fe});var so=T((gf,no)=>{"use strict";var nn=ee().Buffer,sn=function(){this._queue=[],this._queueSize=0,this._offset=0};sn.prototype.put=function(t){!t||t.length===0||(nn.isBuffer(t)||(t=nn.from(t)),this._queue.push(t),this._queueSize+=t.length)};sn.prototype.read=function(t){if(t>this._queueSize)return null;if(t===0)return nn.alloc(0);this._queueSize-=t;var e=this._queue,n=t,s=e[0],i,r;if(s.length>=t)return s.length===t?e.shift():(r=s.slice(0,t),e[0]=s.slice(t),r);for(var o=0,a=e.length;o<a&&!(n<e[o].length);o++)n-=e[o].length;return i=e.splice(0,o),n>0&&e.length>0&&(i.push(e[0].slice(0,n)),e[0]=e[0].slice(n)),nn.concat(i,t)};sn.prototype.eachByte=function(t,e){for(var n,s,i;this._queue.length>0;){for(n=this._queue[0],s=n.length;this._offset<s;)i=this._offset,this._offset+=1,t.call(e,n[i]);this._offset=0,this._queue.shift()}};no.exports=sn});var ce=T((mf,ho)=>{"use strict";var io=ee().Buffer,ao=b("events").EventEmitter,Th=b("util"),ro=eo(),lo=tn(),Ih=so(),F=function(t,e,n){ao.call(this),F.validateOptions(n||{},["maxLength","masking","requireMasking","protocols"]),this._request=t,this._reader=new Ih,this._options=n||{},this._maxLength=this._options.maxLength||this.MAX_LENGTH,this._headers=new lo,this.__queue=[],this.readyState=0,this.url=e,this.io=new ro.IO(this),this.messages=new ro.Messages(this),this._bindEventListeners()};Th.inherits(F,ao);F.isWebSocket=function(t){var e=t.headers.connection||"",n=t.headers.upgrade||"";return t.method==="GET"&&e.toLowerCase().split(/ *, */).indexOf("upgrade")>=0&&n.toLowerCase()==="websocket"};F.validateOptions=function(t,e){for(var n in t)if(e.indexOf(n)<0)throw new Error("Unrecognized option: "+n)};var oo={MAX_LENGTH:67108863,STATES:["connecting","open","closing","closed"],_bindEventListeners:function(){var t=this;this.messages.on("error",function(){}),this.on("message",function(e){var n=t.messages;n.readable&&n.emit("data",e.data)}),this.on("error",function(e){var n=t.messages;n.readable&&n.emit("error",e)}),this.on("close",function(){var e=t.messages;e.readable&&(e.readable=e.writable=!1,e.emit("end"))})},getState:function(){return this.STATES[this.readyState]||null},addExtension:function(t){return!1},setHeader:function(t,e){return this.readyState>0?!1:(this._headers.set(t,e),!0)},start:function(){if(this.readyState!==0)return!1;if(!F.isWebSocket(this._request))return this._failHandshake(new Error("Not a WebSocket request"));var t;try{t=this._handshakeResponse()}catch(e){return this._failHandshake(e)}return this._write(t),this._stage!==-1&&this._open(),!0},_failHandshake:function(t){var e=new lo;return e.set("Content-Type","text/plain"),e.set("Content-Length",io.byteLength(t.message,"utf8")),e=["HTTP/1.1 400 Bad Request",e.toString(),t.message],this._write(io.from(e.join(`\r
`),"utf8")),this._fail("protocol_error",t.message),!1},text:function(t){return this.frame(t)},binary:function(t){return!1},ping:function(){return!1},pong:function(){return!1},close:function(t,e){return this.readyState!==1?!1:(this.readyState=3,this.emit("close",new F.CloseEvent(null,null)),!0)},_open:function(){this.readyState=1,this.__queue.forEach(function(t){this.frame.apply(this,t)},this),this.__queue=[],this.emit("open",new F.OpenEvent)},_queue:function(t){return this.__queue.push(t),!0},_write:function(t){var e=this.io;e.readable&&e.emit("data",t)},_fail:function(t,e){this.readyState=2,this.emit("error",new Error(e)),this.close()}};for(us in oo)F.prototype[us]=oo[us];var us;F.ConnectEvent=function(){};F.OpenEvent=function(){};F.CloseEvent=function(t,e){this.code=t,this.reason=e};F.MessageEvent=function(t){this.data=t};F.PingEvent=function(t){this.data=t};F.PongEvent=function(t){this.data=t};ho.exports=F});var po=T(_s=>{"use strict";_s.HTTPParser=g;function g(t){if(t!==void 0&&t!==g.REQUEST&&t!==g.RESPONSE)throw new Error("type must be REQUEST or RESPONSE");t===void 0||this.initialize(t),this.maxHeaderSize=g.maxHeaderSize}g.prototype.initialize=function(t,e){if(t!==g.REQUEST&&t!==g.RESPONSE)throw new Error("type must be REQUEST or RESPONSE");this.type=t,this.state=t+"_LINE",this.info={headers:[],upgrade:!1},this.trailers=[],this.line="",this.isChunked=!1,this.connection="",this.headerSize=0,this.body_bytes=null,this.isUserCall=!1,this.hadError=!1};g.encoding="ascii";g.maxHeaderSize=80*1024;g.REQUEST="REQUEST";g.RESPONSE="RESPONSE";var co=g.kOnHeaders=1,ds=g.kOnHeadersComplete=2,rn=g.kOnBody=3,fs=g.kOnMessageComplete=4;g.prototype[co]=g.prototype[ds]=g.prototype[rn]=g.prototype[fs]=function(){};var uo=!0;Object.defineProperty(g,"kOnExecute",{get:function(){return uo=!1,99}});var fo=_s.methods=g.methods=["DELETE","GET","HEAD","POST","PUT","CONNECT","OPTIONS","TRACE","COPY","LOCK","MKCOL","MOVE","PROPFIND","PROPPATCH","SEARCH","UNLOCK","BIND","REBIND","UNBIND","ACL","REPORT","MKACTIVITY","CHECKOUT","MERGE","M-SEARCH","NOTIFY","SUBSCRIBE","UNSUBSCRIBE","PATCH","PURGE","MKCALENDAR","LINK","UNLINK","SOURCE"],_o=fo.indexOf("CONNECT");g.prototype.reinitialize=g;g.prototype.close=g.prototype.pause=g.prototype.resume=g.prototype.remove=g.prototype.free=function(){};g.prototype._compatMode0_11=!1;g.prototype.getAsyncId=function(){return 0};var bh={REQUEST_LINE:!0,RESPONSE_LINE:!0,HEADER:!0};g.prototype.execute=function(t,e,n){if(!(this instanceof g))throw new TypeError("not a HTTPParser");e=e||0,n=typeof n=="number"?n:t.length,this.chunk=t,this.offset=e;var s=this.end=e+n;try{for(;this.offset<s&&!this[this.state](););}catch(i){if(this.isUserCall)throw i;return this.hadError=!0,i}return this.chunk=null,n=this.offset-e,bh[this.state]&&(this.headerSize+=n,this.headerSize>(this.maxHeaderSize||g.maxHeaderSize))?new Error("max header size exceeded"):n};var Nh={REQUEST_LINE:!0,RESPONSE_LINE:!0,BODY_RAW:!0};g.prototype.finish=function(){if(!this.hadError){if(!Nh[this.state])return new Error("invalid state for EOF");this.state==="BODY_RAW"&&this.userCall()(this[fs]())}};g.prototype.consume=g.prototype.unconsume=g.prototype.getCurrentBuffer=function(){};g.prototype.userCall=function(){this.isUserCall=!0;var t=this;return function(e){return t.isUserCall=!1,e}};g.prototype.nextRequest=function(){this.userCall()(this[fs]()),this.reinitialize(this.type)};g.prototype.consumeLine=function(){for(var t=this.end,e=this.chunk,n=this.offset;n<t;n++)if(e[n]===10){var s=this.line+e.toString(g.encoding,this.offset,n);return s.charAt(s.length-1)==="\r"&&(s=s.substr(0,s.length-1)),this.line="",this.offset=n+1,s}this.line+=e.toString(g.encoding,this.offset,this.end),this.offset=this.end};var Rh=/^([^: \t]+):[ \t]*((?:.*[^ \t])|)/,xh=/^[ \t]+(.*[^ \t])/;g.prototype.parseHeader=function(t,e){if(t.indexOf("\r")!==-1)throw on("HPE_LF_EXPECTED");var n=Rh.exec(t),s=n&&n[1];if(s)e.push(s),e.push(n[2]);else{var i=xh.exec(t);i&&e.length&&(e[e.length-1]&&(e[e.length-1]+=" "),e[e.length-1]+=i[1])}};var kh=/^([A-Z-]+) ([^ ]+) HTTP\/(\d)\.(\d)$/;g.prototype.REQUEST_LINE=function(){var t=this.consumeLine();if(t){var e=kh.exec(t);if(e===null)throw on("HPE_INVALID_CONSTANT");if(this.info.method=this._compatMode0_11?e[1]:fo.indexOf(e[1]),this.info.method===-1)throw new Error("invalid request method");this.info.url=e[2],this.info.versionMajor=+e[3],this.info.versionMinor=+e[4],this.body_bytes=0,this.state="HEADER"}};var Ph=/^HTTP\/(\d)\.(\d) (\d{3}) ?(.*)$/;g.prototype.RESPONSE_LINE=function(){var t=this.consumeLine();if(t){var e=Ph.exec(t);if(e===null)throw on("HPE_INVALID_CONSTANT");this.info.versionMajor=+e[1],this.info.versionMinor=+e[2];var n=this.info.statusCode=+e[3];this.info.statusMessage=e[4],((n/100|0)===1||n===204||n===304)&&(this.body_bytes=0),this.state="HEADER"}};g.prototype.shouldKeepAlive=function(){if(this.info.versionMajor>0&&this.info.versionMinor>0){if(this.connection.indexOf("close")!==-1)return!1}else if(this.connection.indexOf("keep-alive")===-1)return!1;return!!(this.body_bytes!==null||this.isChunked)};g.prototype.HEADER=function(){var t=this.consumeLine();if(t!==void 0){var e=this.info;if(t)this.parseHeader(t,e.headers);else{for(var n=e.headers,s=!1,i,r=!1,o=0;o<n.length;o+=2)switch(n[o].toLowerCase()){case"transfer-encoding":this.isChunked=n[o+1].toLowerCase()==="chunked";break;case"content-length":if(i=+n[o+1],s){if(i!==this.body_bytes)throw on("HPE_UNEXPECTED_CONTENT_LENGTH")}else s=!0,this.body_bytes=i;break;case"connection":this.connection+=n[o+1].toLowerCase();break;case"upgrade":r=!0;break}this.isChunked&&s&&(s=!1,this.body_bytes=null),r&&this.connection.indexOf("upgrade")!=-1?e.upgrade=this.type===g.REQUEST||e.statusCode===101:e.upgrade=e.method===_o,this.isChunked&&e.upgrade&&(this.isChunked=!1),e.shouldKeepAlive=this.shouldKeepAlive();var a;if(uo?a=this.userCall()(this[ds](e)):a=this.userCall()(this[ds](e.versionMajor,e.versionMinor,e.headers,e.method,e.url,e.statusCode,e.statusMessage,e.upgrade,e.shouldKeepAlive)),a===2)return this.nextRequest(),!0;if(this.isChunked&&!a)this.state="BODY_CHUNKHEAD";else{if(a||this.body_bytes===0)return this.nextRequest(),e.upgrade;this.body_bytes===null?this.state="BODY_RAW":this.state="BODY_SIZED"}}}};g.prototype.BODY_CHUNKHEAD=function(){var t=this.consumeLine();t!==void 0&&(this.body_bytes=parseInt(t,16),this.body_bytes?this.state="BODY_CHUNK":this.state="BODY_CHUNKTRAILERS")};g.prototype.BODY_CHUNK=function(){var t=Math.min(this.end-this.offset,this.body_bytes);this.userCall()(this[rn](this.chunk.slice(this.offset,this.offset+t),0,t)),this.offset+=t,this.body_bytes-=t,this.body_bytes||(this.state="BODY_CHUNKEMPTYLINE")};g.prototype.BODY_CHUNKEMPTYLINE=function(){var t=this.consumeLine();if(t!==void 0){if(t!=="")throw new Error("Expected empty line");this.state="BODY_CHUNKHEAD"}};g.prototype.BODY_CHUNKTRAILERS=function(){var t=this.consumeLine();t!==void 0&&(t?this.parseHeader(t,this.trailers):(this.trailers.length&&this.userCall()(this[co](this.trailers,"")),this.nextRequest()))};g.prototype.BODY_RAW=function(){this.userCall()(this[rn](this.chunk.slice(this.offset,this.end),0,this.end-this.offset)),this.offset=this.end};g.prototype.BODY_SIZED=function(){var t=Math.min(this.end-this.offset,this.body_bytes);this.userCall()(this[rn](this.chunk.slice(this.offset,this.offset+t),0,t)),this.offset+=t,this.body_bytes-=t,this.body_bytes||this.nextRequest()};["Headers","HeadersComplete","Body","MessageComplete"].forEach(function(t){var e=g["kOn"+t];Object.defineProperty(g.prototype,"on"+t,{get:function(){return this[e]},set:function(n){return this._compatMode0_11=!0,_o="CONNECT",this[e]=n}})});function on(t){var e=new Error("Parse Error");return e.code=t,e}});var ln=T((yf,mo)=>{"use strict";var an=po().HTTPParser,Oh=ee().Buffer,Ah={request:an.REQUEST||"request",response:an.RESPONSE||"response"},U=function(t){this._type=t,this._parser=new an(Ah[t]),this._complete=!1,this.headers={};var e=null,n=this;this._parser.onHeaderField=function(s,i,r){e=s.toString("utf8",i,i+r).toLowerCase()},this._parser.onHeaderValue=function(s,i,r){var o=s.toString("utf8",i,i+r);n.headers.hasOwnProperty(e)?n.headers[e]+=", "+o:n.headers[e]=o},this._parser.onHeadersComplete=this._parser[an.kOnHeadersComplete]=function(s,i,r,o,a,l){var h=arguments[0];if(typeof h=="object"&&(o=h.method,a=h.url,l=h.statusCode,r=h.headers),n.method=typeof o=="number"?U.METHODS[o]:o,n.statusCode=l,n.url=a,!!r){for(var c=0,u=r.length,d,_;c<u;c+=2)d=r[c].toLowerCase(),_=r[c+1],n.headers.hasOwnProperty(d)?n.headers[d]+=", "+_:n.headers[d]=_;n._complete=!0}}};U.METHODS={0:"DELETE",1:"GET",2:"HEAD",3:"POST",4:"PUT",5:"CONNECT",6:"OPTIONS",7:"TRACE",8:"COPY",9:"LOCK",10:"MKCOL",11:"MOVE",12:"PROPFIND",13:"PROPPATCH",14:"SEARCH",15:"UNLOCK",16:"BIND",17:"REBIND",18:"UNBIND",19:"ACL",20:"REPORT",21:"MKACTIVITY",22:"CHECKOUT",23:"MERGE",24:"M-SEARCH",25:"NOTIFY",26:"SUBSCRIBE",27:"UNSUBSCRIBE",28:"PATCH",29:"PURGE",30:"MKCALENDAR",31:"LINK",32:"UNLINK"};var go=process.version?process.version.match(/[0-9]+/g).map(function(t){return parseInt(t,10)}):[];go[0]===0&&go[1]===12&&(U.METHODS[16]="REPORT",U.METHODS[17]="MKACTIVITY",U.METHODS[18]="CHECKOUT",U.METHODS[19]="MERGE",U.METHODS[20]="M-SEARCH",U.METHODS[21]="NOTIFY",U.METHODS[22]="SUBSCRIBE",U.METHODS[23]="UNSUBSCRIBE",U.METHODS[24]="PATCH",U.METHODS[25]="PURGE");U.prototype.isComplete=function(){return this._complete};U.prototype.parse=function(t){var e=this._parser.execute(t,0,t.length);if(typeof e!="number"){this.error=e,this._complete=!0;return}this._complete&&(this.body=e<t.length?t.slice(e):Oh.alloc(0))};mo.exports=U});var Eo=T((Ef,yo)=>{"use strict";var ps=/([!#\$%&'\*\+\-\.\^_`\|~0-9A-Za-z]+)/,Dh=/([^!#\$%&'\*\+\-\.\^_`\|~0-9A-Za-z])/g,Mh=/"((?:\\[\x00-\x7f]|[^\x00-\x08\x0a-\x1f\x7f"\\])*)"/,gs=new RegExp(ps.source+"(?:=(?:"+ps.source+"|"+Mh.source+"))?"),ms=new RegExp(ps.source+"(?: *; *"+gs.source+")*","g"),Lh=new RegExp("^"+ms.source+"(?: *, *"+ms.source+")*$"),Fh=/^-?(0|[1-9][0-9]*)(\.[0-9]+)?$/,vo=Object.prototype.hasOwnProperty,Uh={parseHeader:function(t){var e=new lt;if(t===""||t===void 0)return e;if(!Lh.test(t))throw new SyntaxError("Invalid Sec-WebSocket-Extensions header: "+t);var n=t.match(ms);return n.forEach(function(s){var i=s.match(new RegExp(gs.source,"g")),r=i.shift(),o={};i.forEach(function(a){var l=a.match(gs),h=l[1],c;l[2]!==void 0?c=l[2]:l[3]!==void 0?c=l[3].replace(/\\/g,""):c=!0,Fh.test(c)&&(c=parseFloat(c)),vo.call(o,h)?(o[h]=[].concat(o[h]),o[h].push(c)):o[h]=c},this),e.push(r,o)},this),e},serializeParams:function(t,e){var n=[],s=function(r,o){o instanceof Array?o.forEach(function(a){s(r,a)}):o===!0?n.push(r):typeof o=="number"?n.push(r+"="+o):Dh.test(o)?n.push(r+'="'+o.replace(/"/g,'\\"')+'"'):n.push(r+"="+o)};for(var i in e)s(i,e[i]);return[t].concat(n).join("; ")}},lt=function(){this._byName={},this._inOrder=[]};lt.prototype.push=function(t,e){vo.call(this._byName,t)||(this._byName[t]=[]),this._byName[t].push(e),this._inOrder.push({name:t,params:e})};lt.prototype.eachOffer=function(t,e){for(var n=this._inOrder,s=0,i=n.length;s<i;s++)t.call(e,n[s].name,n[s].params)};lt.prototype.byName=function(t){return this._byName[t]||[]};lt.prototype.toArray=function(){return this._inOrder.slice()};yo.exports=Uh});var vs=T((Cf,Co)=>{"use strict";var ht=function(t){this._bufferSize=t,this.clear()};ht.prototype.clear=function(){this._buffer=new Array(this._bufferSize),this._ringOffset=0,this._ringSize=this._bufferSize,this._head=0,this._tail=0,this.length=0};ht.prototype.push=function(t){var e=!1,n=!1;this._ringSize<this._bufferSize?e=this._tail===0:this._ringOffset===this._ringSize&&(e=!0,n=this._tail===0),e&&(this._tail=this._bufferSize,this._buffer=this._buffer.concat(new Array(this._bufferSize)),this._bufferSize=this._buffer.length,n&&(this._ringSize=this._bufferSize)),this._buffer[this._tail]=t,this.length+=1,this._tail<this._ringSize&&(this._ringOffset+=1),this._tail=(this._tail+1)%this._bufferSize};ht.prototype.peek=function(){if(this.length!==0)return this._buffer[this._head]};ht.prototype.shift=function(){if(this.length!==0){var t=this._buffer[this._head];return this._buffer[this._head]=void 0,this.length-=1,this._ringOffset-=1,this._ringOffset===0&&this.length>0?(this._head=this._ringSize,this._ringOffset=this.length,this._ringSize=this._bufferSize):this._head=(this._head+1)%this._ringSize,t}};Co.exports=ht});var So=T((wf,wo)=>{"use strict";var Bh=vs(),Ue=function(t,e){this._session=t,this._method=e,this._queue=new Bh(Ue.QUEUE_SIZE),this._stopped=!1,this.pending=0};Ue.QUEUE_SIZE=8;Ue.prototype.call=function(t,e,n,s){if(!this._stopped){var i={error:t,message:e,callback:n,context:s,done:!1},r=!1,o=this;if(this._queue.push(i),i.error)return i.done=!0,this._stop(),this._flushQueue();var a=function(l,h){r^(r=!0)&&(l?(o._stop(),i.error=l,i.message=null):i.message=h,i.done=!0,o._flushQueue())};try{this._session[this._method](e,a)}catch(l){a(l)}}};Ue.prototype._stop=function(){this.pending=this._queue.length,this._stopped=!0};Ue.prototype._flushQueue=function(){for(var t=this._queue,e;t.length>0&&t.peek().done;)e=t.shift(),e.error?(this.pending=0,t.clear()):this.pending-=1,e.callback.call(e.context,e.error,e.message)};wo.exports=Ue});var ys=T((Sf,To)=>{"use strict";var Hh=vs(),Se=function(){this._complete=!1,this._callbacks=new Hh(Se.QUEUE_SIZE)};Se.QUEUE_SIZE=4;Se.all=function(t){var e=new Se,n=t.length,s=n;for(n===0&&e.done();s--;)t[s].then(function(){n-=1,n===0&&e.done()});return e};Se.prototype.then=function(t){this._complete?t():this._callbacks.push(t)};Se.prototype.done=function(){this._complete=!0;for(var t=this._callbacks,e;e=t.shift();)e()};To.exports=Se});var No=T((Tf,bo)=>{"use strict";var Io=So(),Wh=ys(),Te=function(t){this._ext=t[0],this._session=t[1],this._functors={incoming:new Io(this._session,"processIncomingMessage"),outgoing:new Io(this._session,"processOutgoingMessage")}};Te.prototype.pending=function(t){var e=this._functors[t];e._stopped||(e.pending+=1)};Te.prototype.incoming=function(t,e,n,s){this._exec("incoming",t,e,n,s)};Te.prototype.outgoing=function(t,e,n,s){this._exec("outgoing",t,e,n,s)};Te.prototype.close=function(){return this._closed=this._closed||new Wh,this._doClose(),this._closed};Te.prototype._exec=function(t,e,n,s,i){this._functors[t].call(e,n,function(r,o){r&&(r.message=this._ext.name+": "+r.message),s.call(i,r,o),this._doClose()},this)};Te.prototype._doClose=function(){var t=this._functors.incoming,e=this._functors.outgoing;!this._closed||t.pending+e.pending!==0||(this._session&&this._session.close(),this._session=null,this._closed.done())};bo.exports=Te});var xo=T((If,Ro)=>{"use strict";var qh=No(),Gh=ys(),ct=function(t){this._cells=t.map(function(e){return new qh(e)}),this._stopped={incoming:!1,outgoing:!1}};ct.prototype.processIncomingMessage=function(t,e,n){this._stopped.incoming||this._loop("incoming",this._cells.length-1,-1,-1,t,e,n)};ct.prototype.processOutgoingMessage=function(t,e,n){this._stopped.outgoing||this._loop("outgoing",0,this._cells.length,1,t,e,n)};ct.prototype.close=function(t,e){this._stopped={incoming:!0,outgoing:!0};var n=this._cells.map(function(s){return s.close()});t&&Gh.all(n).then(function(){t.call(e)})};ct.prototype._loop=function(t,e,n,s,i,r,o){for(var a=this._cells,l=a.length,h=this;l--;)a[l].pending(t);var c=function(u,d,_){if(u===n)return r.call(o,d,_);a[u][t](d,_,function(p,S){p&&(h._stopped[t]=!0),c(u+s,p,S)})};c(e,null,i)};Ro.exports=ct});var Ao=T((bf,Oo)=>{"use strict";var ut=Eo(),ko=xo(),hn=function(){this._rsv1=this._rsv2=this._rsv3=null,this._byName={},this._inOrder=[],this._sessions=[],this._index={}};hn.MESSAGE_OPCODES=[1,2];var Po={add:function(t){if(typeof t.name!="string")throw new TypeError("extension.name must be a string");if(t.type!=="permessage")throw new TypeError('extension.type must be "permessage"');if(typeof t.rsv1!="boolean")throw new TypeError("extension.rsv1 must be true or false");if(typeof t.rsv2!="boolean")throw new TypeError("extension.rsv2 must be true or false");if(typeof t.rsv3!="boolean")throw new TypeError("extension.rsv3 must be true or false");if(this._byName.hasOwnProperty(t.name))throw new TypeError('An extension with name "'+t.name+'" is already registered');this._byName[t.name]=t,this._inOrder.push(t)},generateOffer:function(){var t=[],e=[],n={};return this._inOrder.forEach(function(s){var i=s.createClientSession();if(i){var r=[s,i];t.push(r),n[s.name]=r;var o=i.generateOffer();o=o?[].concat(o):[],o.forEach(function(a){e.push(ut.serializeParams(s.name,a))},this)}},this),this._sessions=t,this._index=n,e.length>0?e.join(", "):null},activate:function(t){var e=ut.parseHeader(t),n=[];e.eachOffer(function(s,i){var r=this._index[s];if(!r)throw new Error('Server sent an extension response for unknown extension "'+s+'"');var o=r[0],a=r[1],l=this._reserved(o);if(l)throw new Error("Server sent two extension responses that use the RSV"+l[0]+' bit: "'+l[1]+'" and "'+o.name+'"');if(a.activate(i)!==!0)throw new Error("Server sent unacceptable extension parameters: "+ut.serializeParams(s,i));this._reserve(o),n.push(r)},this),this._sessions=n,this._pipeline=new ko(n)},generateResponse:function(t){var e=[],n=[],s=ut.parseHeader(t);return this._inOrder.forEach(function(i){var r=s.byName(i.name);if(!(r.length===0||this._reserved(i))){var o=i.createServerSession(r);o&&(this._reserve(i),e.push([i,o]),n.push(ut.serializeParams(i.name,o.generateResponse())))}},this),this._sessions=e,this._pipeline=new ko(e),n.length>0?n.join(", "):null},validFrameRsv:function(t){var e={rsv1:!1,rsv2:!1,rsv3:!1},n;if(hn.MESSAGE_OPCODES.indexOf(t.opcode)>=0)for(var s=0,i=this._sessions.length;s<i;s++)n=this._sessions[s][0],e.rsv1=e.rsv1||n.rsv1,e.rsv2=e.rsv2||n.rsv2,e.rsv3=e.rsv3||n.rsv3;return(e.rsv1||!t.rsv1)&&(e.rsv2||!t.rsv2)&&(e.rsv3||!t.rsv3)},processIncomingMessage:function(t,e,n){this._pipeline.processIncomingMessage(t,e,n)},processOutgoingMessage:function(t,e,n){this._pipeline.processOutgoingMessage(t,e,n)},close:function(t,e){if(!this._pipeline)return t.call(e);this._pipeline.close(t,e)},_reserve:function(t){this._rsv1=this._rsv1||t.rsv1&&t.name,this._rsv2=this._rsv2||t.rsv2&&t.name,this._rsv3=this._rsv3||t.rsv3&&t.name},_reserved:function(t){return this._rsv1&&t.rsv1?[1,this._rsv1]:this._rsv2&&t.rsv2?[2,this._rsv2]:this._rsv3&&t.rsv3?[3,this._rsv3]:!1}};for(Es in Po)hn.prototype[Es]=Po[Es];var Es;Oo.exports=hn});var Fo=T((Nf,Lo)=>{"use strict";var Mo=function(){},Do={final:!1,rsv1:!1,rsv2:!1,rsv3:!1,opcode:null,masked:!1,maskingKey:null,lengthBytes:1,length:0,payload:null};for(Cs in Do)Mo.prototype[Cs]=Do[Cs];var Cs;Lo.exports=Mo});var Wo=T((Rf,Ho)=>{"use strict";var Vh=ee().Buffer,Bo=function(){this.rsv1=!1,this.rsv2=!1,this.rsv3=!1,this.opcode=null,this.length=0,this._chunks=[]},Uo={read:function(){return this.data=this.data||Vh.concat(this._chunks,this.length)},pushFrame:function(t){this.rsv1=this.rsv1||t.rsv1,this.rsv2=this.rsv2||t.rsv2,this.rsv3=this.rsv3||t.rsv3,this.opcode===null&&(this.opcode=t.opcode),this._chunks.push(t.payload),this.length+=t.length}};for(ws in Uo)Bo.prototype[ws]=Uo[ws];var ws;Ho.exports=Bo});var Ts=T((xf,Yo)=>{"use strict";var dt=ee().Buffer,Ko=b("crypto"),Kh=b("util"),Yh=Ao(),Ie=ce(),qo=Fo(),Go=Wo(),q=function(t,e,n){if(Ie.apply(this,arguments),this._extensions=new Yh,this._stage=0,this._masking=this._options.masking,this._protocols=this._options.protocols||[],this._requireMasking=this._options.requireMasking,this._pingCallbacks={},typeof this._protocols=="string"&&(this._protocols=this._protocols.split(/ *, */)),!!this._request){var s=this._request.headers["sec-websocket-protocol"],i=this._protocols;s!==void 0&&(typeof s=="string"&&(s=s.split(/ *, */)),this.protocol=s.filter(function(r){return i.indexOf(r)>=0})[0]),this.version="hybi-"+q.VERSION}};Kh.inherits(q,Ie);q.VERSION="13";q.mask=function(t,e,n){if(!e||e.length===0)return t;n=n||0;for(var s=0,i=t.length-n;s<i;s++)t[n+s]=t[n+s]^e[s%4];return t};q.generateAccept=function(t){var e=Ko.createHash("sha1");return e.update(t+q.GUID),e.digest("base64")};q.GUID="258EAFA5-E914-47DA-95CA-C5AB0DC85B11";var Vo={FIN:128,MASK:128,RSV1:64,RSV2:32,RSV3:16,OPCODE:15,LENGTH:127,OPCODES:{continuation:0,text:1,binary:2,close:8,ping:9,pong:10},OPCODE_CODES:[0,1,2,8,9,10],MESSAGE_OPCODES:[0,1,2],OPENING_OPCODES:[1,2],ERRORS:{normal_closure:1e3,going_away:1001,protocol_error:1002,unacceptable:1003,encoding_error:1007,policy_violation:1008,too_large:1009,extension_error:1010,unexpected_condition:1011},ERROR_CODES:[1e3,1001,1002,1003,1007,1008,1009,1010,1011],DEFAULT_ERROR_CODE:1e3,MIN_RESERVED_ERROR:3e3,MAX_RESERVED_ERROR:4999,UTF8_MATCH:/^([\x00-\x7F]|[\xC2-\xDF][\x80-\xBF]|\xE0[\xA0-\xBF][\x80-\xBF]|[\xE1-\xEC\xEE\xEF][\x80-\xBF]{2}|\xED[\x80-\x9F][\x80-\xBF]|\xF0[\x90-\xBF][\x80-\xBF]{2}|[\xF1-\xF3][\x80-\xBF]{3}|\xF4[\x80-\x8F][\x80-\xBF]{2})*$/,addExtension:function(t){return this._extensions.add(t),!0},parse:function(t){this._reader.put(t);for(var e=!0;e;)switch(this._stage){case 0:e=this._reader.read(1),e&&this._parseOpcode(e[0]);break;case 1:e=this._reader.read(1),e&&this._parseLength(e[0]);break;case 2:e=this._reader.read(this._frame.lengthBytes),e&&this._parseExtendedLength(e);break;case 3:e=this._reader.read(4),e&&(this._stage=4,this._frame.maskingKey=e);break;case 4:e=this._reader.read(this._frame.length),e&&(this._stage=0,this._emitFrame(e));break;default:e=null}},text:function(t){return this.readyState>1?!1:this.frame(t,"text")},binary:function(t){return this.readyState>1?!1:this.frame(t,"binary")},ping:function(t,e){return this.readyState>1?!1:(t=t||"",e&&(this._pingCallbacks[t]=e),this.frame(t,"ping"))},pong:function(t){return this.readyState>1?!1:(t=t||"",this.frame(t,"pong"))},close:function(t,e){return t=t||"",e=e||this.ERRORS.normal_closure,this.readyState<=0?(this.readyState=3,this.emit("close",new Ie.CloseEvent(e,t)),!0):this.readyState===1?(this.readyState=2,this._extensions.close(function(){this.frame(t,"close",e)},this),!0):!1},frame:function(t,e,n){if(this.readyState<=0)return this._queue([t,e,n]);if(this.readyState>2)return!1;t instanceof Array&&(t=dt.from(t)),typeof t=="number"&&(t=t.toString());var s=new Go,i=typeof t=="string",r,o;s.rsv1=s.rsv2=s.rsv3=!1,s.opcode=this.OPCODES[e||(i?"text":"binary")],r=i?dt.from(t,"utf8"):t,n&&(o=r,r=dt.allocUnsafe(2+o.length),r.writeUInt16BE(n,0),o.copy(r,2)),s.data=r;var a=function(l){var h=new qo;h.final=!0,h.rsv1=l.rsv1,h.rsv2=l.rsv2,h.rsv3=l.rsv3,h.opcode=l.opcode,h.masked=!!this._masking,h.length=l.data.length,h.payload=l.data,h.masked&&(h.maskingKey=Ko.randomBytes(4)),this._sendFrame(h)};return this.MESSAGE_OPCODES.indexOf(s.opcode)>=0?this._extensions.processOutgoingMessage(s,function(l,h){if(l)return this._fail("extension_error",l.message);a.call(this,h)},this):a.call(this,s),!0},_sendFrame:function(t){var e=t.length,n=e<=125?2:e<=65535?4:10,s=n+(t.masked?4:0),i=dt.allocUnsafe(s+e),r=t.masked?this.MASK:0;i[0]=(t.final?this.FIN:0)|(t.rsv1?this.RSV1:0)|(t.rsv2?this.RSV2:0)|(t.rsv3?this.RSV3:0)|t.opcode,e<=125?i[1]=r|e:e<=65535?(i[1]=r|126,i.writeUInt16BE(e,2)):(i[1]=r|127,i.writeUInt32BE(Math.floor(e/4294967296),2),i.writeUInt32BE(e%4294967296,6)),t.payload.copy(i,s),t.masked&&(t.maskingKey.copy(i,n),q.mask(i,t.maskingKey,s)),this._write(i)},_handshakeResponse:function(){var t=this._request.headers["sec-websocket-key"],e=this._request.headers["sec-websocket-version"];if(e!==q.VERSION)throw new Error("Unsupported WebSocket version: "+e);if(typeof t!="string")throw new Error("Missing handshake request header: Sec-WebSocket-Key");this._headers.set("Upgrade","websocket"),this._headers.set("Connection","Upgrade"),this._headers.set("Sec-WebSocket-Accept",q.generateAccept(t)),this.protocol&&this._headers.set("Sec-WebSocket-Protocol",this.protocol);var n=this._extensions.generateResponse(this._request.headers["sec-websocket-extensions"]);n&&this._headers.set("Sec-WebSocket-Extensions",n);var s="HTTP/1.1 101 Switching Protocols",i=[s,this._headers.toString(),""];return dt.from(i.join(`\r
`),"utf8")},_shutdown:function(t,e,n){delete this._frame,delete this._message,this._stage=5;var s=this.readyState===1;this.readyState=2,this._extensions.close(function(){s&&this.frame(e,"close",t),this.readyState=3,n&&this.emit("error",new Error(e)),this.emit("close",new Ie.CloseEvent(t,e))},this)},_fail:function(t,e){this.readyState>1||this._shutdown(this.ERRORS[t],e,!0)},_parseOpcode:function(t){var e=[this.RSV1,this.RSV2,this.RSV3].map(function(s){return(t&s)===s}),n=this._frame=new qo;if(n.final=(t&this.FIN)===this.FIN,n.rsv1=e[0],n.rsv2=e[1],n.rsv3=e[2],n.opcode=t&this.OPCODE,this._stage=1,!this._extensions.validFrameRsv(n))return this._fail("protocol_error","One or more reserved bits are on: reserved1 = "+(n.rsv1?1:0)+", reserved2 = "+(n.rsv2?1:0)+", reserved3 = "+(n.rsv3?1:0));if(this.OPCODE_CODES.indexOf(n.opcode)<0)return this._fail("protocol_error","Unrecognized frame opcode: "+n.opcode);if(this.MESSAGE_OPCODES.indexOf(n.opcode)<0&&!n.final)return this._fail("protocol_error","Received fragmented control frame: opcode = "+n.opcode);if(this._message&&this.OPENING_OPCODES.indexOf(n.opcode)>=0)return this._fail("protocol_error","Received new data frame but previous continuous frame is unfinished")},_parseLength:function(t){var e=this._frame;if(e.masked=(t&this.MASK)===this.MASK,e.length=t&this.LENGTH,e.length>=0&&e.length<=125){if(this._stage=e.masked?3:4,!this._checkFrameLength())return}else this._stage=2,e.lengthBytes=e.length===126?2:8;if(this._requireMasking&&!e.masked)return this._fail("unacceptable","Received unmasked frame but masking is required")},_parseExtendedLength:function(t){var e=this._frame;if(e.length=this._readUInt(t),this._stage=e.masked?3:4,this.MESSAGE_OPCODES.indexOf(e.opcode)<0&&e.length>125)return this._fail("protocol_error","Received control frame having too long payload: "+e.length);this._checkFrameLength()},_checkFrameLength:function(){var t=this._message?this._message.length:0;return t+this._frame.length>this._maxLength?(this._fail("too_large","WebSocket frame length too large"),!1):!0},_emitFrame:function(t){var e=this._frame,n=e.payload=q.mask(t,e.maskingKey),s=e.opcode,i,r,o,a,l;if(delete this._frame,s===this.OPCODES.continuation){if(!this._message)return this._fail("protocol_error","Received unexpected continuation frame");this._message.pushFrame(e)}if((s===this.OPCODES.text||s===this.OPCODES.binary)&&(this._message=new Go,this._message.pushFrame(e)),e.final&&this.MESSAGE_OPCODES.indexOf(s)>=0)return this._emitMessage(this._message);s===this.OPCODES.close&&(r=n.length>=2?n.readUInt16BE(0):null,o=n.length>2?this._encode(n.slice(2)):null,n.length!==0&&!(r!==null&&r>=this.MIN_RESERVED_ERROR&&r<=this.MAX_RESERVED_ERROR)&&this.ERROR_CODES.indexOf(r)<0&&(r=this.ERRORS.protocol_error),(n.length>125||n.length>2&&!o)&&(r=this.ERRORS.protocol_error),this._shutdown(r||this.DEFAULT_ERROR_CODE,o||"")),s===this.OPCODES.ping&&(this.frame(n,"pong"),this.emit("ping",new Ie.PingEvent(n.toString()))),s===this.OPCODES.pong&&(a=this._pingCallbacks,i=this._encode(n),l=a[i],delete a[i],l&&l(),this.emit("pong",new Ie.PongEvent(n.toString())))},_emitMessage:function(e){var e=this._message;e.read(),delete this._message,this._extensions.processIncomingMessage(e,function(n,s){if(n)return this._fail("extension_error",n.message);var i=s.data;if(s.opcode===this.OPCODES.text&&(i=this._encode(i)),i===null)return this._fail("encoding_error","Could not decode a text frame as UTF-8");this.emit("message",new Ie.MessageEvent(i))},this)},_encode:function(t){try{var e=t.toString("binary",0,t.length);if(!this.UTF8_MATCH.test(e))return null}catch{}return t.toString("utf8",0,t.length)},_readUInt:function(t){return t.length===2?t.readUInt16BE(0):t.readUInt32BE(0)*4294967296+t.readUInt32BE(4)}};for(Ss in Vo)q.prototype[Ss]=Vo[Ss];var Ss;Yo.exports=q});var Xo=T((kf,$o)=>{"use strict";var jo=ee().Buffer,zh=b("stream").Stream,zo=b("url"),Qh=b("util"),jh=ce(),$h=tn(),Xh=ln(),Zh={"ws:":80,"wss:":443},bs=function(t,e,n){this._client=t,this._http=new Xh("response"),this._origin=typeof t.url=="object"?t.url:zo.parse(t.url),this._url=typeof e=="object"?e:zo.parse(e),this._options=n||{},this._state=0,this.readable=this.writable=!0,this._paused=!1,this._headers=new $h,this._headers.set("Host",this._origin.host),this._headers.set("Connection","keep-alive"),this._headers.set("Proxy-Connection","keep-alive");var s=this._url.auth&&jo.from(this._url.auth,"utf8").toString("base64");s&&this._headers.set("Proxy-Authorization","Basic "+s)};Qh.inherits(bs,zh);var Qo={setHeader:function(t,e){return this._state!==0?!1:(this._headers.set(t,e),!0)},start:function(){if(this._state!==0)return!1;this._state=1;var t=this._origin,e=t.port||Zh[t.protocol],n="CONNECT "+t.hostname+":"+e+" HTTP/1.1",s=[n,this._headers.toString(),""];return this.emit("data",jo.from(s.join(`\r
`),"utf8")),!0},pause:function(){this._paused=!0},resume:function(){this._paused=!1,this.emit("drain")},write:function(t){if(!this.writable)return!1;if(this._http.parse(t),!this._http.isComplete())return!this._paused;if(this.statusCode=this._http.statusCode,this.headers=this._http.headers,this.statusCode===200)this.emit("connect",new jh.ConnectEvent);else{var e="Can't establish a connection to the server at "+this._origin.href;this.emit("error",new Error(e))}return this.end(),!this._paused},end:function(t){this.writable&&(t!==void 0&&this.write(t),this.readable=this.writable=!1,this.emit("close"),this.emit("end"))},destroy:function(){this.end()}};for(Is in Qo)bs.prototype[Is]=Qo[Is];var Is;$o.exports=bs});var ta=T((Pf,ea)=>{"use strict";var Jo=ee().Buffer,Jh=b("crypto"),ec=b("url"),tc=b("util"),nc=ln(),sc=ce(),Be=Ts(),ic=Xo(),ft=function(t,e){this.version="hybi-"+Be.VERSION,Be.call(this,null,t,e),this.readyState=-1,this._key=ft.generateKey(),this._accept=Be.generateAccept(this._key),this._http=new nc("response");var n=ec.parse(this.url),s=n.auth&&Jo.from(n.auth,"utf8").toString("base64");if(this.VALID_PROTOCOLS.indexOf(n.protocol)<0)throw new Error(this.url+" is not a valid WebSocket URL");this._pathname=(n.pathname||"/")+(n.search||""),this._headers.set("Host",n.host),this._headers.set("Upgrade","websocket"),this._headers.set("Connection","Upgrade"),this._headers.set("Sec-WebSocket-Key",this._key),this._headers.set("Sec-WebSocket-Version",Be.VERSION),this._protocols.length>0&&this._headers.set("Sec-WebSocket-Protocol",this._protocols.join(", ")),s&&this._headers.set("Authorization","Basic "+s)};tc.inherits(ft,Be);ft.generateKey=function(){return Jh.randomBytes(16).toString("base64")};var Zo={VALID_PROTOCOLS:["ws:","wss:"],proxy:function(t,e){return new ic(this,t,e)},start:function(){return this.readyState!==-1?!1:(this._write(this._handshakeRequest()),this.readyState=0,!0)},parse:function(t){if(this.readyState!==3){if(this.readyState>0)return Be.prototype.parse.call(this,t);this._http.parse(t),this._http.isComplete()&&(this._validateHandshake(),this.readyState!==3&&(this._open(),this.parse(this._http.body)))}},_handshakeRequest:function(){var t=this._extensions.generateOffer();t&&this._headers.set("Sec-WebSocket-Extensions",t);var e="GET "+this._pathname+" HTTP/1.1",n=[e,this._headers.toString(),""];return Jo.from(n.join(`\r
`),"utf8")},_failHandshake:function(t){t="Error during WebSocket handshake: "+t,this.readyState=3,this.emit("error",new Error(t)),this.emit("close",new sc.CloseEvent(this.ERRORS.protocol_error,t))},_validateHandshake:function(){if(this.statusCode=this._http.statusCode,this.headers=this._http.headers,this._http.error)return this._failHandshake(this._http.error.message);if(this._http.statusCode!==101)return this._failHandshake("Unexpected response code: "+this._http.statusCode);var t=this._http.headers,e=t.upgrade||"",n=t.connection||"",s=t["sec-websocket-accept"]||"",i=t["sec-websocket-protocol"]||"";if(e==="")return this._failHandshake("'Upgrade' header is missing");if(e.toLowerCase()!=="websocket")return this._failHandshake("'Upgrade' header value is not 'WebSocket'");if(n==="")return this._failHandshake("'Connection' header is missing");if(n.toLowerCase()!=="upgrade")return this._failHandshake("'Connection' header value is not 'Upgrade'");if(s!==this._accept)return this._failHandshake("Sec-WebSocket-Accept mismatch");if(this.protocol=null,i!==""){if(this._protocols.indexOf(i)<0)return this._failHandshake("Sec-WebSocket-Protocol mismatch");this.protocol=i}try{this._extensions.activate(this.headers["sec-websocket-extensions"])}catch(r){return this._failHandshake(r.message)}}};for(Ns in Zo)ft.prototype[Ns]=Zo[Ns];var Ns;ea.exports=ft});var ks=T((Of,sa)=>{"use strict";var cn=ee().Buffer,un=ce(),rc=b("util"),xs=function(t,e,n){un.apply(this,arguments),this._stage=0,this.version="hixie-75",this._headers.set("Upgrade","WebSocket"),this._headers.set("Connection","Upgrade"),this._headers.set("WebSocket-Origin",this._request.headers.origin),this._headers.set("WebSocket-Location",this.url)};rc.inherits(xs,un);var na={close:function(){return this.readyState===3?!1:(this.readyState=3,this.emit("close",new un.CloseEvent(null,null)),!0)},parse:function(t){this.readyState>1||(this._reader.put(t),this._reader.eachByte(function(e){var n;switch(this._stage){case-1:this._body.push(e),this._sendHandshakeBody();break;case 0:this._parseLeadingByte(e);break;case 1:if(this._length=(e&127)+128*this._length,this._closing&&this._length===0)return this.close();(e&128)!==128&&(this._length===0?this._stage=0:(this._skipped=0,this._stage=2));break;case 2:if(e===255)this._stage=0,n=cn.from(this._buffer).toString("utf8",0,this._buffer.length),this.emit("message",new un.MessageEvent(n));else if(this._length)this._skipped+=1,this._skipped===this._length&&(this._stage=0);else if(this._buffer.push(e),this._buffer.length>this._maxLength)return this.close();break}},this))},frame:function(t){if(this.readyState===0)return this._queue([t]);if(this.readyState>1)return!1;typeof t!="string"&&(t=t.toString());var e=cn.byteLength(t),n=cn.allocUnsafe(e+2);return n[0]=0,n.write(t,1),n[n.length-1]=255,this._write(n),!0},_handshakeResponse:function(){var t="HTTP/1.1 101 Web Socket Protocol Handshake",e=[t,this._headers.toString(),""];return cn.from(e.join(`\r
`),"utf8")},_parseLeadingByte:function(t){(t&128)===128?(this._length=0,this._stage=1):(delete this._length,delete this._skipped,this._buffer=[],this._stage=2)}};for(Rs in na)xs.prototype[Rs]=na[Rs];var Rs;sa.exports=xs});var la=T((Af,aa)=>{"use strict";var _t=ee().Buffer,oc=ce(),dn=ks(),ac=b("crypto"),lc=b("util"),ia=function(t){return parseInt((t.match(/[0-9]/g)||[]).join(""),10)},ra=function(t){return(t.match(/ /g)||[]).length},Os=function(t,e,n){dn.apply(this,arguments),this._stage=-1,this._body=[],this.version="hixie-76",this._headers.clear(),this._headers.set("Upgrade","WebSocket"),this._headers.set("Connection","Upgrade"),this._headers.set("Sec-WebSocket-Origin",this._request.headers.origin),this._headers.set("Sec-WebSocket-Location",this.url)};lc.inherits(Os,dn);var oa={BODY_SIZE:8,start:function(){return dn.prototype.start.call(this)?(this._started=!0,this._sendHandshakeBody(),!0):!1},close:function(){return this.readyState===3?!1:(this.readyState===1&&this._write(_t.from([255,0])),this.readyState=3,this.emit("close",new oc.CloseEvent(null,null)),!0)},_handshakeResponse:function(){var a=this._request.headers,t=a["sec-websocket-key1"],e=a["sec-websocket-key2"];if(!t)throw new Error("Missing required header: Sec-WebSocket-Key1");if(!e)throw new Error("Missing required header: Sec-WebSocket-Key2");var n=ia(t),s=ra(t),i=ia(e),r=ra(e);if(n%s!==0||i%r!==0)throw new Error("Client sent invalid Sec-WebSocket-Key headers");this._keyValues=[n/s,i/r];var o="HTTP/1.1 101 WebSocket Protocol Handshake",a=[o,this._headers.toString(),""];return _t.from(a.join(`\r
`),"binary")},_handshakeSignature:function(){if(this._body.length<this.BODY_SIZE)return null;var t=ac.createHash("md5"),e=_t.allocUnsafe(8+this.BODY_SIZE);return e.writeUInt32BE(this._keyValues[0],0),e.writeUInt32BE(this._keyValues[1],4),_t.from(this._body).copy(e,8,0,this.BODY_SIZE),t.update(e),_t.from(t.digest("binary"),"binary")},_sendHandshakeBody:function(){if(this._started){var t=this._handshakeSignature();t&&(this._write(t),this._stage=0,this._open(),this._body.length>this.BODY_SIZE&&this.parse(this._body.slice(this.BODY_SIZE)))}},_parseLeadingByte:function(t){if(t!==255)return dn.prototype._parseLeadingByte.call(this,t);this._closing=!0,this._length=0,this._stage=1}};for(Ps in oa)Os.prototype[Ps]=oa[Ps];var Ps;aa.exports=Os});var ca=T((Df,ha)=>{"use strict";var hc=b("util"),cc=ln(),Ms=ce(),uc=ks(),dc=la(),fc=Ts(),be=function(t){Ms.call(this,null,null,t),this._http=new cc("request")};hc.inherits(be,Ms);var Ds={EVENTS:["open","message","error","close","ping","pong"],_bindEventListeners:function(){this.messages.on("error",function(){}),this.on("error",function(){})},parse:function(t){if(this._delegate)return this._delegate.parse(t);if(this._http.parse(t),!!this._http.isComplete()){this.method=this._http.method,this.url=this._http.url,this.headers=this._http.headers,this.body=this._http.body;var e=this;this._delegate=be.http(this,this._options),this._delegate.messages=this.messages,this._delegate.io=this.io,this._open(),this.EVENTS.forEach(function(n){this._delegate.on(n,function(s){e.emit(n,s)})},this),this.protocol=this._delegate.protocol,this.version=this._delegate.version,this.parse(this._http.body),this.emit("connect",new Ms.ConnectEvent)}},_open:function(){this.__queue.forEach(function(t){this._delegate[t[0]].apply(this._delegate,t[1])},this),this.__queue=[]}};["addExtension","setHeader","start","frame","text","binary","ping","close"].forEach(function(t){Ds[t]=function(){return this._delegate?this._delegate[t].apply(this._delegate,arguments):(this.__queue.push([t,arguments]),!0)}});for(As in Ds)be.prototype[As]=Ds[As];var As;be.isSecureRequest=function(t){if(t.connection&&t.connection.authorized!==void 0||t.socket&&t.socket.secure)return!0;var e=t.headers;return e?e.https==="on"||e["x-forwarded-ssl"]==="on"||e["x-forwarded-scheme"]==="https"||e["x-forwarded-proto"]==="https":!1};be.determineUrl=function(t){var e=this.isSecureRequest(t)?"wss:":"ws:";return e+"//"+t.headers.host+t.url};be.http=function(t,e){e=e||{},e.requireMasking===void 0&&(e.requireMasking=!0);var n=t.headers,s=n["sec-websocket-version"],i=n["sec-websocket-key"],r=n["sec-websocket-key1"],o=n["sec-websocket-key2"],a=this.determineUrl(t);return s||i?new fc(t,a,e):r||o?new dc(t,a,e):new uc(t,a,e)};ha.exports=be});var pt=T((Mf,da)=>{"use strict";var ua=ce(),_c=ta(),fn=ca(),pc={client:function(t,e){return e=e||{},e.masking===void 0&&(e.masking=!0),new _c(t,e)},server:function(t){return t=t||{},t.requireMasking===void 0&&(t.requireMasking=!0),new fn(t)},http:function(){return fn.http.apply(fn,arguments)},isSecureRequest:function(t){return fn.isSecureRequest(t)},isWebSocket:function(t){return ua.isWebSocket(t)},validateOptions:function(t,e){ua.validateOptions(t,e)}};da.exports=pc});var gt=T((Lf,fa)=>{"use strict";var Ne=function(t,e){this.type=t;for(var n in e)this[n]=e[n]};Ne.prototype.initEvent=function(t,e,n){this.type=t,this.bubbles=e,this.cancelable=n};Ne.prototype.stopPropagation=function(){};Ne.prototype.preventDefault=function(){};Ne.CAPTURING_PHASE=1;Ne.AT_TARGET=2;Ne.BUBBLING_PHASE=3;fa.exports=Ne});var Ls=T((Ff,_a)=>{"use strict";var gc=gt(),mc={onopen:null,onmessage:null,onerror:null,onclose:null,addEventListener:function(t,e,n){this.on(t,e)},removeEventListener:function(t,e,n){this.removeListener(t,e)},dispatchEvent:function(t){t.target=t.currentTarget=this,t.eventPhase=gc.AT_TARGET,this["on"+t.type]&&this["on"+t.type](t),this.emit(t.type,t)}};_a.exports=mc});var pn=T((Uf,ma)=>{"use strict";var vc=b("stream").Stream,yc=b("util"),Ec=pt(),pa=Ls(),_n=gt(),R=function(t){t=t||{},Ec.validateOptions(t,["headers","extensions","maxLength","ping","proxy","tls","ca"]),this.readable=this.writable=!0;var e=t.headers;if(e)for(var n in e)this._driver.setHeader(n,e[n]);var s=t.extensions;s&&[].concat(s).forEach(this._driver.addExtension,this._driver),this._ping=t.ping,this._pingId=0,this.readyState=R.CONNECTING,this.bufferedAmount=0,this.protocol="",this.url=this._driver.url,this.version=this._driver.version;var i=this;this._driver.on("open",function(r){i._open()}),this._driver.on("message",function(r){i._receiveMessage(r.data)}),this._driver.on("close",function(r){i._beginClose(r.reason,r.code)}),this._driver.on("error",function(r){i._emitError(r.message)}),this.on("error",function(){}),this._driver.messages.on("drain",function(){i.emit("drain")}),this._ping&&(this._pingTimer=setInterval(function(){i._pingId+=1,i.ping(i._pingId.toString())},this._ping*1e3)),this._configureStream(),this._proxy||(this._stream.pipe(this._driver.io),this._driver.io.pipe(this._stream))};yc.inherits(R,vc);R.CONNECTING=0;R.OPEN=1;R.CLOSING=2;R.CLOSED=3;R.CLOSE_TIMEOUT=3e4;var ga={write:function(t){return this.send(t)},end:function(t){t!==void 0&&this.send(t),this.close()},pause:function(){return this._driver.messages.pause()},resume:function(){return this._driver.messages.resume()},send:function(t){return this.readyState>R.OPEN?!1:(t instanceof Buffer||(t=String(t)),this._driver.messages.write(t))},ping:function(t,e){return this.readyState>R.OPEN?!1:this._driver.ping(t,e)},close:function(t,e){if(t===void 0&&(t=1e3),e===void 0&&(e=""),t!==1e3&&(t<3e3||t>4999))throw new Error("Failed to execute 'close' on WebSocket: The code must be either 1000, or between 3000 and 4999. "+t+" is neither.");if(this.readyState<R.CLOSING){var n=this;this._closeTimer=setTimeout(function(){n._beginClose("",1006)},R.CLOSE_TIMEOUT)}this.readyState!==R.CLOSED&&(this.readyState=R.CLOSING),this._driver.close(e,t)},_configureStream:function(){var t=this;this._stream.setTimeout(0),this._stream.setNoDelay(!0),["close","end"].forEach(function(e){this._stream.on(e,function(){t._finalizeClose()})},this),this._stream.on("error",function(e){t._emitError("Network error: "+t.url+": "+e.message),t._finalizeClose()})},_open:function(){if(this.readyState===R.CONNECTING){this.readyState=R.OPEN,this.protocol=this._driver.protocol||"";var t=new _n("open");t.initEvent("open",!1,!1),this.dispatchEvent(t)}},_receiveMessage:function(t){if(this.readyState>R.OPEN)return!1;this.readable&&this.emit("data",t);var e=new _n("message",{data:t});e.initEvent("message",!1,!1),this.dispatchEvent(e)},_emitError:function(t){if(!(this.readyState>=R.CLOSING)){var e=new _n("error",{message:t});e.initEvent("error",!1,!1),this.dispatchEvent(e)}},_beginClose:function(t,e){this.readyState!==R.CLOSED&&(this.readyState=R.CLOSING,this._closeParams=[t,e],this._stream&&(this._stream.destroy(),this._stream.readable||this._finalizeClose()))},_finalizeClose:function(){if(this.readyState!==R.CLOSED){this.readyState=R.CLOSED,this._closeTimer&&clearTimeout(this._closeTimer),this._pingTimer&&clearInterval(this._pingTimer),this._stream&&this._stream.end(),this.readable&&this.emit("end"),this.readable=this.writable=!1;var t=this._closeParams?this._closeParams[0]:"",e=this._closeParams?this._closeParams[1]:1006,n=new _n("close",{code:e,reason:t});n.initEvent("close",!1,!1),this.dispatchEvent(n)}}};for(Fs in ga)R.prototype[Fs]=ga[Fs];var Fs;for(Us in pa)R.prototype[Us]=pa[Us];var Us;ma.exports=R});var Sa=T((Hf,wa)=>{"use strict";var Cc=b("util"),wc=b("net"),va=b("tls"),ya=b("url"),Sc=pt(),Ea=pn(),Bf=gt(),Tc={"http:":80,"https:":443,"ws:":80,"wss:":443},Ca=["https:","wss:"],gn=function(t,e,n){n=n||{},this.url=t,this._driver=Sc.client(this.url,{maxLength:n.maxLength,protocols:e}),["open","error"].forEach(function(d){this._driver.on(d,function(){u.headers=u._driver.headers,u.statusCode=u._driver.statusCode})},this);var s=n.proxy||{},i=ya.parse(s.origin||this.url),r=i.port||Tc[i.protocol],o=Ca.indexOf(i.protocol)>=0,a=function(){u._onConnect()},l=n.net||{},h=n.tls||{},c=s.origin?s.tls||{}:h,u=this;l.host=c.host=i.hostname,l.port=c.port=r,h.ca=h.ca||n.ca,c.servername=c.servername||i.hostname,this._stream=o?va.connect(c,a):wc.connect(l,a),s.origin&&this._configureProxy(s,h),Ea.call(this,n)};Cc.inherits(gn,Ea);gn.prototype._onConnect=function(){var t=this._proxy||this._driver;t.start()};gn.prototype._configureProxy=function(t,e){var n=ya.parse(this.url),s=Ca.indexOf(n.protocol)>=0,i=this,r;if(this._proxy=this._driver.proxy(t.origin),t.headers)for(r in t.headers)this._proxy.setHeader(r,t.headers[r]);this._proxy.pipe(this._stream,{end:!1}),this._stream.pipe(this._proxy),this._proxy.on("connect",function(){if(s){var o={socket:i._stream,servername:n.hostname};for(r in e)o[r]=e[r];i._stream=va.connect(o),i._configureStream()}i._driver.io.pipe(i._stream),i._stream.pipe(i._driver.io),i._driver.start()}),this._proxy.on("error",function(o){i._driver.emit("error",o)})};wa.exports=gn});var Ra=T((Wf,Na)=>{"use strict";var Ic=b("stream").Stream,bc=b("util"),Nc=pt(),Rc=tn(),He=pn(),Ta=Ls(),Ia=gt(),mt=function(t,e,n){this.writable=!0,n=n||{},this._stream=e.socket,this._ping=n.ping||this.DEFAULT_PING,this._retry=n.retry||this.DEFAULT_RETRY;var s=Nc.isSecureRequest(t)?"https:":"http:";this.url=s+"//"+t.headers.host+t.url,this.lastEventId=t.headers["last-event-id"]||"",this.readyState=He.CONNECTING;var i=new Rc,r=this;if(n.headers)for(var o in n.headers)i.set(o,n.headers[o]);if(!(!this._stream||!this._stream.writable)){process.nextTick(function(){r._open()}),this._stream.setTimeout(0),this._stream.setNoDelay(!0);var a=`HTTP/1.1 200 OK\r
Content-Type: text/event-stream\r
Cache-Control: no-cache, no-store\r
Connection: close\r
`+i.toString()+`\r
retry: `+Math.floor(this._retry*1e3)+`\r
\r
`;this._write(a),this._stream.on("drain",function(){r.emit("drain")}),this._ping&&(this._pingTimer=setInterval(function(){r.ping()},this._ping*1e3)),["error","end"].forEach(function(l){r._stream.on(l,function(){r.close()})})}};bc.inherits(mt,Ic);mt.isEventSource=function(t){if(t.method!=="GET")return!1;var e=(t.headers.accept||"").split(/\s*,\s*/);return e.indexOf("text/event-stream")>=0};var ba={DEFAULT_PING:10,DEFAULT_RETRY:5,_write:function(t){if(!this.writable)return!1;try{return this._stream.write(t,"utf8")}catch{return!1}},_open:function(){if(this.readyState===He.CONNECTING){this.readyState=He.OPEN;var t=new Ia("open");t.initEvent("open",!1,!1),this.dispatchEvent(t)}},write:function(t){return this.send(t)},end:function(t){t!==void 0&&this.write(t),this.close()},send:function(t,e){if(this.readyState>He.OPEN)return!1;t=String(t).replace(/(\r\n|\r|\n)/g,"$1data: "),e=e||{};var n="";return e.event&&(n+="event: "+e.event+`\r
`),e.id&&(n+="id: "+e.id+`\r
`),n+="data: "+t+`\r
\r
`,this._write(n)},ping:function(){return this._write(`:\r
\r
`)},close:function(){if(this.readyState>He.OPEN)return!1;this.readyState=He.CLOSED,this.writable=!1,this._pingTimer&&clearInterval(this._pingTimer),this._stream&&this._stream.end();var t=new Ia("close");return t.initEvent("close",!1,!1),this.dispatchEvent(t),!0}};for(Bs in ba)mt.prototype[Bs]=ba[Bs];var Bs;for(Hs in Ta)mt.prototype[Hs]=Ta[Hs];var Hs;Na.exports=mt});var Pa=T((qf,ka)=>{"use strict";var xc=b("util"),Ws=pt(),xa=pn(),ue=function(t,e,n,s,i){i=i||{},this._stream=e,this._driver=Ws.http(t,{maxLength:i.maxLength,protocols:s});var r=this;if(!(!this._stream||!this._stream.writable)){if(!this._stream.readable)return this._stream.end();var o=function(){r._stream.removeListener("data",o)};this._stream.on("data",o),xa.call(this,i),process.nextTick(function(){r._driver.start(),r._driver.io.write(n)})}};xc.inherits(ue,xa);ue.isWebSocket=function(t){return Ws.isWebSocket(t)};ue.validateOptions=function(t,e){Ws.validateOptions(t,e)};ue.WebSocket=ue;ue.Client=Sa();ue.EventSource=Ra();ka.exports=ue});var cl=Sh(Pa(),1);var vn="5",ul="v",dl="s",fl="r",_l="f",pl=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,gl="ls",ml="p",js="ac",vl="websocket",yl="long_polling";var $s=class{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,n){n==null?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),P(n))}get(e){let n=this.domStorage_.getItem(this.prefixedName_(e));return n==null?null:Xt(n)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}};var Xs=class{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,n){n==null?delete this.cache_[e]:this.cache_[e]=n}get(e){return Y(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}};var El=function(t){try{if(typeof window<"u"&&typeof window[t]<"u"){let e=window[t];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new $s(e)}}catch{}return new Xs},xe=El("localStorage"),Zs=El("sessionStorage");var Ve=new Gr("@firebase/database"),Cl=function(){let t=1;return function(){return t++}}(),wl=function(t){let e=Wr(t),n=new Hr;n.update(e);let s=n.digest();return Rr.encodeByteArray(s)},Wt=function(...t){let e="";for(let n=0;n<t.length;n++){let s=t[n];Array.isArray(s)||s&&typeof s=="object"&&typeof s.length=="number"?e+=Wt.apply(null,s):typeof s=="object"?e+=P(s):e+=s,e+=" "}return e},ke=null,Oa=!0,Sl=function(t,e){f(!e||t===!0||t===!1,"Can't turn on custom loggers persistently."),t===!0?(Ve.logLevel=qr.VERBOSE,ke=Ve.log.bind(Ve),e&&Zs.set("logging_enabled",!0)):typeof t=="function"?ke=t:(ke=null,Zs.remove("logging_enabled"))},O=function(...t){if(Oa===!0&&(Oa=!1,ke===null&&Zs.get("logging_enabled")===!0&&Sl(!0)),ke){let e=Wt.apply(null,t);ke(e)}},qt=function(t){return function(...e){O(t,...e)}},Js=function(...t){let e="FIREBASE INTERNAL ERROR: "+Wt(...t);Ve.error(e)},ie=function(...t){let e=`FIREBASE FATAL ERROR: ${Wt(...t)}`;throw Ve.error(e),new Error(e)},M=function(...t){let e="FIREBASE WARNING: "+Wt(...t);Ve.warn(e)},kc=function(){typeof window<"u"&&window.location&&window.location.protocol&&window.location.protocol.indexOf("https:")!==-1&&M("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},qn=function(t){return typeof t=="number"&&(t!==t||t===Number.POSITIVE_INFINITY||t===Number.NEGATIVE_INFINITY)},Pc=function(t){if(Z()||document.readyState==="complete")t();else{let e=!1,n=function(){if(!document.body){setTimeout(n,Math.floor(10));return}e||(e=!0,t())};document.addEventListener?(document.addEventListener("DOMContentLoaded",n,!1),window.addEventListener("load",n,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{document.readyState==="complete"&&n()}),window.attachEvent("onload",n))}},pe="[MIN_NAME]",ae="[MAX_NAME]",Oe=function(t,e){if(t===e)return 0;if(t===pe||e===ae)return-1;if(e===pe||t===ae)return 1;{let n=Aa(t),s=Aa(e);return n!==null?s!==null?n-s===0?t.length-e.length:n-s:-1:s!==null?1:t<e?-1:1}},Oc=function(t,e){return t===e?0:t<e?-1:1},vt=function(t,e){if(e&&t in e)return e[t];throw new Error("Missing required key ("+t+") in object: "+P(e))},tr=function(t){if(typeof t!="object"||t===null)return P(t);let e=[];for(let s in t)e.push(s);e.sort();let n="{";for(let s=0;s<e.length;s++)s!==0&&(n+=","),n+=P(e[s]),n+=":",n+=tr(t[e[s]]);return n+="}",n},Tl=function(t,e){let n=t.length;if(n<=e)return[t];let s=[];for(let i=0;i<n;i+=e)i+e>n?s.push(t.substring(i,n)):s.push(t.substring(i,i+e));return s};function A(t,e){for(let n in t)t.hasOwnProperty(n)&&e(n,t[n])}var Il=function(t){f(!qn(t),"Invalid JSON number");let e=11,n=52,s=(1<<e-1)-1,i,r,o,a,l;t===0?(r=0,o=0,i=1/t===-1/0?1:0):(i=t<0,t=Math.abs(t),t>=Math.pow(2,1-s)?(a=Math.min(Math.floor(Math.log(t)/Math.LN2),s),r=a+s,o=Math.round(t*Math.pow(2,n-a)-Math.pow(2,n))):(r=0,o=Math.round(t/Math.pow(2,1-s-n))));let h=[];for(l=n;l;l-=1)h.push(o%2?1:0),o=Math.floor(o/2);for(l=e;l;l-=1)h.push(r%2?1:0),r=Math.floor(r/2);h.push(i?1:0),h.reverse();let c=h.join(""),u="";for(l=0;l<64;l+=8){let d=parseInt(c.substr(l,8),2).toString(16);d.length===1&&(d="0"+d),u=u+d}return u.toLowerCase()},Ac=function(){return!!(typeof window=="object"&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},Dc=function(){return typeof Windows=="object"&&typeof Windows.UI=="object"};function Mc(t,e){let n="Unknown Error";t==="too_big"?n="The data requested exceeds the maximum size that can be accessed with a single request.":t==="permission_denied"?n="Client doesn't have permission to access the desired data.":t==="unavailable"&&(n="The service is unavailable");let s=new Error(t+" at "+e._path.toString()+": "+n);return s.code=t.toUpperCase(),s}var Lc=new RegExp("^-?(0*)\\d{1,10}$"),Fc=-2147483648,Uc=2147483647,Aa=function(t){if(Lc.test(t)){let e=Number(t);if(e>=Fc&&e<=Uc)return e}return null},tt=function(t){try{t()}catch(e){setTimeout(()=>{let n=e.stack||"";throw M("Exception was thrown by user callback.",n),e},Math.floor(0))}},Bc=function(){return(typeof window=="object"&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},wt=function(t,e){let n=setTimeout(t,e);return typeof n=="number"&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(n):typeof n=="object"&&n.unref&&n.unref(),n};var yn=class{constructor(e,n,s,i,r=!1,o="",a=!1,l=!1,h=null){this.secure=n,this.namespace=s,this.webSocketOnly=i,this.nodeAdmin=r,this.persistenceKey=o,this.includeNamespaceInQueryParams=a,this.isUsingEmulator=l,this.emulatorOptions=h,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=xe.get("host:"+e)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)==="s-"}isCustomHost(){return this._domain!=="firebaseio.com"&&this._domain!=="firebaseio-demo.com"}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&xe.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){let e=this.secure?"https://":"http://",n=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${e}${this.host}/${n}`}};function Hc(t){return t.host!==t.internalHost||t.isCustomHost()||t.includeNamespaceInQueryParams}function bl(t,e,n){f(typeof e=="string","typeof type must == string"),f(typeof n=="object","typeof params must == object");let s;if(e===vl)s=(t.secure?"wss://":"ws://")+t.internalHost+"/.ws?";else if(e===yl)s=(t.secure?"https://":"http://")+t.internalHost+"/.lp?";else throw new Error("Unknown connection type: "+e);Hc(t)&&(n.ns=t.namespace);let i=[];return A(n,(r,o)=>{i.push(r+"="+o)}),s+i.join("&")}var ei=class{constructor(){this.counters_={}}incrementCounter(e,n=1){Y(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=n}get(){return kr(this.counters_)}};var qs={},Gs={};function nr(t){let e=t.toString();return qs[e]||(qs[e]=new ei),qs[e]}function Wc(t,e){let n=t.toString();return Gs[n]||(Gs[n]=e()),Gs[n]}var sr="";function Nl(t){sr=t}var qc=16384,Gc=45e3,Nt=null;typeof MozWebSocket<"u"?Nt=MozWebSocket:typeof WebSocket<"u"&&(Nt=WebSocket);function Vc(t){Nt=t}var qe=(()=>{class t{constructor(n,s,i,r,o,a,l){this.connId=n,this.applicationId=i,this.appCheckToken=r,this.authToken=o,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=qt(this.connId),this.stats_=nr(s),this.connURL=t.connectionURL_(s,a,l,r,i),this.nodeAdmin=s.nodeAdmin}static connectionURL_(n,s,i,r,o){let a={};return a[ul]=vn,!Z()&&typeof location<"u"&&location.hostname&&pl.test(location.hostname)&&(a[fl]=_l),s&&(a[dl]=s),i&&(a[gl]=i),r&&(a[js]=r),o&&(a[ml]=o),bl(n,vl,a)}open(n,s){this.onDisconnect=s,this.onMessage=n,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,xe.set("previous_websocket_failure",!0);try{let i;if(Z()){let r=this.nodeAdmin?"AdminNode":"Node";i={headers:{"User-Agent":`Firebase/${vn}/${sr}/${process.platform}/${r}`,"X-Firebase-GMPID":this.applicationId||""}},this.authToken&&(i.headers.Authorization=`Bearer ${this.authToken}`),this.appCheckToken&&(i.headers["X-Firebase-AppCheck"]=this.appCheckToken);let o=process.env,a=this.connURL.indexOf("wss://")===0?o.HTTPS_PROXY||o.https_proxy:o.HTTP_PROXY||o.http_proxy;a&&(i.proxy={origin:a})}this.mySock=new Nt(this.connURL,[],i)}catch(i){this.log_("Error instantiating WebSocket.");let r=i.message||i.data;r&&this.log_(r),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=i=>{this.handleIncomingFrame(i)},this.mySock.onerror=i=>{this.log_("WebSocket error.  Closing connection.");let r=i.message||i.data;r&&this.log_(r),this.onClosed_()}}start(){}static forceDisallow(){t.forceDisallow_=!0}static isAvailable(){let n=!1;if(typeof navigator<"u"&&navigator.userAgent){let s=/Android ([0-9]{0,}\.[0-9]{0,})/,i=navigator.userAgent.match(s);i&&i.length>1&&parseFloat(i[1])<4.4&&(n=!0)}return!n&&Nt!==null&&!t.forceDisallow_}static previouslyFailed(){return xe.isInMemoryStorage||xe.get("previous_websocket_failure")===!0}markConnectionHealthy(){xe.remove("previous_websocket_failure")}appendFrame_(n){if(this.frames.push(n),this.frames.length===this.totalFrames){let s=this.frames.join("");this.frames=null;let i=Xt(s);this.onMessage(i)}}handleNewFrameCount_(n){this.totalFrames=n,this.frames=[]}extractFrameCount_(n){if(f(this.frames===null,"We already have a frame buffer"),n.length<=6){let s=Number(n);if(!isNaN(s))return this.handleNewFrameCount_(s),null}return this.handleNewFrameCount_(1),n}handleIncomingFrame(n){if(this.mySock===null)return;let s=n.data;if(this.bytesReceived+=s.length,this.stats_.incrementCounter("bytes_received",s.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(s);else{let i=this.extractFrameCount_(s);i!==null&&this.appendFrame_(i)}}send(n){this.resetKeepAlive();let s=P(n);this.bytesSent+=s.length,this.stats_.incrementCounter("bytes_sent",s.length);let i=Tl(s,qc);i.length>1&&this.sendString_(String(i.length));for(let r=0;r<i.length;r++)this.sendString_(i[r])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(Gc))}sendString_(n){try{this.mySock.send(n)}catch(s){this.log_("Exception thrown from WebSocket.send():",s.message||s.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}return t.responsesRequiredToBeHealthy=2,t.healthyTimeout=3e4,t})(),Da="@firebase/database",Ma="1.1.0";var ti=class{constructor(e,n){this.appCheckProvider=n,this.appName=e.name,zr(e)&&e.settings.appCheckToken&&(this.serverAppAppCheckToken=e.settings.appCheckToken),this.appCheck=n?.getImmediate({optional:!0}),this.appCheck||n?.get().then(s=>this.appCheck=s)}getToken(e){if(this.serverAppAppCheckToken){if(e)throw new Error("Attempted reuse of `FirebaseServerApp.appCheckToken` after previous usage failed.");return Promise.resolve({token:this.serverAppAppCheckToken})}return this.appCheck?this.appCheck.getToken(e):new Promise((n,s)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(n,s):n(null)},0)})}addTokenChangeListener(e){this.appCheckProvider?.get().then(n=>n.addTokenListener(e))}notifyForInvalidToken(){M(`Provided AppCheck credentials for the app named "${this.appName}" are invalid. This usually indicates your app was not initialized correctly.`)}};var ni=class{constructor(e,n,s){this.appName_=e,this.firebaseOptions_=n,this.authProvider_=s,this.auth_=null,this.auth_=s.getImmediate({optional:!0}),this.auth_||s.onInit(i=>this.auth_=i)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(n=>n&&n.code==="auth/token-not-initialized"?(O("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(n)):new Promise((n,s)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(n,s):n(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(n=>n.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(n=>n.removeAuthTokenListener(e))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',M(e)}},St=(()=>{class t{constructor(n){this.accessToken=n}getToken(n){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(n){n(this.accessToken)}removeTokenChangeListener(n){}notifyForInvalidToken(){}}t.OWNER="owner";return t})(),si=class{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,n){this.closeAfterResponse=e,this.onClose=n,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,n){for(this.pendingResponses[e]=n;this.pendingResponses[this.currentResponseNum];){let s=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let i=0;i<s.length;++i)s[i]&&tt(()=>{this.onMessage_(s[i])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}};var La="start",Kc="close",Yc="pLPCommand",zc="pRTLPCB",Rl="id",xl="pw",kl="ser",Qc="cb",jc="seg",$c="ts",Xc="d",Zc="dframe",Pl=1870,Ol=30,Jc=Pl-Ol,eu=25e3,tu=3e4,Rt=class t{constructor(e,n,s,i,r,o,a){this.connId=e,this.repoInfo=n,this.applicationId=s,this.appCheckToken=i,this.authToken=r,this.transportSessionId=o,this.lastSessionId=a,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=qt(e),this.stats_=nr(n),this.urlFn=l=>(this.appCheckToken&&(l[js]=this.appCheckToken),bl(n,yl,l))}open(e,n){this.curSegmentNum=0,this.onDisconnect_=n,this.myPacketOrderer=new si(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(tu)),Pc(()=>{if(this.isClosed_)return;this.scriptTagHolder=new ii((...r)=>{let[o,a,l,h,c]=r;if(this.incrementIncomingBytes_(r),!!this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,o===La)this.id=a,this.password=l;else if(o===Kc)a?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(a,()=>{this.onClosed_()})):this.onClosed_();else throw new Error("Unrecognized command received: "+o)},(...r)=>{let[o,a]=r;this.incrementIncomingBytes_(r),this.myPacketOrderer.handleResponse(o,a)},()=>{this.onClosed_()},this.urlFn);let s={};s[La]="t",s[kl]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(s[Qc]=this.scriptTagHolder.uniqueCallbackIdentifier),s[ul]=vn,this.transportSessionId&&(s[dl]=this.transportSessionId),this.lastSessionId&&(s[gl]=this.lastSessionId),this.applicationId&&(s[ml]=this.applicationId),this.appCheckToken&&(s[js]=this.appCheckToken),typeof location<"u"&&location.hostname&&pl.test(location.hostname)&&(s[fl]=_l);let i=this.urlFn(s);this.log_("Connecting via long-poll to "+i),this.scriptTagHolder.addTag(i,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){t.forceAllow_=!0}static forceDisallow(){t.forceDisallow_=!0}static isAvailable(){return Z()?!1:t.forceAllow_?!0:!t.forceDisallow_&&typeof document<"u"&&document.createElement!=null&&!Ac()&&!Dc()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){let n=P(e);this.bytesSent+=n.length,this.stats_.incrementCounter("bytes_sent",n.length);let s=xr(n),i=Tl(s,Jc);for(let r=0;r<i.length;r++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,i.length,i[r]),this.curSegmentNum++}addDisconnectPingFrame(e,n){if(Z())return;this.myDisconnFrame=document.createElement("iframe");let s={};s[Zc]="t",s[Rl]=e,s[xl]=n,this.myDisconnFrame.src=this.urlFn(s),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){let n=P(e).length;this.bytesReceived+=n,this.stats_.incrementCounter("bytes_received",n)}},ii=class t{constructor(e,n,s,i){if(this.onDisconnect=s,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0,Z())this.commandCB=e,this.onMessageCB=n;else{this.uniqueCallbackIdentifier=Cl(),window[Yc+this.uniqueCallbackIdentifier]=e,window[zc+this.uniqueCallbackIdentifier]=n,this.myIFrame=t.createIFrame_();let r="";this.myIFrame.src&&this.myIFrame.src.substr(0,11)==="javascript:"&&(r='<script>document.domain="'+document.domain+'";</script>');let o="<html><body>"+r+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(o),this.myIFrame.doc.close()}catch(a){O("frame writing exception"),a.stack&&O(a.stack),O(a)}}}static createIFrame_(){let e=document.createElement("iframe");if(e.style.display="none",document.body){document.body.appendChild(e);try{e.contentWindow.document||O("No IE domain setting required")}catch{let s=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+s+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));let e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,n){for(this.myID=e,this.myPW=n,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;let e={};e[Rl]=this.myID,e[xl]=this.myPW,e[kl]=this.currentSerial;let n=this.urlFn(e),s="",i=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+Ol+s.length<=Pl;){let o=this.pendingSegs.shift();s=s+"&"+jc+i+"="+o.seg+"&"+$c+i+"="+o.ts+"&"+Xc+i+"="+o.d,i++}return n=n+s,this.addLongPollTag_(n,this.currentSerial),!0}else return!1}enqueueSegment(e,n,s){this.pendingSegs.push({seg:e,ts:n,d:s}),this.alive&&this.newRequest_()}addLongPollTag_(e,n){this.outstandingRequests.add(n);let s=()=>{this.outstandingRequests.delete(n),this.newRequest_()},i=setTimeout(s,Math.floor(eu)),r=()=>{clearTimeout(i),s()};this.addTag(e,r)}addTag(e,n){Z()?this.doNodeLongPoll(e,n):setTimeout(()=>{try{if(!this.sendNewPolls)return;let s=this.myIFrame.doc.createElement("script");s.type="text/javascript",s.async=!0,s.src=e,s.onload=s.onreadystatechange=function(){let i=s.readyState;(!i||i==="loaded"||i==="complete")&&(s.onload=s.onreadystatechange=null,s.parentNode&&s.parentNode.removeChild(s),n())},s.onerror=()=>{O("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(s)}catch{}},Math.floor(1))}};var Al=(()=>{class t{static get ALL_TRANSPORTS(){return[Rt,qe]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}constructor(n){this.initTransports_(n)}initTransports_(n){let s=qe&&qe.isAvailable(),i=s&&!qe.previouslyFailed();if(n.webSocketOnly&&(s||M("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),i=!0),i)this.transports_=[qe];else{let r=this.transports_=[];for(let o of t.ALL_TRANSPORTS)o&&o.isAvailable()&&r.push(o);t.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}t.globalTransportInitialized_=!1;return t})(),nu=6e4,su=5e3,iu=10*1024,ru=100*1024,Vs="t",Fa="d",ou="s",Ua="r",au="e",Ba="o",Ha="a",Wa="n",qa="p",lu="h",ri=class{constructor(e,n,s,i,r,o,a,l,h,c){this.id=e,this.repoInfo_=n,this.applicationId_=s,this.appCheckToken_=i,this.authToken_=r,this.onMessage_=o,this.onReady_=a,this.onDisconnect_=l,this.onKill_=h,this.lastSessionId=c,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=qt("c:"+this.id+":"),this.transportManager_=new Al(n),this.log_("Connection created"),this.start_()}start_(){let e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let n=this.connReceiver_(this.conn_),s=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(n,s)},Math.floor(0));let i=e.healthyTimeout||0;i>0&&(this.healthyTimeout_=wt(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>ru?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>iu?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(i)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return n=>{e===this.conn_?this.onConnectionLost_(n):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return n=>{this.state_!==2&&(e===this.rx_?this.onPrimaryMessageReceived_(n):e===this.secondaryConn_?this.onSecondaryMessageReceived_(n):this.log_("message on old connection"))}}sendRequest(e){let n={t:"d",d:e};this.sendData_(n)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(Vs in e){let n=e[Vs];n===Ha?this.upgradeIfSecondaryHealthy_():n===Ua?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):n===Ba&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){let n=vt("t",e),s=vt("d",e);if(n==="c")this.onSecondaryControl_(s);else if(n==="d")this.pendingDataMessages.push(s);else throw new Error("Unknown protocol layer: "+n)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:qa,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:Ha,d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:Wa,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){let n=vt("t",e),s=vt("d",e);n==="c"?this.onControl_(s):n==="d"&&this.onDataMessage_(s)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){let n=vt(Vs,e);if(Fa in e){let s=e[Fa];if(n===lu){let i=rt({},s);this.repoInfo_.isUsingEmulator&&(i.h=this.repoInfo_.host),this.onHandshake_(i)}else if(n===Wa){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let i=0;i<this.pendingDataMessages.length;++i)this.onDataMessage_(this.pendingDataMessages[i]);this.pendingDataMessages=[],this.tryCleanupConnection()}else n===ou?this.onConnectionShutdown_(s):n===Ua?this.onReset_(s):n===au?Js("Server Error: "+s):n===Ba?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):Js("Unknown control packet command: "+n)}}onHandshake_(e){let n=e.ts,s=e.v,i=e.h;this.sessionId=e.s,this.repoInfo_.host=i,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,n),vn!==s&&M("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){let e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let n=this.connReceiver_(this.secondaryConn_),s=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(n,s),wt(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(nu))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,n){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(n,this.sessionId),this.onReady_=null),this.primaryResponsesRequired_===0?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):wt(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(su))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:qa,d:{}}}))}onSecondaryConnectionLost_(){let e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,!e&&this.state_===0?(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(xe.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_("Realtime connection lost."),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(this.state_!==1)throw"Connection is not connected";this.tx_.send(e)}close(){this.state_!==2&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}};var En=class{put(e,n,s,i){}merge(e,n,s,i){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,n,s){}onDisconnectMerge(e,n,s){}onDisconnectCancel(e,n){}reportStats(e){}};var Cn=class{constructor(e){this.allowedEvents_=e,this.listeners_={},f(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...n){if(Array.isArray(this.listeners_[e])){let s=[...this.listeners_[e]];for(let i=0;i<s.length;i++)s[i].callback.apply(s[i].context,n)}}on(e,n,s){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:n,context:s});let i=this.getInitialEvent(e);i&&n.apply(s,i)}off(e,n,s){this.validateEventType_(e);let i=this.listeners_[e]||[];for(let r=0;r<i.length;r++)if(i[r].callback===n&&(!s||s===i[r].context)){i.splice(r,1);return}}validateEventType_(e){f(this.allowedEvents_.find(n=>n===e),"Unknown event: "+e)}};var wn=class t extends Cn{static getInstance(){return new t}constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!os()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}getInitialEvent(e){return f(e==="online","Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}};var Ga=32,Va=768,w=class{constructor(e,n){if(n===void 0){this.pieces_=e.split("/");let s=0;for(let i=0;i<this.pieces_.length;i++)this.pieces_[i].length>0&&(this.pieces_[s]=this.pieces_[i],s++);this.pieces_.length=s,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=n}toString(){let e="";for(let n=this.pieceNum_;n<this.pieces_.length;n++)this.pieces_[n]!==""&&(e+="/"+this.pieces_[n]);return e||"/"}};function C(){return new w("")}function v(t){return t.pieceNum_>=t.pieces_.length?null:t.pieces_[t.pieceNum_]}function ge(t){return t.pieces_.length-t.pieceNum_}function I(t){let e=t.pieceNum_;return e<t.pieces_.length&&e++,new w(t.pieces_,e)}function ir(t){return t.pieceNum_<t.pieces_.length?t.pieces_[t.pieces_.length-1]:null}function hu(t){let e="";for(let n=t.pieceNum_;n<t.pieces_.length;n++)t.pieces_[n]!==""&&(e+="/"+encodeURIComponent(String(t.pieces_[n])));return e||"/"}function xt(t,e=0){return t.pieces_.slice(t.pieceNum_+e)}function Dl(t){if(t.pieceNum_>=t.pieces_.length)return null;let e=[];for(let n=t.pieceNum_;n<t.pieces_.length-1;n++)e.push(t.pieces_[n]);return new w(e,0)}function x(t,e){let n=[];for(let s=t.pieceNum_;s<t.pieces_.length;s++)n.push(t.pieces_[s]);if(e instanceof w)for(let s=e.pieceNum_;s<e.pieces_.length;s++)n.push(e.pieces_[s]);else{let s=e.split("/");for(let i=0;i<s.length;i++)s[i].length>0&&n.push(s[i])}return new w(n,0)}function y(t){return t.pieceNum_>=t.pieces_.length}function B(t,e){let n=v(t),s=v(e);if(n===null)return e;if(n===s)return B(I(t),I(e));throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+t+")")}function cu(t,e){let n=xt(t,0),s=xt(e,0);for(let i=0;i<n.length&&i<s.length;i++){let r=Oe(n[i],s[i]);if(r!==0)return r}return n.length===s.length?0:n.length<s.length?-1:1}function rr(t,e){if(ge(t)!==ge(e))return!1;for(let n=t.pieceNum_,s=e.pieceNum_;n<=t.pieces_.length;n++,s++)if(t.pieces_[n]!==e.pieces_[s])return!1;return!0}function z(t,e){let n=t.pieceNum_,s=e.pieceNum_;if(ge(t)>ge(e))return!1;for(;n<t.pieces_.length;){if(t.pieces_[n]!==e.pieces_[s])return!1;++n,++s}return!0}var oi=class{constructor(e,n){this.errorPrefix_=n,this.parts_=xt(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let s=0;s<this.parts_.length;s++)this.byteLength_+=at(this.parts_[s]);Ml(this)}};function uu(t,e){t.parts_.length>0&&(t.byteLength_+=1),t.parts_.push(e),t.byteLength_+=at(e),Ml(t)}function du(t){let e=t.parts_.pop();t.byteLength_-=at(e),t.parts_.length>0&&(t.byteLength_-=1)}function Ml(t){if(t.byteLength_>Va)throw new Error(t.errorPrefix_+"has a key path longer than "+Va+" bytes ("+t.byteLength_+").");if(t.parts_.length>Ga)throw new Error(t.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+Ga+") or object contains a cycle "+Re(t))}function Re(t){return t.parts_.length===0?"":"in property '"+t.parts_.join(".")+"'"}var ai=class t extends Cn{static getInstance(){return new t}constructor(){super(["visible"]);let e,n;typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(n="visibilitychange",e="hidden"):typeof document.mozHidden<"u"?(n="mozvisibilitychange",e="mozHidden"):typeof document.msHidden<"u"?(n="msvisibilitychange",e="msHidden"):typeof document.webkitHidden<"u"&&(n="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,n&&document.addEventListener(n,()=>{let s=!document[e];s!==this.visible_&&(this.visible_=s,this.trigger("visible",s))},!1)}getInitialEvent(e){return f(e==="visible","Unknown event type: "+e),[this.visible_]}};var yt=1e3,fu=60*5*1e3,Ka=30*1e3,_u=1.3,pu=3e4,gu="server_kill",Ya=3,Ke=(()=>{class t extends En{constructor(n,s,i,r,o,a,l,h){if(super(),this.repoInfo_=n,this.applicationId_=s,this.onDataUpdate_=i,this.onConnectStatus_=r,this.onServerInfoUpdate_=o,this.authTokenProvider_=a,this.appCheckTokenProvider_=l,this.authOverride_=h,this.id=t.nextPersistentConnectionId_++,this.log_=qt("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=yt,this.maxReconnectDelay_=fu,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,h&&!Z())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");ai.getInstance().on("visible",this.onVisible_,this),n.host.indexOf("fblocal")===-1&&wn.getInstance().on("online",this.onOnline_,this)}sendRequest(n,s,i){let r=++this.requestNumber_,o={r,a:n,b:s};this.log_(P(o)),f(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(o),i&&(this.requestCBHash_[r]=i)}get(n){this.initConnection_();let s=new W,r={action:"g",request:{p:n._path.toString(),q:n._queryObject},onComplete:a=>{let l=a.d;a.s==="ok"?s.resolve(l):s.reject(l)}};this.outstandingGets_.push(r),this.outstandingGetCount_++;let o=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(o),s.promise}listen(n,s,i,r){this.initConnection_();let o=n._queryIdentifier,a=n._path.toString();this.log_("Listen called for "+a+" "+o),this.listens.has(a)||this.listens.set(a,new Map),f(n._queryParams.isDefault()||!n._queryParams.loadsAllData(),"listen() called for non-default but complete query"),f(!this.listens.get(a).has(o),"listen() called twice for same path/queryId.");let l={onComplete:r,hashFn:s,query:n,tag:i};this.listens.get(a).set(o,l),this.connected_&&this.sendListen_(l)}sendGet_(n){let s=this.outstandingGets_[n];this.sendRequest("g",s.request,i=>{delete this.outstandingGets_[n],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),s.onComplete&&s.onComplete(i)})}sendListen_(n){let s=n.query,i=s._path.toString(),r=s._queryIdentifier;this.log_("Listen on "+i+" for "+r);let o={p:i},a="q";n.tag&&(o.q=s._queryObject,o.t=n.tag),o.h=n.hashFn(),this.sendRequest(a,o,l=>{let h=l.d,c=l.s;t.warnOnListenWarnings_(h,s),(this.listens.get(i)&&this.listens.get(i).get(r))===n&&(this.log_("listen response",l),c!=="ok"&&this.removeListen_(i,r),n.onComplete&&n.onComplete(c,h))})}static warnOnListenWarnings_(n,s){if(n&&typeof n=="object"&&Y(n,"w")){let i=le(n,"w");if(Array.isArray(i)&&~i.indexOf("no_index")){let r='".indexOn": "'+s._queryParams.getIndex().toString()+'"',o=s._path.toString();M(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${r} at ${o} to your security rules for better performance.`)}}}refreshAuthToken(n){this.authToken_=n,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(n)}reduceReconnectDelayIfAdminCredential_(n){(n&&n.length===40||Fr(n))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=Ka)}refreshAppCheckToken(n){this.appCheckToken_=n,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){let n=this.authToken_,s=Lr(n)?"auth":"gauth",i={cred:n};this.authOverride_===null?i.noauth=!0:typeof this.authOverride_=="object"&&(i.authvar=this.authOverride_),this.sendRequest(s,i,r=>{let o=r.s,a=r.d||"error";this.authToken_===n&&(o==="ok"?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(o,a))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},n=>{let s=n.s,i=n.d||"error";s==="ok"?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(s,i)})}unlisten(n,s){let i=n._path.toString(),r=n._queryIdentifier;this.log_("Unlisten called for "+i+" "+r),f(n._queryParams.isDefault()||!n._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(i,r)&&this.connected_&&this.sendUnlisten_(i,r,n._queryObject,s)}sendUnlisten_(n,s,i,r){this.log_("Unlisten on "+n+" for "+s);let o={p:n},a="n";r&&(o.q=i,o.t=r),this.sendRequest(a,o)}onDisconnectPut(n,s,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",n,s,i):this.onDisconnectRequestQueue_.push({pathString:n,action:"o",data:s,onComplete:i})}onDisconnectMerge(n,s,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",n,s,i):this.onDisconnectRequestQueue_.push({pathString:n,action:"om",data:s,onComplete:i})}onDisconnectCancel(n,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",n,null,s):this.onDisconnectRequestQueue_.push({pathString:n,action:"oc",data:null,onComplete:s})}sendOnDisconnect_(n,s,i,r){let o={p:s,d:i};this.log_("onDisconnect "+n,o),this.sendRequest(n,o,a=>{r&&setTimeout(()=>{r(a.s,a.d)},Math.floor(0))})}put(n,s,i,r){this.putInternal("p",n,s,i,r)}merge(n,s,i,r){this.putInternal("m",n,s,i,r)}putInternal(n,s,i,r,o){this.initConnection_();let a={p:s,d:i};o!==void 0&&(a.h=o),this.outstandingPuts_.push({action:n,request:a,onComplete:r}),this.outstandingPutCount_++;let l=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(l):this.log_("Buffering put: "+s)}sendPut_(n){let s=this.outstandingPuts_[n].action,i=this.outstandingPuts_[n].request,r=this.outstandingPuts_[n].onComplete;this.outstandingPuts_[n].queued=this.connected_,this.sendRequest(s,i,o=>{this.log_(s+" response",o),delete this.outstandingPuts_[n],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),r&&r(o.s,o.d)})}reportStats(n){if(this.connected_){let s={c:n};this.log_("reportStats",s),this.sendRequest("s",s,i=>{if(i.s!=="ok"){let o=i.d;this.log_("reportStats","Error sending stats: "+o)}})}}onDataMessage_(n){if("r"in n){this.log_("from server: "+P(n));let s=n.r,i=this.requestCBHash_[s];i&&(delete this.requestCBHash_[s],i(n.b))}else{if("error"in n)throw"A server-side error has occurred: "+n.error;"a"in n&&this.onDataPush_(n.a,n.b)}}onDataPush_(n,s){this.log_("handleServerMessage",n,s),n==="d"?this.onDataUpdate_(s.p,s.d,!1,s.t):n==="m"?this.onDataUpdate_(s.p,s.d,!0,s.t):n==="c"?this.onListenRevoked_(s.p,s.q):n==="ac"?this.onAuthRevoked_(s.s,s.d):n==="apc"?this.onAppCheckRevoked_(s.s,s.d):n==="sd"?this.onSecurityDebugPacket_(s):Js("Unrecognized action received from server: "+P(n)+`
Are you using the latest client?`)}onReady_(n,s){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(n),this.lastSessionId=s,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(n){f(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(n))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(n){n&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=yt,this.realtime_||this.scheduleConnect_(0)),this.visible_=n}onOnline_(n){n?(this.log_("Browser went online."),this.reconnectDelay_=yt,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(new Date().getTime()-this.lastConnectionEstablishedTime_>pu&&(this.reconnectDelay_=yt),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());let n=Math.max(0,new Date().getTime()-this.lastConnectionAttemptTime_),s=Math.max(0,this.reconnectDelay_-n);s=Math.random()*s,this.log_("Trying to reconnect in "+s+"ms"),this.scheduleConnect_(s),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*_u)}this.onConnectStatus_(!1)}establishConnection_(){return Nr(this,null,function*(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;let n=this.onDataMessage_.bind(this),s=this.onReady_.bind(this),i=this.onRealtimeDisconnect_.bind(this),r=this.id+":"+t.nextConnectionId_++,o=this.lastSessionId,a=!1,l=null,h=function(){l?l.close():(a=!0,i())},c=function(d){f(l,"sendRequest call when we're not connected not allowed."),l.sendRequest(d)};this.realtime_={close:h,sendRequest:c};let u=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{let[d,_]=yield Promise.all([this.authTokenProvider_.getToken(u),this.appCheckTokenProvider_.getToken(u)]);a?O("getToken() completed but was canceled"):(O("getToken() completed. Creating connection."),this.authToken_=d&&d.accessToken,this.appCheckToken_=_&&_.token,l=new ri(r,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,n,s,i,p=>{M(p+" ("+this.repoInfo_.toString()+")"),this.interrupt(gu)},o))}catch(d){this.log_("Failed to get token: "+d),a||(this.repoInfo_.nodeAdmin&&M(d),h())}}})}interrupt(n){O("Interrupting connection for reason: "+n),this.interruptReasons_[n]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(n){O("Resuming connection for reason: "+n),delete this.interruptReasons_[n],Zt(this.interruptReasons_)&&(this.reconnectDelay_=yt,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(n){let s=n-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:s})}cancelSentTransactions_(){for(let n=0;n<this.outstandingPuts_.length;n++){let s=this.outstandingPuts_[n];s&&"h"in s.request&&s.queued&&(s.onComplete&&s.onComplete("disconnect"),delete this.outstandingPuts_[n],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(n,s){let i;s?i=s.map(o=>tr(o)).join("$"):i="default";let r=this.removeListen_(n,i);r&&r.onComplete&&r.onComplete("permission_denied")}removeListen_(n,s){let i=new w(n).toString(),r;if(this.listens.has(i)){let o=this.listens.get(i);r=o.get(s),o.delete(s),o.size===0&&this.listens.delete(i)}else r=void 0;return r}onAuthRevoked_(n,s){O("Auth token revoked: "+n+"/"+s),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(n==="invalid_token"||n==="permission_denied")&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=Ya&&(this.reconnectDelay_=Ka,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(n,s){O("App check token revoked: "+n+"/"+s),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(n==="invalid_token"||n==="permission_denied")&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=Ya&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(n){this.securityDebugCallback_?this.securityDebugCallback_(n):"msg"in n&&console.log("FIREBASE: "+n.msg.replace(`
`,`
FIREBASE: `))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(let n of this.listens.values())for(let s of n.values())this.sendListen_(s);for(let n=0;n<this.outstandingPuts_.length;n++)this.outstandingPuts_[n]&&this.sendPut_(n);for(;this.onDisconnectRequestQueue_.length;){let n=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(n.action,n.pathString,n.data,n.onComplete)}for(let n=0;n<this.outstandingGets_.length;n++)this.outstandingGets_[n]&&this.sendGet_(n)}sendConnectStats_(){let n={},s="js";Z()&&(this.repoInfo_.nodeAdmin?s="admin_node":s="node"),n["sdk."+s+"."+sr.replace(/\./g,"-")]=1,os()?n["framework.cordova"]=1:Mr()&&(n["framework.reactnative"]=1),this.reportStats(n)}shouldReconnect_(){let n=wn.getInstance().currentlyOnline();return Zt(this.interruptReasons_)&&n}}t.nextPersistentConnectionId_=0,t.nextConnectionId_=0;return t})(),E=class t{constructor(e,n){this.name=e,this.node=n}static Wrap(e,n){return new t(e,n)}};var Ye=class{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,n){let s=new E(pe,e),i=new E(pe,n);return this.compare(s,i)!==0}minPost(){return E.MIN}};var mn,Sn=class extends Ye{static get __EMPTY_NODE(){return mn}static set __EMPTY_NODE(e){mn=e}compare(e,n){return Oe(e.name,n.name)}isDefinedOn(e){throw Le("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,n){return!1}minPost(){return E.MIN}maxPost(){return new E(ae,mn)}makePost(e,n){return f(typeof e=="string","KeyIndex indexValue must always be a string."),new E(e,mn)}toString(){return".key"}},se=new Sn;var Ge=class{constructor(e,n,s,i,r=null){this.isReverse_=i,this.resultGenerator_=r,this.nodeStack_=[];let o=1;for(;!e.isEmpty();)if(e=e,o=n?s(e.key,n):1,i&&(o*=-1),o<0)this.isReverse_?e=e.left:e=e.right;else if(o===0){this.nodeStack_.push(e);break}else this.nodeStack_.push(e),this.isReverse_?e=e.right:e=e.left}getNext(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_.pop(),n;if(this.resultGenerator_?n=this.resultGenerator_(e.key,e.value):n={key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return n}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}},j=(()=>{class t{constructor(n,s,i,r,o){this.key=n,this.value=s,this.color=i??t.RED,this.left=r??Q.EMPTY_NODE,this.right=o??Q.EMPTY_NODE}copy(n,s,i,r,o){return new t(n??this.key,s??this.value,i??this.color,r??this.left,o??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(n){return this.left.inorderTraversal(n)||!!n(this.key,this.value)||this.right.inorderTraversal(n)}reverseTraversal(n){return this.right.reverseTraversal(n)||n(this.key,this.value)||this.left.reverseTraversal(n)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(n,s,i){let r=this,o=i(n,r.key);return o<0?r=r.copy(null,null,null,r.left.insert(n,s,i),null):o===0?r=r.copy(null,s,null,null,null):r=r.copy(null,null,null,null,r.right.insert(n,s,i)),r.fixUp_()}removeMin_(){if(this.left.isEmpty())return Q.EMPTY_NODE;let n=this;return!n.left.isRed_()&&!n.left.left.isRed_()&&(n=n.moveRedLeft_()),n=n.copy(null,null,null,n.left.removeMin_(),null),n.fixUp_()}remove(n,s){let i,r;if(i=this,s(n,i.key)<0)!i.left.isEmpty()&&!i.left.isRed_()&&!i.left.left.isRed_()&&(i=i.moveRedLeft_()),i=i.copy(null,null,null,i.left.remove(n,s),null);else{if(i.left.isRed_()&&(i=i.rotateRight_()),!i.right.isEmpty()&&!i.right.isRed_()&&!i.right.left.isRed_()&&(i=i.moveRedRight_()),s(n,i.key)===0){if(i.right.isEmpty())return Q.EMPTY_NODE;r=i.right.min_(),i=i.copy(r.key,r.value,null,null,i.right.removeMin_())}i=i.copy(null,null,null,null,i.right.remove(n,s))}return i.fixUp_()}isRed_(){return this.color}fixUp_(){let n=this;return n.right.isRed_()&&!n.left.isRed_()&&(n=n.rotateLeft_()),n.left.isRed_()&&n.left.left.isRed_()&&(n=n.rotateRight_()),n.left.isRed_()&&n.right.isRed_()&&(n=n.colorFlip_()),n}moveRedLeft_(){let n=this.colorFlip_();return n.right.left.isRed_()&&(n=n.copy(null,null,null,null,n.right.rotateRight_()),n=n.rotateLeft_(),n=n.colorFlip_()),n}moveRedRight_(){let n=this.colorFlip_();return n.left.left.isRed_()&&(n=n.rotateRight_(),n=n.colorFlip_()),n}rotateLeft_(){let n=this.copy(null,null,t.RED,null,this.right.left);return this.right.copy(null,null,this.color,n,null)}rotateRight_(){let n=this.copy(null,null,t.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,n)}colorFlip_(){let n=this.left.copy(null,null,!this.left.color,null,null),s=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,n,s)}checkMaxDepth_(){let n=this.check_();return Math.pow(2,n)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");let n=this.left.check_();if(n!==this.right.check_())throw new Error("Black depths differ");return n+(this.isRed_()?0:1)}}return t.RED=!0,t.BLACK=!1,t})(),li=class{copy(e,n,s,i,r){return this}insert(e,n,s){return new j(e,n,null)}remove(e,n){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}},Q=class t{constructor(e,n=t.EMPTY_NODE){this.comparator_=e,this.root_=n}insert(e,n){return new t(this.comparator_,this.root_.insert(e,n,this.comparator_).copy(null,null,j.BLACK,null,null))}remove(e){return new t(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,j.BLACK,null,null))}get(e){let n,s=this.root_;for(;!s.isEmpty();){if(n=this.comparator_(e,s.key),n===0)return s.value;n<0?s=s.left:n>0&&(s=s.right)}return null}getPredecessorKey(e){let n,s=this.root_,i=null;for(;!s.isEmpty();)if(n=this.comparator_(e,s.key),n===0){if(s.left.isEmpty())return i?i.key:null;for(s=s.left;!s.right.isEmpty();)s=s.right;return s.key}else n<0?s=s.left:n>0&&(i=s,s=s.right);throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new Ge(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,n){return new Ge(this.root_,e,this.comparator_,!1,n)}getReverseIteratorFrom(e,n){return new Ge(this.root_,e,this.comparator_,!0,n)}getReverseIterator(e){return new Ge(this.root_,null,this.comparator_,!0,e)}};Q.EMPTY_NODE=new li;function mu(t,e){return Oe(t.name,e.name)}function or(t,e){return Oe(t,e)}var hi;function vu(t){hi=t}var Ll=function(t){return typeof t=="number"?"number:"+Il(t):"string:"+t},Fl=function(t){if(t.isLeafNode()){let e=t.val();f(typeof e=="string"||typeof e=="number"||typeof e=="object"&&Y(e,".sv"),"Priority must be a string or number.")}else f(t===hi||t.isEmpty(),"priority of unexpected type.");f(t===hi||t.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};var za,ze=(()=>{class t{static set __childrenNodeConstructor(n){za=n}static get __childrenNodeConstructor(){return za}constructor(n,s=t.__childrenNodeConstructor.EMPTY_NODE){this.value_=n,this.priorityNode_=s,this.lazyHash_=null,f(this.value_!==void 0&&this.value_!==null,"LeafNode shouldn't be created with null/undefined value."),Fl(this.priorityNode_)}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(n){return new t(this.value_,n)}getImmediateChild(n){return n===".priority"?this.priorityNode_:t.__childrenNodeConstructor.EMPTY_NODE}getChild(n){return y(n)?this:v(n)===".priority"?this.priorityNode_:t.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(n,s){return null}updateImmediateChild(n,s){return n===".priority"?this.updatePriority(s):s.isEmpty()&&n!==".priority"?this:t.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(n,s).updatePriority(this.priorityNode_)}updateChild(n,s){let i=v(n);return i===null?s:s.isEmpty()&&i!==".priority"?this:(f(i!==".priority"||ge(n)===1,".priority must be the last token in a path"),this.updateImmediateChild(i,t.__childrenNodeConstructor.EMPTY_NODE.updateChild(I(n),s)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(n,s){return!1}val(n){return n&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let n="";this.priorityNode_.isEmpty()||(n+="priority:"+Ll(this.priorityNode_.val())+":");let s=typeof this.value_;n+=s+":",s==="number"?n+=Il(this.value_):n+=this.value_,this.lazyHash_=wl(n)}return this.lazyHash_}getValue(){return this.value_}compareTo(n){return n===t.__childrenNodeConstructor.EMPTY_NODE?1:n instanceof t.__childrenNodeConstructor?-1:(f(n.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(n))}compareToLeafNode_(n){let s=typeof n.value_,i=typeof this.value_,r=t.VALUE_TYPE_ORDER.indexOf(s),o=t.VALUE_TYPE_ORDER.indexOf(i);return f(r>=0,"Unknown leaf type: "+s),f(o>=0,"Unknown leaf type: "+i),r===o?i==="object"?0:this.value_<n.value_?-1:this.value_===n.value_?0:1:o-r}withIndex(){return this}isIndexed(){return!0}equals(n){if(n===this)return!0;if(n.isLeafNode()){let s=n;return this.value_===s.value_&&this.priorityNode_.equals(s.priorityNode_)}else return!1}}t.VALUE_TYPE_ORDER=["object","boolean","number","string"];return t})(),Ul,Bl;function yu(t){Ul=t}function Eu(t){Bl=t}var ci=class extends Ye{compare(e,n){let s=e.node.getPriority(),i=n.node.getPriority(),r=s.compareTo(i);return r===0?Oe(e.name,n.name):r}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,n){return!e.getPriority().equals(n.getPriority())}minPost(){return E.MIN}maxPost(){return new E(ae,new ze("[PRIORITY-POST]",Bl))}makePost(e,n){let s=Ul(e);return new E(n,new ze("[PRIORITY-POST]",s))}toString(){return".priority"}},N=new ci;var Cu=Math.log(2),ui=class{constructor(e){let n=r=>parseInt(Math.log(r)/Cu,10),s=r=>parseInt(Array(r+1).join("1"),2);this.count=n(e+1),this.current_=this.count-1;let i=s(this.count);this.bits_=e+1&i}nextBitIsOne(){let e=!(this.bits_&1<<this.current_);return this.current_--,e}},Tn=function(t,e,n,s){t.sort(e);let i=function(l,h){let c=h-l,u,d;if(c===0)return null;if(c===1)return u=t[l],d=n?n(u):u,new j(d,u.node,j.BLACK,null,null);{let _=parseInt(c/2,10)+l,p=i(l,_),S=i(_+1,h);return u=t[_],d=n?n(u):u,new j(d,u.node,j.BLACK,p,S)}},r=function(l){let h=null,c=null,u=t.length,d=function(p,S){let D=u-p,Me=u;u-=p;let $t=i(D+1,Me),is=t[D],wh=n?n(is):is;_(new j(wh,is.node,S,null,$t))},_=function(p){h?(h.left=p,h=p):(c=p,h=p)};for(let p=0;p<l.count;++p){let S=l.nextBitIsOne(),D=Math.pow(2,l.count-(p+1));S?d(D,j.BLACK):(d(D,j.BLACK),d(D,j.RED))}return c},o=new ui(t.length),a=r(o);return new Q(s||e,a)};var Ks,We={},Qe=class t{static get Default(){return f(We&&N,"ChildrenNode.ts has not been loaded"),Ks=Ks||new t({".priority":We},{".priority":N}),Ks}constructor(e,n){this.indexes_=e,this.indexSet_=n}get(e){let n=le(this.indexes_,e);if(!n)throw new Error("No index defined for "+e);return n instanceof Q?n:null}hasIndex(e){return Y(this.indexSet_,e.toString())}addIndex(e,n){f(e!==se,"KeyIndex always exists and isn't meant to be added to the IndexMap.");let s=[],i=!1,r=n.getIterator(E.Wrap),o=r.getNext();for(;o;)i=i||e.isDefinedOn(o.node),s.push(o),o=r.getNext();let a;i?a=Tn(s,e.getCompare()):a=We;let l=e.toString(),h=rt({},this.indexSet_);h[l]=e;let c=rt({},this.indexes_);return c[l]=a,new t(c,h)}addToIndexes(e,n){let s=ot(this.indexes_,(i,r)=>{let o=le(this.indexSet_,r);if(f(o,"Missing index implementation for "+r),i===We)if(o.isDefinedOn(e.node)){let a=[],l=n.getIterator(E.Wrap),h=l.getNext();for(;h;)h.name!==e.name&&a.push(h),h=l.getNext();return a.push(e),Tn(a,o.getCompare())}else return We;else{let a=n.get(e.name),l=i;return a&&(l=l.remove(new E(e.name,a))),l.insert(e,e.node)}});return new t(s,this.indexSet_)}removeFromIndexes(e,n){let s=ot(this.indexes_,i=>{if(i===We)return i;{let r=n.get(e.name);return r?i.remove(new E(e.name,r)):i}});return new t(s,this.indexSet_)}};var Et,m=(()=>{class t{static get EMPTY_NODE(){return Et||(Et=new t(new Q(or),null,Qe.Default))}constructor(n,s,i){this.children_=n,this.priorityNode_=s,this.indexMap_=i,this.lazyHash_=null,this.priorityNode_&&Fl(this.priorityNode_),this.children_.isEmpty()&&f(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}isLeafNode(){return!1}getPriority(){return this.priorityNode_||Et}updatePriority(n){return this.children_.isEmpty()?this:new t(this.children_,n,this.indexMap_)}getImmediateChild(n){if(n===".priority")return this.getPriority();{let s=this.children_.get(n);return s===null?Et:s}}getChild(n){let s=v(n);return s===null?this:this.getImmediateChild(s).getChild(I(n))}hasChild(n){return this.children_.get(n)!==null}updateImmediateChild(n,s){if(f(s,"We should always be passing snapshot nodes"),n===".priority")return this.updatePriority(s);{let i=new E(n,s),r,o;s.isEmpty()?(r=this.children_.remove(n),o=this.indexMap_.removeFromIndexes(i,this.children_)):(r=this.children_.insert(n,s),o=this.indexMap_.addToIndexes(i,this.children_));let a=r.isEmpty()?Et:this.priorityNode_;return new t(r,a,o)}}updateChild(n,s){let i=v(n);if(i===null)return s;{f(v(n)!==".priority"||ge(n)===1,".priority must be the last token in a path");let r=this.getImmediateChild(i).updateChild(I(n),s);return this.updateImmediateChild(i,r)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(n){if(this.isEmpty())return null;let s={},i=0,r=0,o=!0;if(this.forEachChild(N,(a,l)=>{s[a]=l.val(n),i++,o&&t.INTEGER_REGEXP_.test(a)?r=Math.max(r,Number(a)):o=!1}),!n&&o&&r<2*i){let a=[];for(let l in s)a[l]=s[l];return a}else return n&&!this.getPriority().isEmpty()&&(s[".priority"]=this.getPriority().val()),s}hash(){if(this.lazyHash_===null){let n="";this.getPriority().isEmpty()||(n+="priority:"+Ll(this.getPriority().val())+":"),this.forEachChild(N,(s,i)=>{let r=i.hash();r!==""&&(n+=":"+s+":"+r)}),this.lazyHash_=n===""?"":wl(n)}return this.lazyHash_}getPredecessorChildName(n,s,i){let r=this.resolveIndex_(i);if(r){let o=r.getPredecessorKey(new E(n,s));return o?o.name:null}else return this.children_.getPredecessorKey(n)}getFirstChildName(n){let s=this.resolveIndex_(n);if(s){let i=s.minKey();return i&&i.name}else return this.children_.minKey()}getFirstChild(n){let s=this.getFirstChildName(n);return s?new E(s,this.children_.get(s)):null}getLastChildName(n){let s=this.resolveIndex_(n);if(s){let i=s.maxKey();return i&&i.name}else return this.children_.maxKey()}getLastChild(n){let s=this.getLastChildName(n);return s?new E(s,this.children_.get(s)):null}forEachChild(n,s){let i=this.resolveIndex_(n);return i?i.inorderTraversal(r=>s(r.name,r.node)):this.children_.inorderTraversal(s)}getIterator(n){return this.getIteratorFrom(n.minPost(),n)}getIteratorFrom(n,s){let i=this.resolveIndex_(s);if(i)return i.getIteratorFrom(n,r=>r);{let r=this.children_.getIteratorFrom(n.name,E.Wrap),o=r.peek();for(;o!=null&&s.compare(o,n)<0;)r.getNext(),o=r.peek();return r}}getReverseIterator(n){return this.getReverseIteratorFrom(n.maxPost(),n)}getReverseIteratorFrom(n,s){let i=this.resolveIndex_(s);if(i)return i.getReverseIteratorFrom(n,r=>r);{let r=this.children_.getReverseIteratorFrom(n.name,E.Wrap),o=r.peek();for(;o!=null&&s.compare(o,n)>0;)r.getNext(),o=r.peek();return r}}compareTo(n){return this.isEmpty()?n.isEmpty()?0:-1:n.isLeafNode()||n.isEmpty()?1:n===Gt?-1:0}withIndex(n){if(n===se||this.indexMap_.hasIndex(n))return this;{let s=this.indexMap_.addIndex(n,this.children_);return new t(this.children_,this.priorityNode_,s)}}isIndexed(n){return n===se||this.indexMap_.hasIndex(n)}equals(n){if(n===this)return!0;if(n.isLeafNode())return!1;{let s=n;if(this.getPriority().equals(s.getPriority()))if(this.children_.count()===s.children_.count()){let i=this.getIterator(N),r=s.getIterator(N),o=i.getNext(),a=r.getNext();for(;o&&a;){if(o.name!==a.name||!o.node.equals(a.node))return!1;o=i.getNext(),a=r.getNext()}return o===null&&a===null}else return!1;else return!1}}resolveIndex_(n){return n===se?null:this.indexMap_.get(n.toString())}}return t.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/,t})(),di=class extends m{constructor(){super(new Q(or),m.EMPTY_NODE,Qe.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return m.EMPTY_NODE}isEmpty(){return!1}},Gt=new di;Object.defineProperties(E,{MIN:{value:new E(pe,m.EMPTY_NODE)},MAX:{value:new E(ae,Gt)}});Sn.__EMPTY_NODE=m.EMPTY_NODE;ze.__childrenNodeConstructor=m;vu(Gt);Eu(Gt);var wu=!0;function k(t,e=null){if(t===null)return m.EMPTY_NODE;if(typeof t=="object"&&".priority"in t&&(e=t[".priority"]),f(e===null||typeof e=="string"||typeof e=="number"||typeof e=="object"&&".sv"in e,"Invalid priority type found: "+typeof e),typeof t=="object"&&".value"in t&&t[".value"]!==null&&(t=t[".value"]),typeof t!="object"||".sv"in t){let n=t;return new ze(n,k(e))}if(!(t instanceof Array)&&wu){let n=[],s=!1;if(A(t,(o,a)=>{if(o.substring(0,1)!=="."){let l=k(a);l.isEmpty()||(s=s||!l.getPriority().isEmpty(),n.push(new E(o,l)))}}),n.length===0)return m.EMPTY_NODE;let r=Tn(n,mu,o=>o.name,or);if(s){let o=Tn(n,N.getCompare());return new m(r,k(e),new Qe({".priority":o},{".priority":N}))}else return new m(r,k(e),Qe.Default)}else{let n=m.EMPTY_NODE;return A(t,(s,i)=>{if(Y(t,s)&&s.substring(0,1)!=="."){let r=k(i);(r.isLeafNode()||!r.isEmpty())&&(n=n.updateImmediateChild(s,r))}}),n.updatePriority(k(e))}}yu(k);var kt=class extends Ye{constructor(e){super(),this.indexPath_=e,f(!y(e)&&v(e)!==".priority","Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,n){let s=this.extractChild(e.node),i=this.extractChild(n.node),r=s.compareTo(i);return r===0?Oe(e.name,n.name):r}makePost(e,n){let s=k(e),i=m.EMPTY_NODE.updateChild(this.indexPath_,s);return new E(n,i)}maxPost(){let e=m.EMPTY_NODE.updateChild(this.indexPath_,Gt);return new E(ae,e)}toString(){return xt(this.indexPath_,0).join("/")}};var fi=class extends Ye{compare(e,n){let s=e.node.compareTo(n.node);return s===0?Oe(e.name,n.name):s}isDefinedOn(e){return!0}indexedValueChanged(e,n){return!e.equals(n)}minPost(){return E.MIN}maxPost(){return E.MAX}makePost(e,n){let s=k(e);return new E(n,s)}toString(){return".value"}},ar=new fi;function Hl(t){return{type:"value",snapshotNode:t}}function je(t,e){return{type:"child_added",snapshotNode:e,childName:t}}function Pt(t,e){return{type:"child_removed",snapshotNode:e,childName:t}}function Ot(t,e,n){return{type:"child_changed",snapshotNode:e,childName:t,oldSnap:n}}function Su(t,e){return{type:"child_moved",snapshotNode:e,childName:t}}var At=class{constructor(e){this.index_=e}updateChild(e,n,s,i,r,o){f(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");let a=e.getImmediateChild(n);return a.getChild(i).equals(s.getChild(i))&&a.isEmpty()===s.isEmpty()||(o!=null&&(s.isEmpty()?e.hasChild(n)?o.trackChildChange(Pt(n,a)):f(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):a.isEmpty()?o.trackChildChange(je(n,s)):o.trackChildChange(Ot(n,s,a))),e.isLeafNode()&&s.isEmpty())?e:e.updateImmediateChild(n,s).withIndex(this.index_)}updateFullNode(e,n,s){return s!=null&&(e.isLeafNode()||e.forEachChild(N,(i,r)=>{n.hasChild(i)||s.trackChildChange(Pt(i,r))}),n.isLeafNode()||n.forEachChild(N,(i,r)=>{if(e.hasChild(i)){let o=e.getImmediateChild(i);o.equals(r)||s.trackChildChange(Ot(i,r,o))}else s.trackChildChange(je(i,r))})),n.withIndex(this.index_)}updatePriority(e,n){return e.isEmpty()?m.EMPTY_NODE:e.updatePriority(n)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}};var In=class t{constructor(e){this.indexedFilter_=new At(e.getIndex()),this.index_=e.getIndex(),this.startPost_=t.getStartPost_(e),this.endPost_=t.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){let n=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,s=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return n&&s}updateChild(e,n,s,i,r,o){return this.matches(new E(n,s))||(s=m.EMPTY_NODE),this.indexedFilter_.updateChild(e,n,s,i,r,o)}updateFullNode(e,n,s){n.isLeafNode()&&(n=m.EMPTY_NODE);let i=n.withIndex(this.index_);i=i.updatePriority(m.EMPTY_NODE);let r=this;return n.forEachChild(N,(o,a)=>{r.matches(new E(o,a))||(i=i.updateImmediateChild(o,m.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,i,s)}updatePriority(e,n){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){let n=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),n)}else return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){let n=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),n)}else return e.getIndex().maxPost()}};var _i=class{constructor(e){this.withinDirectionalStart=n=>this.reverse_?this.withinEndPost(n):this.withinStartPost(n),this.withinDirectionalEnd=n=>this.reverse_?this.withinStartPost(n):this.withinEndPost(n),this.withinStartPost=n=>{let s=this.index_.compare(this.rangedFilter_.getStartPost(),n);return this.startIsInclusive_?s<=0:s<0},this.withinEndPost=n=>{let s=this.index_.compare(n,this.rangedFilter_.getEndPost());return this.endIsInclusive_?s<=0:s<0},this.rangedFilter_=new In(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,n,s,i,r,o){return this.rangedFilter_.matches(new E(n,s))||(s=m.EMPTY_NODE),e.getImmediateChild(n).equals(s)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,n,s,i,r,o):this.fullLimitUpdateChild_(e,n,s,r,o)}updateFullNode(e,n,s){let i;if(n.isLeafNode()||n.isEmpty())i=m.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<n.numChildren()&&n.isIndexed(this.index_)){i=m.EMPTY_NODE.withIndex(this.index_);let r;this.reverse_?r=n.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):r=n.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let o=0;for(;r.hasNext()&&o<this.limit_;){let a=r.getNext();if(this.withinDirectionalStart(a))if(this.withinDirectionalEnd(a))i=i.updateImmediateChild(a.name,a.node),o++;else break;else continue}}else{i=n.withIndex(this.index_),i=i.updatePriority(m.EMPTY_NODE);let r;this.reverse_?r=i.getReverseIterator(this.index_):r=i.getIterator(this.index_);let o=0;for(;r.hasNext();){let a=r.getNext();o<this.limit_&&this.withinDirectionalStart(a)&&this.withinDirectionalEnd(a)?o++:i=i.updateImmediateChild(a.name,m.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,i,s)}updatePriority(e,n){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,n,s,i,r){let o;if(this.reverse_){let u=this.index_.getCompare();o=(d,_)=>u(_,d)}else o=this.index_.getCompare();let a=e;f(a.numChildren()===this.limit_,"");let l=new E(n,s),h=this.reverse_?a.getFirstChild(this.index_):a.getLastChild(this.index_),c=this.rangedFilter_.matches(l);if(a.hasChild(n)){let u=a.getImmediateChild(n),d=i.getChildAfterChild(this.index_,h,this.reverse_);for(;d!=null&&(d.name===n||a.hasChild(d.name));)d=i.getChildAfterChild(this.index_,d,this.reverse_);let _=d==null?1:o(d,l);if(c&&!s.isEmpty()&&_>=0)return r?.trackChildChange(Ot(n,s,u)),a.updateImmediateChild(n,s);{r?.trackChildChange(Pt(n,u));let S=a.updateImmediateChild(n,m.EMPTY_NODE);return d!=null&&this.rangedFilter_.matches(d)?(r?.trackChildChange(je(d.name,d.node)),S.updateImmediateChild(d.name,d.node)):S}}else return s.isEmpty()?e:c&&o(h,l)>=0?(r!=null&&(r.trackChildChange(Pt(h.name,h.node)),r.trackChildChange(je(n,s))),a.updateImmediateChild(n,s).updateImmediateChild(h.name,m.EMPTY_NODE)):e}};var pi=class t{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=N}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===""?this.startSet_:this.viewFrom_==="l"}getIndexStartValue(){return f(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return f(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:pe}hasEnd(){return this.endSet_}getIndexEndValue(){return f(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return f(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:ae}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==""}getLimit(){return f(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===N}copy(){let e=new t;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}};function Tu(t){return t.loadsAllData()?new At(t.getIndex()):t.hasLimit()?new _i(t):new In(t)}function Iu(t,e){let n=t.copy();return n.limitSet_=!0,n.limit_=e,n.viewFrom_="l",n}function bu(t,e){let n=t.copy();return n.limitSet_=!0,n.limit_=e,n.viewFrom_="r",n}function gi(t,e,n){let s=t.copy();return s.startSet_=!0,e===void 0&&(e=null),s.indexStartValue_=e,n!=null?(s.startNameSet_=!0,s.indexStartName_=n):(s.startNameSet_=!1,s.indexStartName_=""),s}function Nu(t,e,n){let s;return t.index_===se||n?s=gi(t,e,n):s=gi(t,e,ae),s.startAfterSet_=!0,s}function mi(t,e,n){let s=t.copy();return s.endSet_=!0,e===void 0&&(e=null),s.indexEndValue_=e,n!==void 0?(s.endNameSet_=!0,s.indexEndName_=n):(s.endNameSet_=!1,s.indexEndName_=""),s}function Ru(t,e,n){let s;return t.index_===se||n?s=mi(t,e,n):s=mi(t,e,pe),s.endBeforeSet_=!0,s}function Gn(t,e){let n=t.copy();return n.index_=e,n}function Qa(t){let e={};if(t.isDefault())return e;let n;if(t.index_===N?n="$priority":t.index_===ar?n="$value":t.index_===se?n="$key":(f(t.index_ instanceof kt,"Unrecognized index type!"),n=t.index_.toString()),e.orderBy=P(n),t.startSet_){let s=t.startAfterSet_?"startAfter":"startAt";e[s]=P(t.indexStartValue_),t.startNameSet_&&(e[s]+=","+P(t.indexStartName_))}if(t.endSet_){let s=t.endBeforeSet_?"endBefore":"endAt";e[s]=P(t.indexEndValue_),t.endNameSet_&&(e[s]+=","+P(t.indexEndName_))}return t.limitSet_&&(t.isViewFromLeft()?e.limitToFirst=t.limit_:e.limitToLast=t.limit_),e}function ja(t){let e={};if(t.startSet_&&(e.sp=t.indexStartValue_,t.startNameSet_&&(e.sn=t.indexStartName_),e.sin=!t.startAfterSet_),t.endSet_&&(e.ep=t.indexEndValue_,t.endNameSet_&&(e.en=t.indexEndName_),e.ein=!t.endBeforeSet_),t.limitSet_){e.l=t.limit_;let n=t.viewFrom_;n===""&&(t.isViewFromLeft()?n="l":n="r"),e.vf=n}return t.index_!==N&&(e.i=t.index_.toString()),e}var vi=class t extends En{reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,n){return n!==void 0?"tag$"+n:(f(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}constructor(e,n,s,i){super(),this.repoInfo_=e,this.onDataUpdate_=n,this.authTokenProvider_=s,this.appCheckTokenProvider_=i,this.log_=qt("p:rest:"),this.listens_={}}listen(e,n,s,i){let r=e._path.toString();this.log_("Listen called for "+r+" "+e._queryIdentifier);let o=t.getListenId_(e,s),a={};this.listens_[o]=a;let l=Qa(e._queryParams);this.restRequest_(r+".json",l,(h,c)=>{let u=c;if(h===404&&(u=null,h=null),h===null&&this.onDataUpdate_(r,u,!1,s),le(this.listens_,o)===a){let d;h?h===401?d="permission_denied":d="rest_error:"+h:d="ok",i(d,null)}})}unlisten(e,n){let s=t.getListenId_(e,n);delete this.listens_[s]}get(e){let n=Qa(e._queryParams),s=e._path.toString(),i=new W;return this.restRequest_(s+".json",n,(r,o)=>{let a=o;r===404&&(a=null,r=null),r===null?(this.onDataUpdate_(s,a,!1,null),i.resolve(a)):i.reject(new Error(a))}),i.promise}refreshAuthToken(e){}restRequest_(e,n={},s){return n.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([i,r])=>{i&&i.accessToken&&(n.auth=i.accessToken),r&&r.token&&(n.ac=r.token);let o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+Br(n);this.log_("Sending REST request for "+o);let a=new XMLHttpRequest;a.onreadystatechange=()=>{if(s&&a.readyState===4){this.log_("REST Response for "+o+" received. status:",a.status,"response:",a.responseText);let l=null;if(a.status>=200&&a.status<300){try{l=Xt(a.responseText)}catch{M("Failed to parse JSON response for "+o+": "+a.responseText)}s(null,l)}else a.status!==401&&a.status!==404&&M("Got unsuccessful REST response for "+o+" Status: "+a.status),s(a.status);s=null}},a.open("GET",o,!0),a.send()})}};var yi=class{constructor(){this.rootNode_=m.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,n){this.rootNode_=this.rootNode_.updateChild(e,n)}};function bn(){return{value:null,children:new Map}}function nt(t,e,n){if(y(e))t.value=n,t.children.clear();else if(t.value!==null)t.value=t.value.updateChild(e,n);else{let s=v(e);t.children.has(s)||t.children.set(s,bn());let i=t.children.get(s);e=I(e),nt(i,e,n)}}function Ei(t,e){if(y(e))return t.value=null,t.children.clear(),!0;if(t.value!==null){if(t.value.isLeafNode())return!1;{let n=t.value;return t.value=null,n.forEachChild(N,(s,i)=>{nt(t,new w(s),i)}),Ei(t,e)}}else if(t.children.size>0){let n=v(e);return e=I(e),t.children.has(n)&&Ei(t.children.get(n),e)&&t.children.delete(n),t.children.size===0}else return!0}function Ci(t,e,n){t.value!==null?n(e,t.value):xu(t,(s,i)=>{let r=new w(e.toString()+"/"+s);Ci(i,r,n)})}function xu(t,e){t.children.forEach((n,s)=>{e(s,n)})}var wi=class{constructor(e){this.collection_=e,this.last_=null}get(){let e=this.collection_.get(),n=rt({},e);return this.last_&&A(this.last_,(s,i)=>{n[s]=n[s]-i}),this.last_=e,n}};var $a=10*1e3,ku=30*1e3,Pu=5*60*1e3,Si=class{constructor(e,n){this.server_=n,this.statsToReport_={},this.statsListener_=new wi(e);let s=$a+(ku-$a)*Math.random();wt(this.reportStats_.bind(this),Math.floor(s))}reportStats_(){let e=this.statsListener_.get(),n={},s=!1;A(e,(i,r)=>{r>0&&Y(this.statsToReport_,i)&&(n[i]=r,s=!0)}),s&&this.server_.reportStats(n),wt(this.reportStats_.bind(this),Math.floor(Math.random()*2*Pu))}};var te=function(t){return t[t.OVERWRITE=0]="OVERWRITE",t[t.MERGE=1]="MERGE",t[t.ACK_USER_WRITE=2]="ACK_USER_WRITE",t[t.LISTEN_COMPLETE=3]="LISTEN_COMPLETE",t}(te||{});function lr(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function hr(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function cr(t){return{fromUser:!1,fromServer:!0,queryId:t,tagged:!0}}var Ti=class t{constructor(e,n,s){this.path=e,this.affectedTree=n,this.revert=s,this.type=te.ACK_USER_WRITE,this.source=lr()}operationForChild(e){if(y(this.path)){if(this.affectedTree.value!=null)return f(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{let n=this.affectedTree.subtree(new w(e));return new t(C(),n,this.revert)}}else return f(v(this.path)===e,"operationForChild called for unrelated child."),new t(I(this.path),this.affectedTree,this.revert)}};var Nn=class t{constructor(e,n){this.source=e,this.path=n,this.type=te.LISTEN_COMPLETE}operationForChild(e){return y(this.path)?new t(this.source,C()):new t(this.source,I(this.path))}};var $e=class t{constructor(e,n,s){this.source=e,this.path=n,this.snap=s,this.type=te.OVERWRITE}operationForChild(e){return y(this.path)?new t(this.source,C(),this.snap.getImmediateChild(e)):new t(this.source,I(this.path),this.snap)}};var Dt=class t{constructor(e,n,s){this.source=e,this.path=n,this.children=s,this.type=te.MERGE}operationForChild(e){if(y(this.path)){let n=this.children.subtree(new w(e));return n.isEmpty()?null:n.value?new $e(this.source,C(),n.value):new t(this.source,C(),n)}else return f(v(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new t(this.source,I(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}};var re=class{constructor(e,n,s){this.node_=e,this.fullyInitialized_=n,this.filtered_=s}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(y(e))return this.isFullyInitialized()&&!this.filtered_;let n=v(e);return this.isCompleteForChild(n)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}};var Ii=class{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}};function Ou(t,e,n,s){let i=[],r=[];return e.forEach(o=>{o.type==="child_changed"&&t.index_.indexedValueChanged(o.oldSnap,o.snapshotNode)&&r.push(Su(o.childName,o.snapshotNode))}),Ct(t,i,"child_removed",e,s,n),Ct(t,i,"child_added",e,s,n),Ct(t,i,"child_moved",r,s,n),Ct(t,i,"child_changed",e,s,n),Ct(t,i,"value",e,s,n),i}function Ct(t,e,n,s,i,r){let o=s.filter(a=>a.type===n);o.sort((a,l)=>Du(t,a,l)),o.forEach(a=>{let l=Au(t,a,r);i.forEach(h=>{h.respondsTo(a.type)&&e.push(h.createEvent(l,t.query_))})})}function Au(t,e,n){return e.type==="value"||e.type==="child_removed"||(e.prevName=n.getPredecessorChildName(e.childName,e.snapshotNode,t.index_)),e}function Du(t,e,n){if(e.childName==null||n.childName==null)throw Le("Should only compare child_ events.");let s=new E(e.childName,e.snapshotNode),i=new E(n.childName,n.snapshotNode);return t.index_.compare(s,i)}function Vn(t,e){return{eventCache:t,serverCache:e}}function Tt(t,e,n,s){return Vn(new re(e,n,s),t.serverCache)}function Wl(t,e,n,s){return Vn(t.eventCache,new re(e,n,s))}function Rn(t){return t.eventCache.isFullyInitialized()?t.eventCache.getNode():null}function Pe(t){return t.serverCache.isFullyInitialized()?t.serverCache.getNode():null}var Ys,Mu=()=>(Ys||(Ys=new Q(Oc)),Ys),H=class t{static fromObject(e){let n=new t(null);return A(e,(s,i)=>{n=n.set(new w(s),i)}),n}constructor(e,n=Mu()){this.value=e,this.children=n}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,n){if(this.value!=null&&n(this.value))return{path:C(),value:this.value};if(y(e))return null;{let s=v(e),i=this.children.get(s);if(i!==null){let r=i.findRootMostMatchingPathAndValue(I(e),n);return r!=null?{path:x(new w(s),r.path),value:r.value}:null}else return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(e){if(y(e))return this;{let n=v(e),s=this.children.get(n);return s!==null?s.subtree(I(e)):new t(null)}}set(e,n){if(y(e))return new t(n,this.children);{let s=v(e),r=(this.children.get(s)||new t(null)).set(I(e),n),o=this.children.insert(s,r);return new t(this.value,o)}}remove(e){if(y(e))return this.children.isEmpty()?new t(null):new t(null,this.children);{let n=v(e),s=this.children.get(n);if(s){let i=s.remove(I(e)),r;return i.isEmpty()?r=this.children.remove(n):r=this.children.insert(n,i),this.value===null&&r.isEmpty()?new t(null):new t(this.value,r)}else return this}}get(e){if(y(e))return this.value;{let n=v(e),s=this.children.get(n);return s?s.get(I(e)):null}}setTree(e,n){if(y(e))return n;{let s=v(e),r=(this.children.get(s)||new t(null)).setTree(I(e),n),o;return r.isEmpty()?o=this.children.remove(s):o=this.children.insert(s,r),new t(this.value,o)}}fold(e){return this.fold_(C(),e)}fold_(e,n){let s={};return this.children.inorderTraversal((i,r)=>{s[i]=r.fold_(x(e,i),n)}),n(e,this.value,s)}findOnPath(e,n){return this.findOnPath_(e,C(),n)}findOnPath_(e,n,s){let i=this.value?s(n,this.value):!1;if(i)return i;if(y(e))return null;{let r=v(e),o=this.children.get(r);return o?o.findOnPath_(I(e),x(n,r),s):null}}foreachOnPath(e,n){return this.foreachOnPath_(e,C(),n)}foreachOnPath_(e,n,s){if(y(e))return this;{this.value&&s(n,this.value);let i=v(e),r=this.children.get(i);return r?r.foreachOnPath_(I(e),x(n,i),s):new t(null)}}foreach(e){this.foreach_(C(),e)}foreach_(e,n){this.children.inorderTraversal((s,i)=>{i.foreach_(x(e,s),n)}),this.value&&n(e,this.value)}foreachChild(e){this.children.inorderTraversal((n,s)=>{s.value&&e(n,s.value)})}};var $=class t{constructor(e){this.writeTree_=e}static empty(){return new t(new H(null))}};function It(t,e,n){if(y(e))return new $(new H(n));{let s=t.writeTree_.findRootMostValueAndPath(e);if(s!=null){let i=s.path,r=s.value,o=B(i,e);return r=r.updateChild(o,n),new $(t.writeTree_.set(i,r))}else{let i=new H(n),r=t.writeTree_.setTree(e,i);return new $(r)}}}function bi(t,e,n){let s=t;return A(n,(i,r)=>{s=It(s,x(e,i),r)}),s}function Xa(t,e){if(y(e))return $.empty();{let n=t.writeTree_.setTree(e,new H(null));return new $(n)}}function Ni(t,e){return Ae(t,e)!=null}function Ae(t,e){let n=t.writeTree_.findRootMostValueAndPath(e);return n!=null?t.writeTree_.get(n.path).getChild(B(n.path,e)):null}function Za(t){let e=[],n=t.writeTree_.value;return n!=null?n.isLeafNode()||n.forEachChild(N,(s,i)=>{e.push(new E(s,i))}):t.writeTree_.children.inorderTraversal((s,i)=>{i.value!=null&&e.push(new E(s,i.value))}),e}function fe(t,e){if(y(e))return t;{let n=Ae(t,e);return n!=null?new $(new H(n)):new $(t.writeTree_.subtree(e))}}function Ri(t){return t.writeTree_.isEmpty()}function Xe(t,e){return ql(C(),t.writeTree_,e)}function ql(t,e,n){if(e.value!=null)return n.updateChild(t,e.value);{let s=null;return e.children.inorderTraversal((i,r)=>{i===".priority"?(f(r.value!==null,"Priority writes must always be leaf nodes"),s=r.value):n=ql(x(t,i),r,n)}),!n.getChild(t).isEmpty()&&s!==null&&(n=n.updateChild(x(t,".priority"),s)),n}}function Kn(t,e){return Yl(e,t)}function Lu(t,e,n,s,i){f(s>t.lastWriteId,"Stacking an older write on top of newer ones"),i===void 0&&(i=!0),t.allWrites.push({path:e,snap:n,writeId:s,visible:i}),i&&(t.visibleWrites=It(t.visibleWrites,e,n)),t.lastWriteId=s}function Fu(t,e,n,s){f(s>t.lastWriteId,"Stacking an older merge on top of newer ones"),t.allWrites.push({path:e,children:n,writeId:s,visible:!0}),t.visibleWrites=bi(t.visibleWrites,e,n),t.lastWriteId=s}function Uu(t,e){for(let n=0;n<t.allWrites.length;n++){let s=t.allWrites[n];if(s.writeId===e)return s}return null}function Bu(t,e){let n=t.allWrites.findIndex(a=>a.writeId===e);f(n>=0,"removeWrite called with nonexistent writeId.");let s=t.allWrites[n];t.allWrites.splice(n,1);let i=s.visible,r=!1,o=t.allWrites.length-1;for(;i&&o>=0;){let a=t.allWrites[o];a.visible&&(o>=n&&Hu(a,s.path)?i=!1:z(s.path,a.path)&&(r=!0)),o--}if(i){if(r)return Wu(t),!0;if(s.snap)t.visibleWrites=Xa(t.visibleWrites,s.path);else{let a=s.children;A(a,l=>{t.visibleWrites=Xa(t.visibleWrites,x(s.path,l))})}return!0}else return!1}function Hu(t,e){if(t.snap)return z(t.path,e);for(let n in t.children)if(t.children.hasOwnProperty(n)&&z(x(t.path,n),e))return!0;return!1}function Wu(t){t.visibleWrites=Gl(t.allWrites,qu,C()),t.allWrites.length>0?t.lastWriteId=t.allWrites[t.allWrites.length-1].writeId:t.lastWriteId=-1}function qu(t){return t.visible}function Gl(t,e,n){let s=$.empty();for(let i=0;i<t.length;++i){let r=t[i];if(e(r)){let o=r.path,a;if(r.snap)z(n,o)?(a=B(n,o),s=It(s,a,r.snap)):z(o,n)&&(a=B(o,n),s=It(s,C(),r.snap.getChild(a)));else if(r.children){if(z(n,o))a=B(n,o),s=bi(s,a,r.children);else if(z(o,n))if(a=B(o,n),y(a))s=bi(s,C(),r.children);else{let l=le(r.children,v(a));if(l){let h=l.getChild(I(a));s=It(s,C(),h)}}}else throw Le("WriteRecord should have .snap or .children")}}return s}function Vl(t,e,n,s,i){if(!s&&!i){let r=Ae(t.visibleWrites,e);if(r!=null)return r;{let o=fe(t.visibleWrites,e);if(Ri(o))return n;if(n==null&&!Ni(o,C()))return null;{let a=n||m.EMPTY_NODE;return Xe(o,a)}}}else{let r=fe(t.visibleWrites,e);if(!i&&Ri(r))return n;if(!i&&n==null&&!Ni(r,C()))return null;{let o=function(h){return(h.visible||i)&&(!s||!~s.indexOf(h.writeId))&&(z(h.path,e)||z(e,h.path))},a=Gl(t.allWrites,o,e),l=n||m.EMPTY_NODE;return Xe(a,l)}}}function Gu(t,e,n){let s=m.EMPTY_NODE,i=Ae(t.visibleWrites,e);if(i)return i.isLeafNode()||i.forEachChild(N,(r,o)=>{s=s.updateImmediateChild(r,o)}),s;if(n){let r=fe(t.visibleWrites,e);return n.forEachChild(N,(o,a)=>{let l=Xe(fe(r,new w(o)),a);s=s.updateImmediateChild(o,l)}),Za(r).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}else{let r=fe(t.visibleWrites,e);return Za(r).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}}function Vu(t,e,n,s,i){f(s||i,"Either existingEventSnap or existingServerSnap must exist");let r=x(e,n);if(Ni(t.visibleWrites,r))return null;{let o=fe(t.visibleWrites,r);return Ri(o)?i.getChild(n):Xe(o,i.getChild(n))}}function Ku(t,e,n,s){let i=x(e,n),r=Ae(t.visibleWrites,i);if(r!=null)return r;if(s.isCompleteForChild(n)){let o=fe(t.visibleWrites,i);return Xe(o,s.getNode().getImmediateChild(n))}else return null}function Yu(t,e){return Ae(t.visibleWrites,e)}function zu(t,e,n,s,i,r,o){let a,l=fe(t.visibleWrites,e),h=Ae(l,C());if(h!=null)a=h;else if(n!=null)a=Xe(l,n);else return[];if(a=a.withIndex(o),!a.isEmpty()&&!a.isLeafNode()){let c=[],u=o.getCompare(),d=r?a.getReverseIteratorFrom(s,o):a.getIteratorFrom(s,o),_=d.getNext();for(;_&&c.length<i;)u(_,s)!==0&&c.push(_),_=d.getNext();return c}else return[]}function Qu(){return{visibleWrites:$.empty(),allWrites:[],lastWriteId:-1}}function xn(t,e,n,s){return Vl(t.writeTree,t.treePath,e,n,s)}function ur(t,e){return Gu(t.writeTree,t.treePath,e)}function Ja(t,e,n,s){return Vu(t.writeTree,t.treePath,e,n,s)}function kn(t,e){return Yu(t.writeTree,x(t.treePath,e))}function ju(t,e,n,s,i,r){return zu(t.writeTree,t.treePath,e,n,s,i,r)}function dr(t,e,n){return Ku(t.writeTree,t.treePath,e,n)}function Kl(t,e){return Yl(x(t.treePath,e),t.writeTree)}function Yl(t,e){return{treePath:t,writeTree:e}}var xi=class{constructor(){this.changeMap=new Map}trackChildChange(e){let n=e.type,s=e.childName;f(n==="child_added"||n==="child_changed"||n==="child_removed","Only child changes supported for tracking"),f(s!==".priority","Only non-priority child changes can be tracked.");let i=this.changeMap.get(s);if(i){let r=i.type;if(n==="child_added"&&r==="child_removed")this.changeMap.set(s,Ot(s,e.snapshotNode,i.snapshotNode));else if(n==="child_removed"&&r==="child_added")this.changeMap.delete(s);else if(n==="child_removed"&&r==="child_changed")this.changeMap.set(s,Pt(s,i.oldSnap));else if(n==="child_changed"&&r==="child_added")this.changeMap.set(s,je(s,e.snapshotNode));else if(n==="child_changed"&&r==="child_changed")this.changeMap.set(s,Ot(s,e.snapshotNode,i.oldSnap));else throw Le("Illegal combination of changes: "+e+" occurred after "+i)}else this.changeMap.set(s,e)}getChanges(){return Array.from(this.changeMap.values())}};var ki=class{getCompleteChild(e){return null}getChildAfterChild(e,n,s){return null}},zl=new ki,Mt=class{constructor(e,n,s=null){this.writes_=e,this.viewCache_=n,this.optCompleteServerCache_=s}getCompleteChild(e){let n=this.viewCache_.eventCache;if(n.isCompleteForChild(e))return n.getNode().getImmediateChild(e);{let s=this.optCompleteServerCache_!=null?new re(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return dr(this.writes_,e,s)}}getChildAfterChild(e,n,s){let i=this.optCompleteServerCache_!=null?this.optCompleteServerCache_:Pe(this.viewCache_),r=ju(this.writes_,i,n,1,s,e);return r.length===0?null:r[0]}};function $u(t){return{filter:t}}function Xu(t,e){f(e.eventCache.getNode().isIndexed(t.filter.getIndex()),"Event snap not indexed"),f(e.serverCache.getNode().isIndexed(t.filter.getIndex()),"Server snap not indexed")}function Zu(t,e,n,s,i){let r=new xi,o,a;if(n.type===te.OVERWRITE){let h=n;h.source.fromUser?o=Pi(t,e,h.path,h.snap,s,i,r):(f(h.source.fromServer,"Unknown source."),a=h.source.tagged||e.serverCache.isFiltered()&&!y(h.path),o=Pn(t,e,h.path,h.snap,s,i,a,r))}else if(n.type===te.MERGE){let h=n;h.source.fromUser?o=ed(t,e,h.path,h.children,s,i,r):(f(h.source.fromServer,"Unknown source."),a=h.source.tagged||e.serverCache.isFiltered(),o=Oi(t,e,h.path,h.children,s,i,a,r))}else if(n.type===te.ACK_USER_WRITE){let h=n;h.revert?o=sd(t,e,h.path,s,i,r):o=td(t,e,h.path,h.affectedTree,s,i,r)}else if(n.type===te.LISTEN_COMPLETE)o=nd(t,e,n.path,s,r);else throw Le("Unknown operation type: "+n.type);let l=r.getChanges();return Ju(e,o,l),{viewCache:o,changes:l}}function Ju(t,e,n){let s=e.eventCache;if(s.isFullyInitialized()){let i=s.getNode().isLeafNode()||s.getNode().isEmpty(),r=Rn(t);(n.length>0||!t.eventCache.isFullyInitialized()||i&&!s.getNode().equals(r)||!s.getNode().getPriority().equals(r.getPriority()))&&n.push(Hl(Rn(e)))}}function Ql(t,e,n,s,i,r){let o=e.eventCache;if(kn(s,n)!=null)return e;{let a,l;if(y(n))if(f(e.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),e.serverCache.isFiltered()){let h=Pe(e),c=h instanceof m?h:m.EMPTY_NODE,u=ur(s,c);a=t.filter.updateFullNode(e.eventCache.getNode(),u,r)}else{let h=xn(s,Pe(e));a=t.filter.updateFullNode(e.eventCache.getNode(),h,r)}else{let h=v(n);if(h===".priority"){f(ge(n)===1,"Can't have a priority with additional path components");let c=o.getNode();l=e.serverCache.getNode();let u=Ja(s,n,c,l);u!=null?a=t.filter.updatePriority(c,u):a=o.getNode()}else{let c=I(n),u;if(o.isCompleteForChild(h)){l=e.serverCache.getNode();let d=Ja(s,n,o.getNode(),l);d!=null?u=o.getNode().getImmediateChild(h).updateChild(c,d):u=o.getNode().getImmediateChild(h)}else u=dr(s,h,e.serverCache);u!=null?a=t.filter.updateChild(o.getNode(),h,u,c,i,r):a=o.getNode()}}return Tt(e,a,o.isFullyInitialized()||y(n),t.filter.filtersNodes())}}function Pn(t,e,n,s,i,r,o,a){let l=e.serverCache,h,c=o?t.filter:t.filter.getIndexedFilter();if(y(n))h=c.updateFullNode(l.getNode(),s,null);else if(c.filtersNodes()&&!l.isFiltered()){let _=l.getNode().updateChild(n,s);h=c.updateFullNode(l.getNode(),_,null)}else{let _=v(n);if(!l.isCompleteForPath(n)&&ge(n)>1)return e;let p=I(n),D=l.getNode().getImmediateChild(_).updateChild(p,s);_===".priority"?h=c.updatePriority(l.getNode(),D):h=c.updateChild(l.getNode(),_,D,p,zl,null)}let u=Wl(e,h,l.isFullyInitialized()||y(n),c.filtersNodes()),d=new Mt(i,u,r);return Ql(t,u,n,i,d,a)}function Pi(t,e,n,s,i,r,o){let a=e.eventCache,l,h,c=new Mt(i,e,r);if(y(n))h=t.filter.updateFullNode(e.eventCache.getNode(),s,o),l=Tt(e,h,!0,t.filter.filtersNodes());else{let u=v(n);if(u===".priority")h=t.filter.updatePriority(e.eventCache.getNode(),s),l=Tt(e,h,a.isFullyInitialized(),a.isFiltered());else{let d=I(n),_=a.getNode().getImmediateChild(u),p;if(y(d))p=s;else{let S=c.getCompleteChild(u);S!=null?ir(d)===".priority"&&S.getChild(Dl(d)).isEmpty()?p=S:p=S.updateChild(d,s):p=m.EMPTY_NODE}if(_.equals(p))l=e;else{let S=t.filter.updateChild(a.getNode(),u,p,d,c,o);l=Tt(e,S,a.isFullyInitialized(),t.filter.filtersNodes())}}}return l}function el(t,e){return t.eventCache.isCompleteForChild(e)}function ed(t,e,n,s,i,r,o){let a=e;return s.foreach((l,h)=>{let c=x(n,l);el(e,v(c))&&(a=Pi(t,a,c,h,i,r,o))}),s.foreach((l,h)=>{let c=x(n,l);el(e,v(c))||(a=Pi(t,a,c,h,i,r,o))}),a}function tl(t,e,n){return n.foreach((s,i)=>{e=e.updateChild(s,i)}),e}function Oi(t,e,n,s,i,r,o,a){if(e.serverCache.getNode().isEmpty()&&!e.serverCache.isFullyInitialized())return e;let l=e,h;y(n)?h=s:h=new H(null).setTree(n,s);let c=e.serverCache.getNode();return h.children.inorderTraversal((u,d)=>{if(c.hasChild(u)){let _=e.serverCache.getNode().getImmediateChild(u),p=tl(t,_,d);l=Pn(t,l,new w(u),p,i,r,o,a)}}),h.children.inorderTraversal((u,d)=>{let _=!e.serverCache.isCompleteForChild(u)&&d.value===null;if(!c.hasChild(u)&&!_){let p=e.serverCache.getNode().getImmediateChild(u),S=tl(t,p,d);l=Pn(t,l,new w(u),S,i,r,o,a)}}),l}function td(t,e,n,s,i,r,o){if(kn(i,n)!=null)return e;let a=e.serverCache.isFiltered(),l=e.serverCache;if(s.value!=null){if(y(n)&&l.isFullyInitialized()||l.isCompleteForPath(n))return Pn(t,e,n,l.getNode().getChild(n),i,r,a,o);if(y(n)){let h=new H(null);return l.getNode().forEachChild(se,(c,u)=>{h=h.set(new w(c),u)}),Oi(t,e,n,h,i,r,a,o)}else return e}else{let h=new H(null);return s.foreach((c,u)=>{let d=x(n,c);l.isCompleteForPath(d)&&(h=h.set(c,l.getNode().getChild(d)))}),Oi(t,e,n,h,i,r,a,o)}}function nd(t,e,n,s,i){let r=e.serverCache,o=Wl(e,r.getNode(),r.isFullyInitialized()||y(n),r.isFiltered());return Ql(t,o,n,s,zl,i)}function sd(t,e,n,s,i,r){let o;if(kn(s,n)!=null)return e;{let a=new Mt(s,e,i),l=e.eventCache.getNode(),h;if(y(n)||v(n)===".priority"){let c;if(e.serverCache.isFullyInitialized())c=xn(s,Pe(e));else{let u=e.serverCache.getNode();f(u instanceof m,"serverChildren would be complete if leaf node"),c=ur(s,u)}c=c,h=t.filter.updateFullNode(l,c,r)}else{let c=v(n),u=dr(s,c,e.serverCache);u==null&&e.serverCache.isCompleteForChild(c)&&(u=l.getImmediateChild(c)),u!=null?h=t.filter.updateChild(l,c,u,I(n),a,r):e.eventCache.getNode().hasChild(c)?h=t.filter.updateChild(l,c,m.EMPTY_NODE,I(n),a,r):h=l,h.isEmpty()&&e.serverCache.isFullyInitialized()&&(o=xn(s,Pe(e)),o.isLeafNode()&&(h=t.filter.updateFullNode(h,o,r)))}return o=e.serverCache.isFullyInitialized()||kn(s,C())!=null,Tt(e,h,o,t.filter.filtersNodes())}}var Ai=class{constructor(e,n){this.query_=e,this.eventRegistrations_=[];let s=this.query_._queryParams,i=new At(s.getIndex()),r=Tu(s);this.processor_=$u(r);let o=n.serverCache,a=n.eventCache,l=i.updateFullNode(m.EMPTY_NODE,o.getNode(),null),h=r.updateFullNode(m.EMPTY_NODE,a.getNode(),null),c=new re(l,o.isFullyInitialized(),i.filtersNodes()),u=new re(h,a.isFullyInitialized(),r.filtersNodes());this.viewCache_=Vn(u,c),this.eventGenerator_=new Ii(this.query_)}get query(){return this.query_}};function id(t){return t.viewCache_.serverCache.getNode()}function rd(t){return Rn(t.viewCache_)}function od(t,e){let n=Pe(t.viewCache_);return n&&(t.query._queryParams.loadsAllData()||!y(e)&&!n.getImmediateChild(v(e)).isEmpty())?n.getChild(e):null}function nl(t){return t.eventRegistrations_.length===0}function ad(t,e){t.eventRegistrations_.push(e)}function sl(t,e,n){let s=[];if(n){f(e==null,"A cancel should cancel all event registrations.");let i=t.query._path;t.eventRegistrations_.forEach(r=>{let o=r.createCancelEvent(n,i);o&&s.push(o)})}if(e){let i=[];for(let r=0;r<t.eventRegistrations_.length;++r){let o=t.eventRegistrations_[r];if(!o.matches(e))i.push(o);else if(e.hasAnyCallback()){i=i.concat(t.eventRegistrations_.slice(r+1));break}}t.eventRegistrations_=i}else t.eventRegistrations_=[];return s}function il(t,e,n,s){e.type===te.MERGE&&e.source.queryId!==null&&(f(Pe(t.viewCache_),"We should always have a full cache before handling merges"),f(Rn(t.viewCache_),"Missing event cache, even though we have a server cache"));let i=t.viewCache_,r=Zu(t.processor_,i,e,n,s);return Xu(t.processor_,r.viewCache),f(r.viewCache.serverCache.isFullyInitialized()||!i.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),t.viewCache_=r.viewCache,jl(t,r.changes,r.viewCache.eventCache.getNode(),null)}function ld(t,e){let n=t.viewCache_.eventCache,s=[];return n.getNode().isLeafNode()||n.getNode().forEachChild(N,(r,o)=>{s.push(je(r,o))}),n.isFullyInitialized()&&s.push(Hl(n.getNode())),jl(t,s,n.getNode(),e)}function jl(t,e,n,s){let i=s?[s]:t.eventRegistrations_;return Ou(t.eventGenerator_,e,n,i)}var On,An=class{constructor(){this.views=new Map}};function hd(t){f(!On,"__referenceConstructor has already been defined"),On=t}function cd(){return f(On,"Reference.ts has not been loaded"),On}function ud(t){return t.views.size===0}function fr(t,e,n,s){let i=e.source.queryId;if(i!==null){let r=t.views.get(i);return f(r!=null,"SyncTree gave us an op for an invalid query."),il(r,e,n,s)}else{let r=[];for(let o of t.views.values())r=r.concat(il(o,e,n,s));return r}}function $l(t,e,n,s,i){let r=e._queryIdentifier,o=t.views.get(r);if(!o){let a=xn(n,i?s:null),l=!1;a?l=!0:s instanceof m?(a=ur(n,s),l=!1):(a=m.EMPTY_NODE,l=!1);let h=Vn(new re(a,l,!1),new re(s,i,!1));return new Ai(e,h)}return o}function dd(t,e,n,s,i,r){let o=$l(t,e,s,i,r);return t.views.has(e._queryIdentifier)||t.views.set(e._queryIdentifier,o),ad(o,n),ld(o,n)}function fd(t,e,n,s){let i=e._queryIdentifier,r=[],o=[],a=me(t);if(i==="default")for(let[l,h]of t.views.entries())o=o.concat(sl(h,n,s)),nl(h)&&(t.views.delete(l),h.query._queryParams.loadsAllData()||r.push(h.query));else{let l=t.views.get(i);l&&(o=o.concat(sl(l,n,s)),nl(l)&&(t.views.delete(i),l.query._queryParams.loadsAllData()||r.push(l.query)))}return a&&!me(t)&&r.push(new(cd())(e._repo,e._path)),{removed:r,events:o}}function Xl(t){let e=[];for(let n of t.views.values())n.query._queryParams.loadsAllData()||e.push(n);return e}function _e(t,e){let n=null;for(let s of t.views.values())n=n||od(s,e);return n}function Zl(t,e){if(e._queryParams.loadsAllData())return Yn(t);{let s=e._queryIdentifier;return t.views.get(s)}}function Jl(t,e){return Zl(t,e)!=null}function me(t){return Yn(t)!=null}function Yn(t){for(let e of t.views.values())if(e.query._queryParams.loadsAllData())return e;return null}var Dn;function _d(t){f(!Dn,"__referenceConstructor has already been defined"),Dn=t}function pd(){return f(Dn,"Reference.ts has not been loaded"),Dn}var gd=1,Mn=class{constructor(e){this.listenProvider_=e,this.syncPointTree_=new H(null),this.pendingWriteTree_=Qu(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}};function _r(t,e,n,s,i){return Lu(t.pendingWriteTree_,e,n,s,i),i?st(t,new $e(lr(),e,n)):[]}function md(t,e,n,s){Fu(t.pendingWriteTree_,e,n,s);let i=H.fromObject(n);return st(t,new Dt(lr(),e,i))}function de(t,e,n=!1){let s=Uu(t.pendingWriteTree_,e);if(Bu(t.pendingWriteTree_,e)){let r=new H(null);return s.snap!=null?r=r.set(C(),!0):A(s.children,o=>{r=r.set(new w(o),!0)}),st(t,new Ti(s.path,r,n))}else return[]}function Vt(t,e,n){return st(t,new $e(hr(),e,n))}function vd(t,e,n){let s=H.fromObject(n);return st(t,new Dt(hr(),e,s))}function yd(t,e){return st(t,new Nn(hr(),e))}function Ed(t,e,n){let s=pr(t,n);if(s){let i=gr(s),r=i.path,o=i.queryId,a=B(r,e),l=new Nn(cr(o),a);return mr(t,r,l)}else return[]}function Ln(t,e,n,s,i=!1){let r=e._path,o=t.syncPointTree_.get(r),a=[];if(o&&(e._queryIdentifier==="default"||Jl(o,e))){let l=fd(o,e,n,s);ud(o)&&(t.syncPointTree_=t.syncPointTree_.remove(r));let h=l.removed;if(a=l.events,!i){let c=h.findIndex(d=>d._queryParams.loadsAllData())!==-1,u=t.syncPointTree_.findOnPath(r,(d,_)=>me(_));if(c&&!u){let d=t.syncPointTree_.subtree(r);if(!d.isEmpty()){let _=Sd(d);for(let p=0;p<_.length;++p){let S=_[p],D=S.query,Me=sh(t,S);t.listenProvider_.startListening(bt(D),Lt(t,D),Me.hashFn,Me.onComplete)}}}!u&&h.length>0&&!s&&(c?t.listenProvider_.stopListening(bt(e),null):h.forEach(d=>{let _=t.queryToTagMap.get(Qn(d));t.listenProvider_.stopListening(bt(d),_)}))}Td(t,h)}return a}function eh(t,e,n,s){let i=pr(t,s);if(i!=null){let r=gr(i),o=r.path,a=r.queryId,l=B(o,e),h=new $e(cr(a),l,n);return mr(t,o,h)}else return[]}function Cd(t,e,n,s){let i=pr(t,s);if(i){let r=gr(i),o=r.path,a=r.queryId,l=B(o,e),h=H.fromObject(n),c=new Dt(cr(a),l,h);return mr(t,o,c)}else return[]}function Di(t,e,n,s=!1){let i=e._path,r=null,o=!1;t.syncPointTree_.foreachOnPath(i,(d,_)=>{let p=B(d,i);r=r||_e(_,p),o=o||me(_)});let a=t.syncPointTree_.get(i);a?(o=o||me(a),r=r||_e(a,C())):(a=new An,t.syncPointTree_=t.syncPointTree_.set(i,a));let l;r!=null?l=!0:(l=!1,r=m.EMPTY_NODE,t.syncPointTree_.subtree(i).foreachChild((_,p)=>{let S=_e(p,C());S&&(r=r.updateImmediateChild(_,S))}));let h=Jl(a,e);if(!h&&!e._queryParams.loadsAllData()){let d=Qn(e);f(!t.queryToTagMap.has(d),"View does not exist, but we have a tag");let _=Id();t.queryToTagMap.set(d,_),t.tagToQueryMap.set(_,d)}let c=Kn(t.pendingWriteTree_,i),u=dd(a,e,n,c,r,l);if(!h&&!o&&!s){let d=Zl(a,e);u=u.concat(bd(t,e,d))}return u}function zn(t,e,n){let i=t.pendingWriteTree_,r=t.syncPointTree_.findOnPath(e,(o,a)=>{let l=B(o,e),h=_e(a,l);if(h)return h});return Vl(i,e,r,n,!0)}function wd(t,e){let n=e._path,s=null;t.syncPointTree_.foreachOnPath(n,(h,c)=>{let u=B(h,n);s=s||_e(c,u)});let i=t.syncPointTree_.get(n);i?s=s||_e(i,C()):(i=new An,t.syncPointTree_=t.syncPointTree_.set(n,i));let r=s!=null,o=r?new re(s,!0,!1):null,a=Kn(t.pendingWriteTree_,e._path),l=$l(i,e,a,r?o.getNode():m.EMPTY_NODE,r);return rd(l)}function st(t,e){return th(e,t.syncPointTree_,null,Kn(t.pendingWriteTree_,C()))}function th(t,e,n,s){if(y(t.path))return nh(t,e,n,s);{let i=e.get(C());n==null&&i!=null&&(n=_e(i,C()));let r=[],o=v(t.path),a=t.operationForChild(o),l=e.children.get(o);if(l&&a){let h=n?n.getImmediateChild(o):null,c=Kl(s,o);r=r.concat(th(a,l,h,c))}return i&&(r=r.concat(fr(i,t,s,n))),r}}function nh(t,e,n,s){let i=e.get(C());n==null&&i!=null&&(n=_e(i,C()));let r=[];return e.children.inorderTraversal((o,a)=>{let l=n?n.getImmediateChild(o):null,h=Kl(s,o),c=t.operationForChild(o);c&&(r=r.concat(nh(c,a,l,h)))}),i&&(r=r.concat(fr(i,t,s,n))),r}function sh(t,e){let n=e.query,s=Lt(t,n);return{hashFn:()=>(id(e)||m.EMPTY_NODE).hash(),onComplete:i=>{if(i==="ok")return s?Ed(t,n._path,s):yd(t,n._path);{let r=Mc(i,n);return Ln(t,n,null,r)}}}}function Lt(t,e){let n=Qn(e);return t.queryToTagMap.get(n)}function Qn(t){return t._path.toString()+"$"+t._queryIdentifier}function pr(t,e){return t.tagToQueryMap.get(e)}function gr(t){let e=t.indexOf("$");return f(e!==-1&&e<t.length-1,"Bad queryKey."),{queryId:t.substr(e+1),path:new w(t.substr(0,e))}}function mr(t,e,n){let s=t.syncPointTree_.get(e);f(s,"Missing sync point for query tag that we're tracking");let i=Kn(t.pendingWriteTree_,e);return fr(s,n,i,null)}function Sd(t){return t.fold((e,n,s)=>{if(n&&me(n))return[Yn(n)];{let i=[];return n&&(i=Xl(n)),A(s,(r,o)=>{i=i.concat(o)}),i}})}function bt(t){return t._queryParams.loadsAllData()&&!t._queryParams.isDefault()?new(pd())(t._repo,t._path):t}function Td(t,e){for(let n=0;n<e.length;++n){let s=e[n];if(!s._queryParams.loadsAllData()){let i=Qn(s),r=t.queryToTagMap.get(i);t.queryToTagMap.delete(i),t.tagToQueryMap.delete(r)}}}function Id(){return gd++}function bd(t,e,n){let s=e._path,i=Lt(t,e),r=sh(t,n),o=t.listenProvider_.startListening(bt(e),i,r.hashFn,r.onComplete),a=t.syncPointTree_.subtree(s);if(i)f(!me(a.value),"If we're adding a query, it shouldn't be shadowed");else{let l=a.fold((h,c,u)=>{if(!y(h)&&c&&me(c))return[Yn(c).query];{let d=[];return c&&(d=d.concat(Xl(c).map(_=>_.query))),A(u,(_,p)=>{d=d.concat(p)}),d}});for(let h=0;h<l.length;++h){let c=l[h];t.listenProvider_.stopListening(bt(c),Lt(t,c))}}return o}var Mi=class t{constructor(e){this.node_=e}getImmediateChild(e){let n=this.node_.getImmediateChild(e);return new t(n)}node(){return this.node_}},Li=class t{constructor(e,n){this.syncTree_=e,this.path_=n}getImmediateChild(e){let n=x(this.path_,e);return new t(this.syncTree_,n)}node(){return zn(this.syncTree_,this.path_)}},Nd=function(t){return t=t||{},t.timestamp=t.timestamp||new Date().getTime(),t},rl=function(t,e,n){if(!t||typeof t!="object")return t;if(f(".sv"in t,"Unexpected leaf node or priority contents"),typeof t[".sv"]=="string")return Rd(t[".sv"],e,n);if(typeof t[".sv"]=="object")return xd(t[".sv"],e);f(!1,"Unexpected server value: "+JSON.stringify(t,null,2))},Rd=function(t,e,n){switch(t){case"timestamp":return n.timestamp;default:f(!1,"Unexpected server value: "+t)}},xd=function(t,e,n){t.hasOwnProperty("increment")||f(!1,"Unexpected server value: "+JSON.stringify(t,null,2));let s=t.increment;typeof s!="number"&&f(!1,"Unexpected increment value: "+s);let i=e.node();if(f(i!==null&&typeof i<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!i.isLeafNode())return s;let o=i.getValue();return typeof o!="number"?s:o+s},ih=function(t,e,n,s){return yr(e,new Li(n,t),s)},vr=function(t,e,n){return yr(t,new Mi(e),n)};function yr(t,e,n){let s=t.getPriority().val(),i=rl(s,e.getImmediateChild(".priority"),n),r;if(t.isLeafNode()){let o=t,a=rl(o.getValue(),e,n);return a!==o.getValue()||i!==o.getPriority().val()?new ze(a,k(i)):t}else{let o=t;return r=o,i!==o.getPriority().val()&&(r=r.updatePriority(new ze(i))),o.forEachChild(N,(a,l)=>{let h=yr(l,e.getImmediateChild(a),n);h!==l&&(r=r.updateImmediateChild(a,h))}),r}}var Ft=class{constructor(e="",n=null,s={children:{},childCount:0}){this.name=e,this.parent=n,this.node=s}};function jn(t,e){let n=e instanceof w?e:new w(e),s=t,i=v(n);for(;i!==null;){let r=le(s.node.children,i)||{children:{},childCount:0};s=new Ft(i,s,r),n=I(n),i=v(n)}return s}function De(t){return t.node.value}function Er(t,e){t.node.value=e,Fi(t)}function rh(t){return t.node.childCount>0}function kd(t){return De(t)===void 0&&!rh(t)}function $n(t,e){A(t.node.children,(n,s)=>{e(new Ft(n,t,s))})}function oh(t,e,n,s){n&&!s&&e(t),$n(t,i=>{oh(i,e,!0,s)}),n&&s&&e(t)}function Pd(t,e,n){let s=n?t:t.parent;for(;s!==null;){if(e(s))return!0;s=s.parent}return!1}function Kt(t){return new w(t.parent===null?t.name:Kt(t.parent)+"/"+t.name)}function Fi(t){t.parent!==null&&Od(t.parent,t.name,t)}function Od(t,e,n){let s=kd(n),i=Y(t.node.children,e);s&&i?(delete t.node.children[e],t.node.childCount--,Fi(t)):!s&&!i&&(t.node.children[e]=n.node,t.node.childCount++,Fi(t))}var Ad=/[\[\].#$\/\u0000-\u001F\u007F]/,Dd=/[\[\].#$\u0000-\u001F\u007F]/,zs=10*1024*1024,Xn=function(t){return typeof t=="string"&&t.length!==0&&!Ad.test(t)},ah=function(t){return typeof t=="string"&&t.length!==0&&!Dd.test(t)},Md=function(t){return t&&(t=t.replace(/^\/*\.info(\/|$)/,"/")),ah(t)},Ut=function(t){return t===null||typeof t=="string"||typeof t=="number"&&!qn(t)||t&&typeof t=="object"&&Y(t,".sv")},oe=function(t,e,n,s){s&&e===void 0||Yt(he(t,"value"),e,n)},Yt=function(t,e,n){let s=n instanceof w?new oi(n,t):n;if(e===void 0)throw new Error(t+"contains undefined "+Re(s));if(typeof e=="function")throw new Error(t+"contains a function "+Re(s)+" with contents = "+e.toString());if(qn(e))throw new Error(t+"contains "+e.toString()+" "+Re(s));if(typeof e=="string"&&e.length>zs/3&&at(e)>zs)throw new Error(t+"contains a string greater than "+zs+" utf8 bytes "+Re(s)+" ('"+e.substring(0,50)+"...')");if(e&&typeof e=="object"){let i=!1,r=!1;if(A(e,(o,a)=>{if(o===".value")i=!0;else if(o!==".priority"&&o!==".sv"&&(r=!0,!Xn(o)))throw new Error(t+" contains an invalid key ("+o+") "+Re(s)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);uu(s,o),Yt(t,a,s),du(s)}),i&&r)throw new Error(t+' contains ".value" child '+Re(s)+" in addition to actual children.")}},Ld=function(t,e){let n,s;for(n=0;n<e.length;n++){s=e[n];let r=xt(s);for(let o=0;o<r.length;o++)if(!(r[o]===".priority"&&o===r.length-1)){if(!Xn(r[o]))throw new Error(t+"contains an invalid key ("+r[o]+") in path "+s.toString()+`. Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`)}}e.sort(cu);let i=null;for(n=0;n<e.length;n++){if(s=e[n],i!==null&&z(i,s))throw new Error(t+"contains a path "+i.toString()+" that is ancestor of another path "+s.toString());i=s}},lh=function(t,e,n,s){if(s&&e===void 0)return;let i=he(t,"values");if(!(e&&typeof e=="object")||Array.isArray(e))throw new Error(i+" must be an object containing the children to replace.");let r=[];A(e,(o,a)=>{let l=new w(o);if(Yt(i,a,x(n,l)),ir(l)===".priority"&&!Ut(a))throw new Error(i+"contains an invalid value for '"+l.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");r.push(l)}),Ld(i,r)},Cr=function(t,e,n){if(!(n&&e===void 0)){if(qn(e))throw new Error(he(t,"priority")+"is "+e.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!Ut(e))throw new Error(he(t,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")}},zt=function(t,e,n,s){if(!(s&&n===void 0)&&!Xn(n))throw new Error(he(t,e)+'was an invalid key = "'+n+`".  Firebase keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]").`)},wr=function(t,e,n,s){if(!(s&&n===void 0)&&!ah(n))throw new Error(he(t,e)+'was an invalid path = "'+n+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},Fd=function(t,e,n,s){n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),wr(t,e,n,s)},ne=function(t,e){if(v(e)===".info")throw new Error(t+" failed = Can't modify data under /.info/")},hh=function(t,e){let n=e.path.toString();if(typeof e.repoInfo.host!="string"||e.repoInfo.host.length===0||!Xn(e.repoInfo.namespace)&&e.repoInfo.host.split(":")[0]!=="localhost"||n.length!==0&&!Md(n))throw new Error(he(t,"url")+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)};var Ui=class{constructor(){this.eventLists_=[],this.recursionDepth_=0}};function Zn(t,e){let n=null;for(let s=0;s<e.length;s++){let i=e[s],r=i.getPath();n!==null&&!rr(r,n.path)&&(t.eventLists_.push(n),n=null),n===null&&(n={events:[],path:r}),n.events.push(i)}n&&t.eventLists_.push(n)}function ch(t,e,n){Zn(t,n),uh(t,s=>rr(s,e))}function G(t,e,n){Zn(t,n),uh(t,s=>z(s,e)||z(e,s))}function uh(t,e){t.recursionDepth_++;let n=!0;for(let s=0;s<t.eventLists_.length;s++){let i=t.eventLists_[s];if(i){let r=i.path;e(r)?(Ud(t.eventLists_[s]),t.eventLists_[s]=null):n=!1}}n&&(t.eventLists_=[]),t.recursionDepth_--}function Ud(t){for(let e=0;e<t.events.length;e++){let n=t.events[e];if(n!==null){t.events[e]=null;let s=n.getEventRunner();ke&&O("event: "+n.toString()),tt(s)}}}var dh="repo_interrupt",Bd=25,Bi=class{constructor(e,n,s,i){this.repoInfo_=e,this.forceRestClient_=n,this.authTokenProvider_=s,this.appCheckProvider_=i,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new Ui,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=bn(),this.transactionQueueTree_=new Ft,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}};function Hd(t,e,n){if(t.stats_=nr(t.repoInfo_),t.forceRestClient_||Bc())t.server_=new vi(t.repoInfo_,(s,i,r,o)=>{ol(t,s,i,r,o)},t.authTokenProvider_,t.appCheckProvider_),setTimeout(()=>al(t,!0),0);else{if(typeof n<"u"&&n!==null){if(typeof n!="object")throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{P(n)}catch(s){throw new Error("Invalid authOverride provided: "+s)}}t.persistentConnection_=new Ke(t.repoInfo_,e,(s,i,r,o)=>{ol(t,s,i,r,o)},s=>{al(t,s)},s=>{Wd(t,s)},t.authTokenProvider_,t.appCheckProvider_,n),t.server_=t.persistentConnection_}t.authTokenProvider_.addTokenChangeListener(s=>{t.server_.refreshAuthToken(s)}),t.appCheckProvider_.addTokenChangeListener(s=>{t.server_.refreshAppCheckToken(s.token)}),t.statsReporter_=Wc(t.repoInfo_,()=>new Si(t.stats_,t.server_)),t.infoData_=new yi,t.infoSyncTree_=new Mn({startListening:(s,i,r,o)=>{let a=[],l=t.infoData_.getNode(s._path);return l.isEmpty()||(a=Vt(t.infoSyncTree_,s._path,l),setTimeout(()=>{o("ok")},0)),a},stopListening:()=>{}}),Sr(t,"connected",!1),t.serverSyncTree_=new Mn({startListening:(s,i,r,o)=>(t.server_.listen(s,r,i,(a,l)=>{let h=o(a,l);G(t.eventQueue_,s._path,h)}),[]),stopListening:(s,i)=>{t.server_.unlisten(s,i)}})}function fh(t){let n=t.infoData_.getNode(new w(".info/serverTimeOffset")).val()||0;return new Date().getTime()+n}function Qt(t){return Nd({timestamp:fh(t)})}function ol(t,e,n,s,i){t.dataUpdateCount++;let r=new w(e);n=t.interceptServerDataCallback_?t.interceptServerDataCallback_(e,n):n;let o=[];if(i)if(s){let l=ot(n,h=>k(h));o=Cd(t.serverSyncTree_,r,l,i)}else{let l=k(n);o=eh(t.serverSyncTree_,r,l,i)}else if(s){let l=ot(n,h=>k(h));o=vd(t.serverSyncTree_,r,l)}else{let l=k(n);o=Vt(t.serverSyncTree_,r,l)}let a=r;o.length>0&&(a=Ze(t,r)),G(t.eventQueue_,a,o)}function al(t,e){Sr(t,"connected",e),e===!1&&Vd(t)}function Wd(t,e){A(e,(n,s)=>{Sr(t,n,s)})}function Sr(t,e,n){let s=new w("/.info/"+e),i=k(n);t.infoData_.updateSnapshot(s,i);let r=Vt(t.infoSyncTree_,s,i);G(t.eventQueue_,s,r)}function Jn(t){return t.nextWriteId_++}function qd(t,e,n){let s=wd(t.serverSyncTree_,e);return s!=null?Promise.resolve(s):t.server_.get(e).then(i=>{let r=k(i).withIndex(e._queryParams.getIndex());Di(t.serverSyncTree_,e,n,!0);let o;if(e._queryParams.loadsAllData())o=Vt(t.serverSyncTree_,e._path,r);else{let a=Lt(t.serverSyncTree_,e);o=eh(t.serverSyncTree_,e._path,r,a)}return G(t.eventQueue_,e._path,o),Ln(t.serverSyncTree_,e,n,null,!0),r},i=>(it(t,"get for query "+P(e)+" failed: "+i),Promise.reject(new Error(i))))}function Tr(t,e,n,s,i){it(t,"set",{path:e.toString(),value:n,priority:s});let r=Qt(t),o=k(n,s),a=zn(t.serverSyncTree_,e),l=vr(o,a,r),h=Jn(t),c=_r(t.serverSyncTree_,e,l,h,!0);Zn(t.eventQueue_,c),t.server_.put(e.toString(),o.val(!0),(d,_)=>{let p=d==="ok";p||M("set at "+e+" failed: "+d);let S=de(t.serverSyncTree_,h,!p);G(t.eventQueue_,e,S),ve(t,i,d,_)});let u=br(t,e);Ze(t,u),G(t.eventQueue_,u,[])}function Gd(t,e,n,s){it(t,"update",{path:e.toString(),value:n});let i=!0,r=Qt(t),o={};if(A(n,(a,l)=>{i=!1,o[a]=ih(x(e,a),k(l),t.serverSyncTree_,r)}),i)O("update() called with empty data.  Don't do anything."),ve(t,s,"ok",void 0);else{let a=Jn(t),l=md(t.serverSyncTree_,e,o,a);Zn(t.eventQueue_,l),t.server_.merge(e.toString(),n,(h,c)=>{let u=h==="ok";u||M("update at "+e+" failed: "+h);let d=de(t.serverSyncTree_,a,!u),_=d.length>0?Ze(t,e):e;G(t.eventQueue_,_,d),ve(t,s,h,c)}),A(n,h=>{let c=br(t,x(e,h));Ze(t,c)}),G(t.eventQueue_,e,[])}}function Vd(t){it(t,"onDisconnectEvents");let e=Qt(t),n=bn();Ci(t.onDisconnect_,C(),(i,r)=>{let o=ih(i,r,t.serverSyncTree_,e);nt(n,i,o)});let s=[];Ci(n,C(),(i,r)=>{s=s.concat(Vt(t.serverSyncTree_,i,r));let o=br(t,i);Ze(t,o)}),t.onDisconnect_=bn(),G(t.eventQueue_,C(),s)}function Kd(t,e,n){t.server_.onDisconnectCancel(e.toString(),(s,i)=>{s==="ok"&&Ei(t.onDisconnect_,e),ve(t,n,s,i)})}function ll(t,e,n,s){let i=k(n);t.server_.onDisconnectPut(e.toString(),i.val(!0),(r,o)=>{r==="ok"&&nt(t.onDisconnect_,e,i),ve(t,s,r,o)})}function Yd(t,e,n,s,i){let r=k(n,s);t.server_.onDisconnectPut(e.toString(),r.val(!0),(o,a)=>{o==="ok"&&nt(t.onDisconnect_,e,r),ve(t,i,o,a)})}function zd(t,e,n,s){if(Zt(n)){O("onDisconnect().update() called with empty data.  Don't do anything."),ve(t,s,"ok",void 0);return}t.server_.onDisconnectMerge(e.toString(),n,(i,r)=>{i==="ok"&&A(n,(o,a)=>{let l=k(a);nt(t.onDisconnect_,x(e,o),l)}),ve(t,s,i,r)})}function Qd(t,e,n){let s;v(e._path)===".info"?s=Di(t.infoSyncTree_,e,n):s=Di(t.serverSyncTree_,e,n),ch(t.eventQueue_,e._path,s)}function Hi(t,e,n){let s;v(e._path)===".info"?s=Ln(t.infoSyncTree_,e,n):s=Ln(t.serverSyncTree_,e,n),ch(t.eventQueue_,e._path,s)}function _h(t){t.persistentConnection_&&t.persistentConnection_.interrupt(dh)}function jd(t){t.persistentConnection_&&t.persistentConnection_.resume(dh)}function it(t,...e){let n="";t.persistentConnection_&&(n=t.persistentConnection_.id+":"),O(n,...e)}function ve(t,e,n,s){e&&tt(()=>{if(n==="ok")e(null);else{let i=(n||"error").toUpperCase(),r=i;s&&(r+=": "+s);let o=new Error(r);o.code=i,e(o)}})}function $d(t,e,n,s,i,r){it(t,"transaction on "+e);let o={path:e,update:n,onComplete:s,status:null,order:Cl(),applyLocally:r,retryCount:0,unwatcher:i,abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},a=Ir(t,e,void 0);o.currentInputSnapshot=a;let l=o.update(a.val());if(l===void 0)o.unwatcher(),o.currentOutputSnapshotRaw=null,o.currentOutputSnapshotResolved=null,o.onComplete&&o.onComplete(null,!1,o.currentInputSnapshot);else{Yt("transaction failed: Data returned ",l,o.path),o.status=0;let h=jn(t.transactionQueueTree_,e),c=De(h)||[];c.push(o),Er(h,c);let u;typeof l=="object"&&l!==null&&Y(l,".priority")?(u=le(l,".priority"),f(Ut(u),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.")):u=(zn(t.serverSyncTree_,e)||m.EMPTY_NODE).getPriority().val();let d=Qt(t),_=k(l,u),p=vr(_,a,d);o.currentOutputSnapshotRaw=_,o.currentOutputSnapshotResolved=p,o.currentWriteId=Jn(t);let S=_r(t.serverSyncTree_,e,p,o.currentWriteId,o.applyLocally);G(t.eventQueue_,e,S),es(t,t.transactionQueueTree_)}}function Ir(t,e,n){return zn(t.serverSyncTree_,e,n)||m.EMPTY_NODE}function es(t,e=t.transactionQueueTree_){if(e||ts(t,e),De(e)){let n=gh(t,e);f(n.length>0,"Sending zero length transaction queue"),n.every(i=>i.status===0)&&Xd(t,Kt(e),n)}else rh(e)&&$n(e,n=>{es(t,n)})}function Xd(t,e,n){let s=n.map(h=>h.currentWriteId),i=Ir(t,e,s),r=i,o=i.hash();for(let h=0;h<n.length;h++){let c=n[h];f(c.status===0,"tryToSendTransactionQueue_: items in queue should all be run."),c.status=1,c.retryCount++;let u=B(e,c.path);r=r.updateChild(u,c.currentOutputSnapshotRaw)}let a=r.val(!0),l=e;t.server_.put(l.toString(),a,h=>{it(t,"transaction put response",{path:l.toString(),status:h});let c=[];if(h==="ok"){let u=[];for(let d=0;d<n.length;d++)n[d].status=2,c=c.concat(de(t.serverSyncTree_,n[d].currentWriteId)),n[d].onComplete&&u.push(()=>n[d].onComplete(null,!0,n[d].currentOutputSnapshotResolved)),n[d].unwatcher();ts(t,jn(t.transactionQueueTree_,e)),es(t,t.transactionQueueTree_),G(t.eventQueue_,e,c);for(let d=0;d<u.length;d++)tt(u[d])}else{if(h==="datastale")for(let u=0;u<n.length;u++)n[u].status===3?n[u].status=4:n[u].status=0;else{M("transaction at "+l.toString()+" failed: "+h);for(let u=0;u<n.length;u++)n[u].status=4,n[u].abortReason=h}Ze(t,e)}},o)}function Ze(t,e){let n=ph(t,e),s=Kt(n),i=gh(t,n);return Zd(t,i,s),s}function Zd(t,e,n){if(e.length===0)return;let s=[],i=[],o=e.filter(a=>a.status===0).map(a=>a.currentWriteId);for(let a=0;a<e.length;a++){let l=e[a],h=B(n,l.path),c=!1,u;if(f(h!==null,"rerunTransactionsUnderNode_: relativePath should not be null."),l.status===4)c=!0,u=l.abortReason,i=i.concat(de(t.serverSyncTree_,l.currentWriteId,!0));else if(l.status===0)if(l.retryCount>=Bd)c=!0,u="maxretry",i=i.concat(de(t.serverSyncTree_,l.currentWriteId,!0));else{let d=Ir(t,l.path,o);l.currentInputSnapshot=d;let _=e[a].update(d.val());if(_!==void 0){Yt("transaction failed: Data returned ",_,l.path);let p=k(_);typeof _=="object"&&_!=null&&Y(_,".priority")||(p=p.updatePriority(d.getPriority()));let D=l.currentWriteId,Me=Qt(t),$t=vr(p,d,Me);l.currentOutputSnapshotRaw=p,l.currentOutputSnapshotResolved=$t,l.currentWriteId=Jn(t),o.splice(o.indexOf(D),1),i=i.concat(_r(t.serverSyncTree_,l.path,$t,l.currentWriteId,l.applyLocally)),i=i.concat(de(t.serverSyncTree_,D,!0))}else c=!0,u="nodata",i=i.concat(de(t.serverSyncTree_,l.currentWriteId,!0))}G(t.eventQueue_,n,i),i=[],c&&(e[a].status=2,function(d){setTimeout(d,Math.floor(0))}(e[a].unwatcher),e[a].onComplete&&(u==="nodata"?s.push(()=>e[a].onComplete(null,!1,e[a].currentInputSnapshot)):s.push(()=>e[a].onComplete(new Error(u),!1,null))))}ts(t,t.transactionQueueTree_);for(let a=0;a<s.length;a++)tt(s[a]);es(t,t.transactionQueueTree_)}function ph(t,e){let n,s=t.transactionQueueTree_;for(n=v(e);n!==null&&De(s)===void 0;)s=jn(s,n),e=I(e),n=v(e);return s}function gh(t,e){let n=[];return mh(t,e,n),n.sort((s,i)=>s.order-i.order),n}function mh(t,e,n){let s=De(e);if(s)for(let i=0;i<s.length;i++)n.push(s[i]);$n(e,i=>{mh(t,i,n)})}function ts(t,e){let n=De(e);if(n){let s=0;for(let i=0;i<n.length;i++)n[i].status!==2&&(n[s]=n[i],s++);n.length=s,Er(e,n.length>0?n:void 0)}$n(e,s=>{ts(t,s)})}function br(t,e){let n=Kt(ph(t,e)),s=jn(t.transactionQueueTree_,e);return Pd(s,i=>{Qs(t,i)}),Qs(t,s),oh(s,i=>{Qs(t,i)}),n}function Qs(t,e){let n=De(e);if(n){let s=[],i=[],r=-1;for(let o=0;o<n.length;o++)n[o].status===3||(n[o].status===1?(f(r===o-1,"All SENT items should be at beginning of queue."),r=o,n[o].status=3,n[o].abortReason="set"):(f(n[o].status===0,"Unexpected transaction status in abort"),n[o].unwatcher(),i=i.concat(de(t.serverSyncTree_,n[o].currentWriteId,!0)),n[o].onComplete&&s.push(n[o].onComplete.bind(null,new Error("set"),!1,null))));r===-1?Er(e,void 0):n.length=r+1,G(t.eventQueue_,Kt(e),i);for(let o=0;o<s.length;o++)tt(s[o])}}function Jd(t){let e="",n=t.split("/");for(let s=0;s<n.length;s++)if(n[s].length>0){let i=n[s];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch{}e+="/"+i}return e}function ef(t){let e={};t.charAt(0)==="?"&&(t=t.substring(1));for(let n of t.split("&")){if(n.length===0)continue;let s=n.split("=");s.length===2?e[decodeURIComponent(s[0])]=decodeURIComponent(s[1]):M(`Invalid query segment '${n}' in query '${t}'`)}return e}var Wi=function(t,e){let n=tf(t),s=n.namespace;n.domain==="firebase.com"&&ie(n.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!s||s==="undefined")&&n.domain!=="localhost"&&ie("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),n.secure||kc();let i=n.scheme==="ws"||n.scheme==="wss";return{repoInfo:new yn(n.host,n.secure,s,i,e,"",s!==n.subdomain),path:new w(n.pathString)}},tf=function(t){let e="",n="",s="",i="",r="",o=!0,a="https",l=443;if(typeof t=="string"){let h=t.indexOf("//");h>=0&&(a=t.substring(0,h-1),t=t.substring(h+2));let c=t.indexOf("/");c===-1&&(c=t.length);let u=t.indexOf("?");u===-1&&(u=t.length),e=t.substring(0,Math.min(c,u)),c<u&&(i=Jd(t.substring(c,u)));let d=ef(t.substring(Math.min(t.length,u)));h=e.indexOf(":"),h>=0?(o=a==="https"||a==="wss",l=parseInt(e.substring(h+1),10)):h=e.length;let _=e.slice(0,h);if(_.toLowerCase()==="localhost")n="localhost";else if(_.split(".").length<=2)n=_;else{let p=e.indexOf(".");s=e.substring(0,p).toLowerCase(),n=e.substring(p+1),r=s}"ns"in d&&(r=d.ns)}return{host:e,port:l,domain:n,subdomain:s,secure:o,scheme:a,pathString:i,namespace:r}};var hl="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",nf=function(){let t=0,e=[];return function(n){let s=n===t;t=n;let i,r=new Array(8);for(i=7;i>=0;i--)r[i]=hl.charAt(n%64),n=Math.floor(n/64);f(n===0,"Cannot push at time == 0");let o=r.join("");if(s){for(i=11;i>=0&&e[i]===63;i--)e[i]=0;e[i]++}else for(i=0;i<12;i++)e[i]=Math.floor(Math.random()*64);for(i=0;i<12;i++)o+=hl.charAt(e[i]);return f(o.length===20,"nextPushId: Length should be 20."),o}}();var Fn=class{constructor(e,n,s,i){this.eventType=e,this.eventRegistration=n,this.snapshot=s,this.prevName=i}getPath(){let e=this.snapshot.ref;return this.eventType==="value"?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+P(this.snapshot.exportVal())}},Un=class{constructor(e,n,s){this.eventRegistration=e,this.error=n,this.path=s}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}};var Bt=class{constructor(e,n){this.snapshotCallback=e,this.cancelCallback=n}onValue(e,n){this.snapshotCallback.call(null,e,n)}onCancel(e){return f(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}};var qi=class{constructor(e,n){this._repo=e,this._path=n}cancel(){let e=new W;return Kd(this._repo,this._path,e.wrapCallback(()=>{})),e.promise}remove(){ne("OnDisconnect.remove",this._path);let e=new W;return ll(this._repo,this._path,null,e.wrapCallback(()=>{})),e.promise}set(e){ne("OnDisconnect.set",this._path),oe("OnDisconnect.set",e,this._path,!1);let n=new W;return ll(this._repo,this._path,e,n.wrapCallback(()=>{})),n.promise}setWithPriority(e,n){ne("OnDisconnect.setWithPriority",this._path),oe("OnDisconnect.setWithPriority",e,this._path,!1),Cr("OnDisconnect.setWithPriority",n,!1);let s=new W;return Yd(this._repo,this._path,e,n,s.wrapCallback(()=>{})),s.promise}update(e){ne("OnDisconnect.update",this._path),lh("OnDisconnect.update",e,this._path,!1);let n=new W;return zd(this._repo,this._path,e,n.wrapCallback(()=>{})),n.promise}};var V=class t{constructor(e,n,s,i){this._repo=e,this._path=n,this._queryParams=s,this._orderByCalled=i}get key(){return y(this._path)?null:ir(this._path)}get ref(){return new X(this._repo,this._path)}get _queryIdentifier(){let e=ja(this._queryParams),n=tr(e);return n==="{}"?"default":n}get _queryObject(){return ja(this._queryParams)}isEqual(e){if(e=L(e),!(e instanceof t))return!1;let n=this._repo===e._repo,s=rr(this._path,e._path),i=this._queryIdentifier===e._queryIdentifier;return n&&s&&i}toJSON(){return this.toString()}toString(){return this._repo.toString()+hu(this._path)}};function ns(t,e){if(t._orderByCalled===!0)throw new Error(e+": You can't combine multiple orderBy calls.")}function ye(t){let e=null,n=null;if(t.hasStart()&&(e=t.getIndexStartValue()),t.hasEnd()&&(n=t.getIndexEndValue()),t.getIndex()===se){let s="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",i="Query: When ordering by key, the argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() must be a string.";if(t.hasStart()){if(t.getIndexStartName()!==pe)throw new Error(s);if(typeof e!="string")throw new Error(i)}if(t.hasEnd()){if(t.getIndexEndName()!==ae)throw new Error(s);if(typeof n!="string")throw new Error(i)}}else if(t.getIndex()===N){if(e!=null&&!Ut(e)||n!=null&&!Ut(n))throw new Error("Query: When ordering by priority, the first argument passed to startAt(), startAfter() endAt(), endBefore(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if(f(t.getIndex()instanceof kt||t.getIndex()===ar,"unknown index type."),e!=null&&typeof e=="object"||n!=null&&typeof n=="object")throw new Error("Query: First argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() cannot be an object.")}function ss(t){if(t.hasStart()&&t.hasEnd()&&t.hasLimit()&&!t.hasAnchoredLimit())throw new Error("Query: Can't combine startAt(), startAfter(), endAt(), endBefore(), and limit(). Use limitToFirst() or limitToLast() instead.")}var X=class t extends V{constructor(e,n){super(e,n,new pi,!1)}get parent(){let e=Dl(this._path);return e===null?null:new t(this._repo,e)}get root(){let e=this;for(;e.parent!==null;)e=e.parent;return e}},Je=class t{constructor(e,n,s){this._node=e,this.ref=n,this._index=s}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){let n=new w(e),s=et(this.ref,e);return new t(this._node.getChild(n),s,N)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(s,i)=>e(new t(i,et(this.ref,s),N)))}hasChild(e){let n=new w(e);return!this._node.getChild(n).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}};function sf(t,e){return t=L(t),t._checkNotDeleted("ref"),e!==void 0?et(t._root,e):t._root}function zf(t,e){t=L(t),t._checkNotDeleted("refFromURL");let n=Wi(e,t._repo.repoInfo_.nodeAdmin);hh("refFromURL",n);let s=n.repoInfo;return!t._repo.repoInfo_.isCustomHost()&&s.host!==t._repo.repoInfo_.host&&ie("refFromURL: Host name does not match the current database: (found "+s.host+" but expected "+t._repo.repoInfo_.host+")"),sf(t,n.path.toString())}function et(t,e){return t=L(t),v(t._path)===null?Fd("child","path",e,!1):wr("child","path",e,!1),new X(t._repo,x(t._path,e))}function Qf(t){return t=L(t),new qi(t._repo,t._path)}function jf(t,e){t=L(t),ne("push",t._path),oe("push",e,t._path,!0);let n=fh(t._repo),s=nf(n),i=et(t,s),r=et(t,s),o;return e!=null?o=vh(r,e).then(()=>r):o=Promise.resolve(r),i.then=o.then.bind(o),i.catch=o.then.bind(o,void 0),i}function $f(t){return ne("remove",t._path),vh(t,null)}function vh(t,e){t=L(t),ne("set",t._path),oe("set",e,t._path,!1);let n=new W;return Tr(t._repo,t._path,e,null,n.wrapCallback(()=>{})),n.promise}function Xf(t,e){t=L(t),ne("setPriority",t._path),Cr("setPriority",e,!1);let n=new W;return Tr(t._repo,x(t._path,".priority"),e,null,n.wrapCallback(()=>{})),n.promise}function Zf(t,e,n){if(ne("setWithPriority",t._path),oe("setWithPriority",e,t._path,!1),Cr("setWithPriority",n,!1),t.key===".length"||t.key===".keys")throw"setWithPriority failed: "+t.key+" is a read-only object.";let s=new W;return Tr(t._repo,t._path,e,n,s.wrapCallback(()=>{})),s.promise}function Jf(t,e){lh("update",e,t._path,!1);let n=new W;return Gd(t._repo,t._path,e,n.wrapCallback(()=>{})),n.promise}function e_(t){t=L(t);let e=new Bt(()=>{}),n=new Ht(e);return qd(t._repo,t,n).then(s=>new Je(s,new X(t._repo,t._path),t._queryParams.getIndex()))}var Ht=class t{constructor(e){this.callbackContext=e}respondsTo(e){return e==="value"}createEvent(e,n){let s=n._queryParams.getIndex();return new Fn("value",this,new Je(e.snapshotNode,new X(n._repo,n._path),s))}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,n){return this.callbackContext.hasCancelCallback?new Un(this,e,n):null}matches(e){return e instanceof t?!e.callbackContext||!this.callbackContext?!0:e.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}},Bn=class t{constructor(e,n){this.eventType=e,this.callbackContext=n}respondsTo(e){let n=e==="children_added"?"child_added":e;return n=n==="children_removed"?"child_removed":n,this.eventType===n}createCancelEvent(e,n){return this.callbackContext.hasCancelCallback?new Un(this,e,n):null}createEvent(e,n){f(e.childName!=null,"Child events should have a childName.");let s=et(new X(n._repo,n._path),e.childName),i=n._queryParams.getIndex();return new Fn(e.type,this,new Je(e.snapshotNode,s,i),e.prevName)}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,e.prevName)}matches(e){return e instanceof t?this.eventType===e.eventType&&(!this.callbackContext||!e.callbackContext||this.callbackContext.matches(e.callbackContext)):!1}hasAnyCallback(){return!!this.callbackContext}};function jt(t,e,n,s,i){let r;if(typeof s=="object"&&(r=void 0,i=s),typeof s=="function"&&(r=s),i&&i.onlyOnce){let l=n,h=(c,u)=>{Hi(t._repo,t,a),l(c,u)};h.userCallback=n.userCallback,h.context=n.context,n=h}let o=new Bt(n,r||void 0),a=e==="value"?new Ht(o):new Bn(e,o);return Qd(t._repo,t,a),()=>Hi(t._repo,t,a)}function rf(t,e,n,s){return jt(t,"value",e,n,s)}function t_(t,e,n,s){return jt(t,"child_added",e,n,s)}function n_(t,e,n,s){return jt(t,"child_changed",e,n,s)}function s_(t,e,n,s){return jt(t,"child_moved",e,n,s)}function i_(t,e,n,s){return jt(t,"child_removed",e,n,s)}function r_(t,e,n){let s=null,i=n?new Bt(n):null;e==="value"?s=new Ht(i):e&&(s=new Bn(e,i)),Hi(t._repo,t,s)}var K=class{},Hn=class extends K{constructor(e,n){super(),this._value=e,this._key=n,this.type="endAt"}_apply(e){oe("endAt",this._value,e._path,!0);let n=mi(e._queryParams,this._value,this._key);if(ss(n),ye(n),e._queryParams.hasEnd())throw new Error("endAt: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new V(e._repo,e._path,n,e._orderByCalled)}};function o_(t,e){return zt("endAt","key",e,!0),new Hn(t,e)}var Gi=class extends K{constructor(e,n){super(),this._value=e,this._key=n,this.type="endBefore"}_apply(e){oe("endBefore",this._value,e._path,!1);let n=Ru(e._queryParams,this._value,this._key);if(ss(n),ye(n),e._queryParams.hasEnd())throw new Error("endBefore: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new V(e._repo,e._path,n,e._orderByCalled)}};function a_(t,e){return zt("endBefore","key",e,!0),new Gi(t,e)}var Wn=class extends K{constructor(e,n){super(),this._value=e,this._key=n,this.type="startAt"}_apply(e){oe("startAt",this._value,e._path,!0);let n=gi(e._queryParams,this._value,this._key);if(ss(n),ye(n),e._queryParams.hasStart())throw new Error("startAt: Starting point was already set (by another call to startAt, startBefore or equalTo).");return new V(e._repo,e._path,n,e._orderByCalled)}};function l_(t=null,e){return zt("startAt","key",e,!0),new Wn(t,e)}var Vi=class extends K{constructor(e,n){super(),this._value=e,this._key=n,this.type="startAfter"}_apply(e){oe("startAfter",this._value,e._path,!1);let n=Nu(e._queryParams,this._value,this._key);if(ss(n),ye(n),e._queryParams.hasStart())throw new Error("startAfter: Starting point was already set (by another call to startAt, startAfter, or equalTo).");return new V(e._repo,e._path,n,e._orderByCalled)}};function h_(t,e){return zt("startAfter","key",e,!0),new Vi(t,e)}var Ki=class extends K{constructor(e){super(),this._limit=e,this.type="limitToFirst"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToFirst: Limit was already set (by another call to limitToFirst or limitToLast).");return new V(e._repo,e._path,Iu(e._queryParams,this._limit),e._orderByCalled)}};function c_(t){if(typeof t!="number"||Math.floor(t)!==t||t<=0)throw new Error("limitToFirst: First argument must be a positive integer.");return new Ki(t)}var Yi=class extends K{constructor(e){super(),this._limit=e,this.type="limitToLast"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToLast: Limit was already set (by another call to limitToFirst or limitToLast).");return new V(e._repo,e._path,bu(e._queryParams,this._limit),e._orderByCalled)}};function u_(t){if(typeof t!="number"||Math.floor(t)!==t||t<=0)throw new Error("limitToLast: First argument must be a positive integer.");return new Yi(t)}var zi=class extends K{constructor(e){super(),this._path=e,this.type="orderByChild"}_apply(e){ns(e,"orderByChild");let n=new w(this._path);if(y(n))throw new Error("orderByChild: cannot pass in empty path. Use orderByValue() instead.");let s=new kt(n),i=Gn(e._queryParams,s);return ye(i),new V(e._repo,e._path,i,!0)}};function d_(t){if(t==="$key")throw new Error('orderByChild: "$key" is invalid.  Use orderByKey() instead.');if(t==="$priority")throw new Error('orderByChild: "$priority" is invalid.  Use orderByPriority() instead.');if(t==="$value")throw new Error('orderByChild: "$value" is invalid.  Use orderByValue() instead.');return wr("orderByChild","path",t,!1),new zi(t)}var Qi=class extends K{constructor(){super(...arguments),this.type="orderByKey"}_apply(e){ns(e,"orderByKey");let n=Gn(e._queryParams,se);return ye(n),new V(e._repo,e._path,n,!0)}};function f_(){return new Qi}var ji=class extends K{constructor(){super(...arguments),this.type="orderByPriority"}_apply(e){ns(e,"orderByPriority");let n=Gn(e._queryParams,N);return ye(n),new V(e._repo,e._path,n,!0)}};function __(){return new ji}var $i=class extends K{constructor(){super(...arguments),this.type="orderByValue"}_apply(e){ns(e,"orderByValue");let n=Gn(e._queryParams,ar);return ye(n),new V(e._repo,e._path,n,!0)}};function p_(){return new $i}var Xi=class extends K{constructor(e,n){super(),this._value=e,this._key=n,this.type="equalTo"}_apply(e){if(oe("equalTo",this._value,e._path,!1),e._queryParams.hasStart())throw new Error("equalTo: Starting point was already set (by another call to startAt/startAfter or equalTo).");if(e._queryParams.hasEnd())throw new Error("equalTo: Ending point was already set (by another call to endAt/endBefore or equalTo).");return new Hn(this._value,this._key)._apply(new Wn(this._value,this._key)._apply(e))}};function g_(t,e){return zt("equalTo","key",e,!0),new Xi(t,e)}function m_(t,...e){let n=L(t);for(let s of e)n=s._apply(n);return n}hd(X);_d(X);var of="FIREBASE_DATABASE_EMULATOR_HOST",Zi={},yh=!1;function af(t,e,n,s){let i=e.lastIndexOf(":"),r=e.substring(0,i),o=rs(r);t.repoInfo_=new yn(e,o,t.repoInfo_.namespace,t.repoInfo_.webSocketOnly,t.repoInfo_.nodeAdmin,t.repoInfo_.persistenceKey,t.repoInfo_.includeNamespaceInQueryParams,!0,n),s&&(t.authTokenProvider_=s)}function Eh(t,e,n,s,i){let r=s||t.options.databaseURL;r===void 0&&(t.options.projectId||ie("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),O("Using default host for project ",t.options.projectId),r=`${t.options.projectId}-default-rtdb.firebaseio.com`);let o=Wi(r,i),a=o.repoInfo,l,h;typeof process<"u"&&process.env&&(h=process.env[of]),h?(l=!0,r=`http://${h}?ns=${a.namespace}`,o=Wi(r,i),a=o.repoInfo):l=!o.repoInfo.secure;let c=i&&l?new St(St.OWNER):new ni(t.name,t.options,e);hh("Invalid Firebase Database URL",o),y(o.path)||ie("Database URL must point to the root of a Firebase Database (not including a child path).");let u=hf(a,t,c,new ti(t,n));return new Ji(u,t)}function lf(t,e){let n=Zi[e];(!n||n[t.key]!==t)&&ie(`Database ${e}(${t.repoInfo_}) has already been deleted.`),_h(t),delete n[t.key]}function hf(t,e,n,s){let i=Zi[e.name];i||(i={},Zi[e.name]=i);let r=i[t.toURLString()];return r&&ie("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),r=new Bi(t,yh,n,s),i[t.toURLString()]=r,r}function cf(t){yh=t}var Ji=class{constructor(e,n){this._repoInternal=e,this.app=n,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(Hd(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new X(this._repo,C())),this._rootInternal}_delete(){return this._rootInternal!==null&&(lf(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){this._rootInternal===null&&ie("Cannot call "+e+" on a deleted database.")}};function Ch(){Al.IS_TRANSPORT_INITIALIZED&&M("Transport has already been initialized. Please call this function before calling ref or setting up a listener")}function v_(){Ch(),Rt.forceDisallow()}function y_(){Ch(),qe.forceDisallow(),Rt.forceAllow()}function E_(t=jr(),e){let n=Yr(t,"database").getImmediate({identifier:e});if(!n._instanceStarted){let s=Pr("database");s&&uf(n,...s)}return n}function uf(t,e,n,s={}){t=L(t),t._checkNotDeleted("useEmulator");let i=`${e}:${n}`,r=t._repoInternal;if(t._instanceStarted){if(i===t._repoInternal.repoInfo_.host&&Ur(s,r.repoInfo_.emulatorOptions))return;ie("connectDatabaseEmulator() cannot initialize or alter the emulator configuration after the database instance has started.")}let o;if(r.repoInfo_.nodeAdmin)s.mockUserToken&&ie('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),o=new St(St.OWNER);else if(s.mockUserToken){let a=typeof s.mockUserToken=="string"?s.mockUserToken:Ar(s.mockUserToken,t.app.options.projectId);o=new St(a)}rs(e)&&(Or(e),Dr("Database",!0)),af(r,i,s,o)}function C_(t){t=L(t),t._checkNotDeleted("goOffline"),_h(t._repo)}function w_(t){t=L(t),t._checkNotDeleted("goOnline"),jd(t._repo)}function S_(t,e){Sl(t,e)}function df(t){Nl(Qr),Kr(new Jt("database",(e,{instanceIdentifier:n})=>{let s=e.getProvider("app").getImmediate(),i=e.getProvider("auth-internal"),r=e.getProvider("app-check-internal");return Eh(s,i,r,n)},"PUBLIC").setMultipleInstances(!0)),ls(Da,Ma,t),ls(Da,Ma,"esm2020")}var ff={".sv":"timestamp"};function T_(){return ff}function I_(t){return{".sv":{increment:t}}}var er=class{constructor(e,n){this.committed=e,this.snapshot=n}toJSON(){return{committed:this.committed,snapshot:this.snapshot.toJSON()}}};function b_(t,e,n){if(t=L(t),ne("Reference.transaction",t._path),t.key===".length"||t.key===".keys")throw"Reference.transaction failed: "+t.key+" is a read-only object.";let s=n?.applyLocally??!0,i=new W,r=(a,l,h)=>{let c=null;a?i.reject(a):(c=new Je(h,new X(t._repo,t._path),N),i.resolve(new er(l,c)))},o=rf(t,()=>{});return $d(t._repo,t._path,e,r,o,s),i.promise}Ke.prototype.simpleListen=function(t,e){this.sendRequest("q",{p:t},e)};Ke.prototype.echo=function(t,e){this.sendRequest("echo",{d:t},e)};var N_=function(t){let e=Ke.prototype.put;return Ke.prototype.put=function(n,s,i,r){r!==void 0&&(r=t()),e.call(this,n,s,i,r)},function(){Ke.prototype.put=e}},R_=function(t){cf(t)};function x_({app:t,url:e,version:n,customAuthImpl:s,customAppCheckImpl:i,nodeAdmin:r=!1}){Nl(n);let o=new Vr("database-standalone"),a=new as("auth-internal",o),l;return i&&(l=new as("app-check-internal",o),l.setComponent(new Jt("app-check-internal",()=>i,"PRIVATE"))),a.setComponent(new Jt("auth-internal",()=>s,"PRIVATE")),Eh(t,a,l,e,r)}Vc(cl.default.Client);df("node");export{ee as a,Nl as b,pi as c,wr as d,ne as e,qi as f,V as g,X as h,Je as i,sf as j,zf as k,et as l,Qf as m,jf as n,$f as o,vh as p,Xf as q,Zf as r,Jf as s,e_ as t,rf as u,t_ as v,n_ as w,s_ as x,i_ as y,r_ as z,K as A,o_ as B,a_ as C,l_ as D,h_ as E,c_ as F,u_ as G,d_ as H,f_ as I,__ as J,p_ as K,g_ as L,m_ as M,Eh as N,Ji as O,v_ as P,y_ as Q,E_ as R,uf as S,C_ as T,w_ as U,S_ as V,T_ as W,I_ as X,er as Y,b_ as Z,N_ as _,R_ as $,x_ as aa};
