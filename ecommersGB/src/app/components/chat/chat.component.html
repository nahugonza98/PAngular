<!-- Vista de login: se muestra cuando NO estás logueado -->
<div *ngIf="!isLoggedIn; else chatUI">
  <div id="loginCard">
    <h3>Iniciar sesión</h3>

    <!-- Formulario de login -->
    <form class="login" [formGroup]="loginForm" (ngSubmit)="login()">
      <label>Email</label>
      <input type="email" formControlName="email" placeholder="nombre@correo.com" />

      <label>Contraseña</label>
      <input type="password" formControlName="password" placeholder="••••••••" />

      <!-- Alias fijo (se usa para todo el chat) -->
      <label>Nombre a mostrar en el chat</label>
      <input type="text" formControlName="username" placeholder="Tu alias" />

      <div class="alert" *ngIf="loginErrorMsg">{{ loginErrorMsg }}</div>

      <button class="login-btn" type="submit" [disabled]="loadingLogin || loginForm.invalid">
        {{ loadingLogin ? 'Ingresando…' : 'Iniciar sesión' }}
      </button>
    </form>
  </div>
</div>

<!-- Vista del chat: se muestra cuando SÍ estás logueado -->
<ng-template #chatUI>
  <div class="chat-shell">
    <div class="chat-header">
      <div class="title">Sala global</div>
      <span class="spacer"></span>
      <button class="logout" (click)="logout()">Salir</button>
    </div>

    <div id="history" class="history" #historyRef>
      <div
        *ngFor="let chat of chats; trackBy: trackById"
        class="msg"
        [ngClass]="{ me: chat.uid === currentUid, other: chat.uid !== currentUid }"
      >
        <div class="bubble">
          <div class="msg-meta">
            <b>{{ nombreDe(chat.uid) }}</b>
            <span class="sep">·</span>
            <span class="role-badge" [ngClass]="rolDe(chat.uid)">
              {{ rolDe(chat.uid) }}
            </span>
            <span class="sep">·</span>
            <span class="time">{{ chat.timestamp | date:'short' }}</span>
          </div>
          <div class="msg-text">{{ chat.text }}</div>
        </div>
      </div>
    </div>

    <!-- Composer SIN alias -->
    <form id="message" class="composer" [formGroup]="form" (ngSubmit)="send()">
      <div class="send-box">
        <input
          type="text"
          formControlName="message"
          placeholder="Escribe un mensaje…"
          autocomplete="off"
        />
        <button  class="send-box" type="submit" [disabled]="form.invalid || !form.value.message?.trim()">
          Enviar
        </button>
      </div>
    </form>
  </div>
</ng-template>
