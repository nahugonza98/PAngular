{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/Nahuel/Documents/Proyectos/PAngular-master/PAngular-master/ecommersGB/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { CommonModule } from '@angular/common';\nimport { HttpClientModule } from '@angular/common/http';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../../servicios/carrito.service\";\nimport * as i2 from \"@angular/router\";\nimport * as i3 from \"../../servicios/factura.service\";\nimport * as i4 from \"@angular/common/http\";\nimport * as i5 from \"@angular/common\";\nfunction CarritoComponent_div_3_div_1_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\")(1, \"p\");\n    i0.ɵɵtext(2, \"No hay productos en el carrito.\");\n    i0.ɵɵelementEnd()();\n  }\n}\nfunction CarritoComponent_div_3_div_2_div_1_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r2 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 6);\n    i0.ɵɵelement(1, \"img\", 7);\n    i0.ɵɵelementStart(2, \"div\", 8)(3, \"h4\");\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(5, \"div\", 9)(6, \"button\", 10);\n    i0.ɵɵlistener(\"click\", function CarritoComponent_div_3_div_2_div_1_Template_button_click_6_listener() {\n      const producto_r3 = i0.ɵɵrestoreView(_r2).$implicit;\n      const ctx_r3 = i0.ɵɵnextContext(3);\n      return i0.ɵɵresetView(ctx_r3.disminuirCantidad(producto_r3));\n    });\n    i0.ɵɵtext(7, \"\\u2212\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(8);\n    i0.ɵɵelementStart(9, \"button\", 10);\n    i0.ɵɵlistener(\"click\", function CarritoComponent_div_3_div_2_div_1_Template_button_click_9_listener() {\n      const producto_r3 = i0.ɵɵrestoreView(_r2).$implicit;\n      const ctx_r3 = i0.ɵɵnextContext(3);\n      return i0.ɵɵresetView(ctx_r3.aumentarCantidad(producto_r3));\n    });\n    i0.ɵɵtext(10, \"+\");\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(11, \"p\");\n    i0.ɵɵtext(12);\n    i0.ɵɵpipe(13, \"number\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(14, \"p\")(15, \"strong\");\n    i0.ɵɵtext(16, \"Subtotal:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(17);\n    i0.ɵɵpipe(18, \"number\");\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const producto_r3 = ctx.$implicit;\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"src\", producto_r3.imagen, i0.ɵɵsanitizeUrl)(\"alt\", producto_r3.nombre);\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate(producto_r3.nombre);\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" Cantidad: \", producto_r3.cantidad, \" \");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\"Precio unitario: $\", i0.ɵɵpipeBind2(13, 6, producto_r3.precio, \"1.0-0\"), \"\");\n    i0.ɵɵadvance(5);\n    i0.ɵɵtextInterpolate1(\" $\", i0.ɵɵpipeBind2(18, 9, producto_r3.precio * producto_r3.cantidad, \"1.0-0\"), \"\");\n  }\n}\nfunction CarritoComponent_div_3_div_2_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r1 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\");\n    i0.ɵɵtemplate(1, CarritoComponent_div_3_div_2_div_1_Template, 19, 12, \"div\", 3);\n    i0.ɵɵelement(2, \"hr\");\n    i0.ɵɵelementStart(3, \"p\", 4)(4, \"strong\");\n    i0.ɵɵtext(5, \"Total a pagar:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(6);\n    i0.ɵɵpipe(7, \"number\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(8, \"button\", 5);\n    i0.ɵɵlistener(\"click\", function CarritoComponent_div_3_div_2_Template_button_click_8_listener() {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r3 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r3.irAFinalizarCompra());\n    });\n    i0.ɵɵtext(9, \" \\uD83E\\uDDFE Finalizar compra\\n\");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r3 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngForOf\", ctx_r3.productosEnCarrito);\n    i0.ɵɵadvance(5);\n    i0.ɵɵtextInterpolate1(\" $\", i0.ɵɵpipeBind2(7, 2, ctx_r3.obtenerTotal(), \"1.0-0\"), \" \");\n  }\n}\nfunction CarritoComponent_div_3_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\");\n    i0.ɵɵtemplate(1, CarritoComponent_div_3_div_1_Template, 3, 0, \"div\", 1)(2, CarritoComponent_div_3_div_2_Template, 10, 5, \"div\", 1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r3 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r3.productosEnCarrito.length === 0);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r3.productosEnCarrito.length > 0);\n  }\n}\nfunction CarritoComponent_div_4_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r5 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 11)(1, \"button\", 12);\n    i0.ɵɵlistener(\"click\", function CarritoComponent_div_4_Template_button_click_1_listener() {\n      i0.ɵɵrestoreView(_r5);\n      const ctx_r3 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r3.irAProductos());\n    });\n    i0.ɵɵtext(2, \" \\uD83D\\uDECD\\uFE0F Volver a la tienda \");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"button\", 13);\n    i0.ɵɵlistener(\"click\", function CarritoComponent_div_4_Template_button_click_3_listener() {\n      i0.ɵɵrestoreView(_r5);\n      const ctx_r3 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r3.irAFacturas());\n    });\n    i0.ɵɵtext(4, \" \\uD83D\\uDCC4 Ver mis facturas \");\n    i0.ɵɵelementEnd()();\n  }\n}\nexport let CarritoComponent = /*#__PURE__*/(() => {\n  class CarritoComponent {\n    carritoService;\n    router;\n    facturaSrv;\n    http;\n    productosEnCarrito = [];\n    compraRealizada = false;\n    // cotización del USD (venta) — se usa para totalUSD\n    cotizacionUSD = null;\n    cargandoCotizacion = false;\n    constructor(carritoService, router, facturaSrv, http) {\n      this.carritoService = carritoService;\n      this.router = router;\n      this.facturaSrv = facturaSrv;\n      this.http = http;\n    }\n    ngOnInit() {\n      this.productosEnCarrito = this.carritoService.obtenerProductos();\n      this.obtenerCotizacionUSD();\n    }\n    // -------- helpers de UI --------\n    obtenerTotal() {\n      return this.productosEnCarrito.reduce((acc, prod) => acc + prod.precio * prod.cantidad, 0);\n    }\n    aumentarCantidad(producto) {\n      this.carritoService.modificarCantidad(producto.id, 1);\n      this.productosEnCarrito = this.carritoService.obtenerProductos();\n    }\n    disminuirCantidad(producto) {\n      this.carritoService.modificarCantidad(producto.id, -1);\n      this.productosEnCarrito = this.carritoService.obtenerProductos();\n    }\n    irAProductos() {\n      this.router.navigate(['/productos']);\n    }\n    irAFacturas() {\n      this.router.navigate(['/facturas']);\n    }\n    irAFinalizarCompra() {\n      this.router.navigate(['/finalizar-compra']);\n    }\n    // -------- cotización del dólar --------\n    obtenerCotizacionUSD() {\n      var _this = this;\n      return _asyncToGenerator(function* () {\n        try {\n          _this.cargandoCotizacion = true;\n          // Oficial venta (DolarApi)\n          const res = yield _this.http.get('https://dolarapi.com/v1/dolares/oficial').toPromise();\n          _this.cotizacionUSD = Number(res?.venta) || null;\n        } catch (err) {\n          console.error('Error al obtener cotización DolarApi:', err);\n          _this.cotizacionUSD = null; // seguimos sin frenar la compra\n        } finally {\n          _this.cargandoCotizacion = false;\n        }\n      })();\n    }\n    // -------- finalizar compra (guarda en RTDB) --------\n    finalizarCompra() {\n      var _this2 = this;\n      return _asyncToGenerator(function* () {\n        const productos = _this2.carritoService.obtenerProductos();\n        if (productos.length === 0) {\n          alert('El carrito está vacío.');\n          return;\n        }\n        const totalARS = productos.reduce((acc, item) => acc + item.precio * item.cantidad, 0);\n        // armamos los items como espera RTDB (con nombre!)\n        const items = productos.map(p => ({\n          producto_id: p.id,\n          producto_nombre: p.nombre,\n          cantidad: p.cantidad,\n          precio_unitario: p.precio,\n          subtotal_ars: p.cantidad * p.precio\n        }));\n        // totalUSD si tenemos tipo_cambio válido\n        const tipo_cambio = _this2.cotizacionUSD ?? null;\n        const totalUSD = tipo_cambio && tipo_cambio > 0 ? Number((totalARS / tipo_cambio).toFixed(2)) : null;\n        try {\n          // ✅ Llamamos al método nuevo del servicio\n          yield _this2.facturaSrv.crearFactura({\n            items,\n            totalARS,\n            totalUSD,\n            tipo_cambio\n          });\n          // limpiar carrito y mostrar mensaje\n          _this2.carritoService.vaciarCarrito();\n          _this2.productosEnCarrito = [];\n          _this2.compraRealizada = true;\n          setTimeout(() => _this2.compraRealizada = false, 3000);\n        } catch (err) {\n          console.error('Error al generar la factura en RTDB', err);\n          alert('Ocurrió un error al guardar la factura.');\n        }\n      })();\n    }\n    static ɵfac = function CarritoComponent_Factory(__ngFactoryType__) {\n      return new (__ngFactoryType__ || CarritoComponent)(i0.ɵɵdirectiveInject(i1.CarritoService), i0.ɵɵdirectiveInject(i2.Router), i0.ɵɵdirectiveInject(i3.FacturaService), i0.ɵɵdirectiveInject(i4.HttpClient));\n    };\n    static ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n      type: CarritoComponent,\n      selectors: [[\"app-carrito\"]],\n      decls: 5,\n      vars: 2,\n      consts: [[1, \"contenedor-carrito\"], [4, \"ngIf\"], [\"class\", \"acciones-post-compra\", 4, \"ngIf\"], [\"class\", \"item-carrito\", 4, \"ngFor\", \"ngForOf\"], [1, \"total\"], [1, \"btn-finalizar\", 3, \"click\"], [1, \"item-carrito\"], [1, \"imagen-carrito\", 3, \"src\", \"alt\"], [1, \"info-carrito\"], [1, \"cantidad-control\"], [3, \"click\"], [1, \"acciones-post-compra\"], [1, \"btn-volver\", 3, \"click\"], [1, \"btn-facturas\", 3, \"click\"]],\n      template: function CarritoComponent_Template(rf, ctx) {\n        if (rf & 1) {\n          i0.ɵɵelementStart(0, \"div\", 0)(1, \"h2\");\n          i0.ɵɵtext(2, \"Carrito de Compras\");\n          i0.ɵɵelementEnd();\n          i0.ɵɵtemplate(3, CarritoComponent_div_3_Template, 3, 2, \"div\", 1)(4, CarritoComponent_div_4_Template, 5, 0, \"div\", 2);\n          i0.ɵɵelementEnd();\n        }\n        if (rf & 2) {\n          i0.ɵɵadvance(3);\n          i0.ɵɵproperty(\"ngIf\", !ctx.compraRealizada);\n          i0.ɵɵadvance();\n          i0.ɵɵproperty(\"ngIf\", ctx.compraRealizada);\n        }\n      },\n      dependencies: [CommonModule, i5.NgForOf, i5.NgIf, i5.DecimalPipe, HttpClientModule],\n      styles: [\".contenedor-carrito[_ngcontent-%COMP%]{max-width:800px;margin:0 auto;padding:16px;background:#f8f9fa;border-radius:10px}.item-carrito[_ngcontent-%COMP%]{display:flex;align-items:center;margin-bottom:16px;background:#fff;border:1px solid #ddd;border-radius:8px;padding:12px}.imagen-carrito[_ngcontent-%COMP%]{width:80px;height:80px;object-fit:contain;margin-right:16px}.info-carrito[_ngcontent-%COMP%]{flex-grow:1}.cantidad-control[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;margin-top:8px}.cantidad-control[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{background-color:#007bff;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer}.cantidad-control[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{background-color:#0056b3}.eliminar[_ngcontent-%COMP%]{background-color:#dc3545;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;margin-top:8px}.eliminar[_ngcontent-%COMP%]:hover{background-color:#b02a37}.total[_ngcontent-%COMP%]{font-size:1.2rem;text-align:right;margin-top:16px}.cantidad-control[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{margin:0 5px;padding:3px 8px;background-color:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer}.cantidad-control[_ngcontent-%COMP%]{margin:5px 0;display:flex;align-items:center;gap:10px}.mensaje-confirmado[_ngcontent-%COMP%]{margin-top:1.5rem;padding:1rem;background-color:#d4edda;color:#155724;border:1px solid #c3e6cb;border-radius:5px;font-size:1rem}.acciones-post-compra[_ngcontent-%COMP%]{margin-top:1rem}.acciones-post-compra[_ngcontent-%COMP%]{margin-top:1.5rem;display:flex;gap:1rem}.acciones-post-compra[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]{padding:10px 16px;border-radius:6px;text-decoration:none;color:#fff;font-weight:700;transition:background-color .2s ease}.btn-volver[_ngcontent-%COMP%]{background-color:#007bff}.btn-facturas[_ngcontent-%COMP%]{background-color:#17a2b8}.btn-facturas[_ngcontent-%COMP%]:hover{background-color:#117a8b}.toast-exito[_ngcontent-%COMP%]{position:fixed;bottom:20px;right:20px;background-color:#28a745;color:#fff;padding:12px 20px;border-radius:8px;box-shadow:0 0 10px #0003;animation:_ngcontent-%COMP%_fadeInOut 3s ease-in-out forwards;z-index:1000}@keyframes _ngcontent-%COMP%_fadeInOut{0%{opacity:0;transform:translateY(20px)}10%{opacity:1;transform:translateY(0)}90%{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(20px)}}.acciones-post-compra[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1rem;margin-top:2rem;align-items:center}.btn-volver[_ngcontent-%COMP%], .btn-facturas[_ngcontent-%COMP%]{padding:12px 24px;border:none;border-radius:8px;font-size:1rem;font-weight:700;cursor:pointer;transition:background-color .2s ease;width:80%;max-width:300px;text-align:center}.btn-volver[_ngcontent-%COMP%]{background-color:#007bff;color:#fff}.btn-volver[_ngcontent-%COMP%]:hover{background-color:#0056b3}.btn-facturas[_ngcontent-%COMP%]{background-color:#28a745;color:#fff}.btn-facturas[_ngcontent-%COMP%]:hover{background-color:#1e7e34}.btn-finalizar[_ngcontent-%COMP%]{display:inline-block;background-color:#28a745;color:#fff;font-size:1rem;font-weight:500;padding:10px 20px;border:none;border-radius:6px;cursor:pointer;text-decoration:none;transition:background-color .2s ease,transform .1s ease}.btn-finalizar[_ngcontent-%COMP%]:hover{background-color:#218838}.btn-finalizar[_ngcontent-%COMP%]:active{transform:scale(.97)}\"]\n    });\n  }\n  return CarritoComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}